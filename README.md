# 🚀 완전 자동화 네이버웍스 알리미

네이버 검색 기반 자산 시세/뉴스 모니터링 및 네이버웍스 Flex Message 알림 시스템

## ✨ 주요 기능

### 📊 자산 가격 모니터링
- **완전 자동화**: 자산 추가 시 자동 검색 및 알림
- **다중 자산 지원**: 암호화폐(crypto) + 주식(stock) 동시 모니터링
- **스마트 가격 파싱**: 자산 타입과 거래 시간에 따른 자동 선택자 적용
- **시간대별 주식 가격**: 정규장(KRX) vs NXT 시간대 구분
- **실시간 급등락 감지**: 직전 가격 대비 변동률 분석
- **추세 이탈 분석**: 이동평균 기반 추세 분석 (쿨다운 30분)

### 📰 뉴스 모니터링
- **자산별 순환 검색**: 1분에 하나씩 자산별로 순차 검색
- **다중 선택자 지원**: 2025년 네이버 뉴스 구조 대응
- **스마트 필터링**: 최근 24시간 이내 + 중복 제거
- **키워드 매칭**: 제목에 자산명 포함 여부 검증

### 🎨 Flex Message 지원
- **급등 알림**: 🔴 빨간색 헤더 (상승)
- **급락 알림**: 🔵 파란색 헤더 (하락)  
- **뉴스 알림**: 🟣 보라색 헤더
- **정기 리포트**: 🔵 파란색 헤더

### ⚙️ 스마트 자동화
- **동적 상태 관리**: 새 자산 추가 시 자동 초기화
- **스마트 정기 리포트**: 페이코인 급등락 기준 변동 시만 발송
- **쿨다운 시스템**: 추세이탈 알림 30분 재알림 방지
- **히스토리 관리**: 뉴스 중복 검사 (최대 100개)

## 🛠️ 설치 및 실행

### 1. 의존성 설치
```bash
npm install
```

### 2. 환경 설정

#### 방법 1: config.json 파일 사용 (권장)
```json
{
  "webhookUrl": "https://naverworks.danal.co.kr/message/direct/service/channels/your_channel",
  "testMode": true,
  "description": "네이버웍스 알림 설정 파일"
}
```

#### 방법 2: app.js 파일에서 직접 설정
```javascript
const NAVER_WORKS_HOOK_URL = 'https://naverworks.danal.co.kr/message/direct/service/channels/danal_test';
```

### 3. 실행
```bash
# 일반 실행
npm start

# 개발 모드 (자동 재시작)
npm run dev

# 인터랙티브 모드 (명령어 입력 가능)
node app.js --interactive
```

## 📋 자산 설정

### 자산 추가 방법
`ASSETS_TO_WATCH` 배열에 새 자산 추가:

```javascript
{
    name: '자산명',                    // 표시될 이름
    query: '자산명 시세',              // 네이버 검색 쿼리
    type: 'crypto' 또는 'stock',       // 자산 타입
    spikeThreshold: 2.0,             // 급등락 임계값 (%)
    trendThreshold: 1.5,             // 추세이탈 임계값 (%)
    enabled: true,                   // 가격 모니터링 활성화
    newsEnabled: true                // 뉴스 검색 활성화
}
```

### 현재 설정된 자산
- **페이코인** (crypto): 급등락 ±0.9%, 추세이탈 ±1.0%
- **다날** (stock): 급등락 ±0.5%, 추세이탈 ±1.0%
- **비트코인** (crypto): 급등락 ±3.0%, 추세이탈 ±2.0%
- **이더리움** (crypto): 급등락 ±3.0%, 추세이탈 ±2.0%
- **리플** (crypto): 급등락 ±3.0%, 추세이탈 ±2.0%

## 🎮 관리 명령어

### 가격 모니터링 제어
```bash
status              # 전체 자산 상태 확인
enable [자산명]      # 가격 모니터링 활성화
disable [자산명]     # 가격 모니터링 비활성화
toggle [자산명]      # 가격 모니터링 상태 전환
```

### 뉴스 검색 제어
```bash
news-enable [자산명]   # 뉴스 검색 활성화
news-disable [자산명]  # 뉴스 검색 비활성화
news-toggle [자산명]   # 뉴스 검색 상태 전환
```

### 기타 명령어
```bash
help               # 전체 도움말
add                # 새 자산 추가 방법 안내
```

## 📊 모니터링 설정

### 실행 주기
- **메인 모니터링**: 1분마다 (`* * * * *`)
- **정기 리포트**: 60분마다 (변동 감지 시만)
- **뉴스 검색**: 자산별 순환 (1분에 하나씩)

### 분석 기준
- **이동평균**: 60분 기준
- **뉴스 필터링**: 최근 24시간 이내
- **뉴스 히스토리**: 최대 100개 저장
- **추세이탈 쿨다운**: 30분

### 시간대별 주식 가격
- **정규장 시간** (09:00-15:30): KRX 가격 우선
- **NXT 시간** (08:00-20:00, 정규장 외): NXT 가격 우선
- **거래 시간 외**: 정규장 가격 사용

## 📁 파일 구조

```
danal_news/
├── app.js                      # 메인 애플리케이션
├── test-news.js               # 뉴스 검색 테스트 스크립트
├── package.json               # 의존성 정보
├── package-lock.json          # 의존성 잠금 파일
├── config.json                # 웹훅 설정 파일 (선택사항)
├── .gitignore                 # Git 무시 파일
├── monitoring_state_final.json # 상태 저장 파일 (자동 생성)
└── README.md                  # 이 파일
```

## 🔧 기술 스택

- **Node.js** (>=16)
- **cheerio**: HTML 파싱
- **node-cron**: 스케줄링
- **node-fetch**: HTTP 요청
- **curl**: 안정적인 웹 요청

## 🎯 알림 유형

### 급등락 알림
- 직전 가격 대비 설정 임계값 초과 시
- 단계별 이모지: 🔴(대폭등) → 🟥(폭등) → 📈(급등) → 🔺(상승)
- 하락: 🔵(대폭락) → 🟦(폭락) → 📉(급락) → 🔻(하락)

### 추세이탈 알림
- 이동평균 대비 설정 임계값 초과 시
- 30분 쿨다운으로 재알림 방지

### 뉴스 알림
- 자산별 키워드 매칭된 새 뉴스 발견 시
- 중복 제거 및 시간 필터링 적용

### 정기 리포트
- 페이코인 급등락 기준으로 변동 감지 시만 발송
- 시가 대비 + 직전 리포트 대비 변동률 표시

## ⚠️ 주의사항

1. **네이버웍스 웹훅 URL** 설정 필수
2. **Node.js 16 이상** 필요
3. **curl 명령어** 시스템에 설치되어 있어야 함
4. **방화벽** 설정에서 아웃바운드 HTTPS 허용 필요

## 🚀 특징

- **완전 자동화**: 자산 추가만으로 모든 기능 작동
- **고급 파싱**: 2025년 네이버 구조 대응
- **스마트 알림**: 불필요한 알림 최소화
- **확장 가능**: 새 자산 타입 쉽게 추가 가능
- **안정성**: 에러 핸들링 및 중복 실행 방지

## 🧪 테스트

### 뉴스 검색 테스트
```bash
node test-news.js
```
- 개별 자산별 뉴스 검색 기능 테스트
- 네이버 뉴스 파싱 로직 검증
- 웹훅 전송 테스트

### 테스트 설정
`config.json`에서 테스트 모드 설정:
```json
{
  "testMode": true,
  "webhookUrl": "https://naverworks.danal.co.kr/message/direct/service/channels/test_channel"
}
```

## 🔧 고급 기능

### 2025년 네이버 뉴스 구조 대응
- **다중 선택자**: 기존 및 신규 네이버 뉴스 레이아웃 모두 지원
- **SDS 컴포넌트**: 네이버의 새로운 디자인 시스템 파싱
- **언론사 추출**: 10가지 이상의 선택자로 안정적인 언론사명 추출
- **자동 폴백**: 파싱 실패 시 다음 선택자로 자동 전환

### 스마트 알림 최적화
- **변동률 기반**: 페이코인 급등락 기준으로 정기 리포트 필터링
- **쿨다운 시스템**: 30분 재알림 방지로 스팸 방지
- **시간대별 주식**: KRX vs NXT 시간에 따른 적절한 가격 소스 선택
- **중복 제거**: URL 기반 뉴스 중복 검사

## 📞 지원

문제가 발생하거나 새로운 기능이 필요한 경우, 코드 내 주석을 참고하거나 `help` 명령어를 사용하세요.

claude-monitor --timezone Asia/Tokyo --plan max5