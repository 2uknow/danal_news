const util = require('util');
const exec = util.promisify(require('child_process').exec);
const fs = require('fs');
const cheerio = require('cheerio');
const fetch = require('node-fetch');
const https = require('https');
const cron = require('node-cron');

// ğŸª™ í˜ì´ì½”ì¸ ê¸°ìˆ ë¶„ì„ ì‹œìŠ¤í…œ ì¶”ê°€
const { integratePaycoinMonitoring } = require('./paycoin-flex-integration');

// ğŸ¢ ë‹¤ë‚  ì£¼ì‹ ê¸°ìˆ ë¶„ì„ ì‹œìŠ¤í…œ ì¶”ê°€
const { integrateDanalMonitoring, getDanalPriceForApp, checkDanalHealthForApp, startDanalTechnicalMonitoring } = require('./danal-integration');

// ë¡œê¹… ì‹œìŠ¤í…œ ì¶”ê°€
const { logger, logHelper } = require('./logger');

// --- 1. ì„¤ì • (Configuration) ---
let NAVER_WORKS_HOOK_URL = 'https://naverworks.danal.co.kr/message/direct/service/channels/danal_test'; // ê¸°ë³¸ê°’

// config.jsonì—ì„œ webhook URL ë¡œë“œ ì‹œë„
try {
    const config = require('./config.json');
    if (config.webhookUrl) {
        NAVER_WORKS_HOOK_URL = config.webhookUrl;
        console.log('âœ… config.jsonì—ì„œ webhook URL ë¡œë“œë¨');
    }
} catch (error) {
    console.log('âš ï¸ config.json ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ URL ì‚¬ìš©');
}

const NEWS_QUERY = 'ë‹¤ë‚ ';

// ğŸš€ ì™„ì „ ìë™í™”! ì—¬ê¸°ì— ìì‚° ì¶”ê°€í•˜ë©´ ìë™ìœ¼ë¡œ ëª¨ë“  ê¸°ëŠ¥ ì‘ë™!
const ASSETS_TO_WATCH = [
    { 
        name: 'í˜ì´ì½”ì¸',   
        query: 'í˜ì´ì½”ì¸ ì‹œì„¸',   
        type: 'crypto', 
        spikeThreshold: 0.9,      // ê¸‰ë“±ë½ ì„ê³„ê°’
        trendThreshold: 1.8,      // ì¶”ì„¸ ì´íƒˆ ì„ê³„ê°’
        enabled: true,            // ê°€ê²© ëª¨ë‹ˆí„°ë§ í™œì„±í™”/ë¹„í™œì„±í™”
        newsEnabled: true         // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”/ë¹„í™œì„±í™”
    },
    { 
        name: 'ë‹¤ë‚ ',       
        query: 'ë‹¤ë‚  ì£¼ê°€',       
        type: 'stock',  
        spikeThreshold: 0.5,      
        trendThreshold: 1.0,      
        enabled: true,
        newsEnabled: true         // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”/ë¹„í™œì„±í™”
    },
    { 
        name: 'ì¹´ì¹´ì˜¤í˜ì´', 
        query: 'ì¹´ì¹´ì˜¤í˜ì´ ì£¼ê°€', 
        type: 'stock',  
        spikeThreshold: 3.0,      
        trendThreshold: 2.5,      
        enabled: false,
        newsEnabled: false        // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ ë¹„í™œì„±í™”
    },
    { 
        name: 'ì¹´ì´ì•„',     
        query: 'ì¹´ì´ì•„ ì‹œì„¸',     
        type: 'crypto', 
        spikeThreshold: 3.0,      
        trendThreshold: 2.0,      
        enabled: false,
        newsEnabled: false        // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ ë¹„í™œì„±í™”
    },{ 
        name: 'ë¹„íŠ¸ì½”ì¸',   
        query: 'ë¹„íŠ¸ì½”ì¸ ì‹œì„¸',   
        type: 'crypto', 
        spikeThreshold: 3.0,      
        trendThreshold: 2.0,      
        enabled: true,
        newsEnabled: flase         // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”/ë¹„í™œì„±í™”
    },
     { 
        name: 'ì´ë”ë¦¬ì›€',   
        query: 'ì´ë”ë¦¬ì›€ ì‹œì„¸',   
        type: 'crypto', 
        spikeThreshold: 3.0,      
        trendThreshold: 2.0,      
        enabled: true,
        newsEnabled: false        // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ ë¹„í™œì„±í™” (ê°€ê²©ë§Œ ëª¨ë‹ˆí„°ë§)
    }, { 
        name: 'ë¦¬í”Œ',   
        query: 'ë¦¬í”Œ ì‹œì„¸',   
        type: 'crypto', 
        spikeThreshold: 3.0,      
        trendThreshold: 2.0,      
        enabled: true,
        newsEnabled: false         // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”/ë¹„í™œì„±í™”
    }
];

const MA_PERIOD = 60;  // ë‹¤ì‹œ 60ë¶„ìœ¼ë¡œ ë³µì› (ì›ë˜ëŒ€ë¡œ) 
const PERIODIC_REPORT_INTERVAL = 60;
const STATE_FILE = 'monitoring_state_final.json';
const MAX_NEWS_HISTORY = 1000;
const MAX_NEWS_AGE_HOURS = 24; // 6ì‹œê°„ì—ì„œ 24ì‹œê°„ìœ¼ë¡œ í™•ëŒ€

// ğŸ• NXT/KRX ìë™ ì „í™˜ ì„¤ì •
const TRADING_SCHEDULE = {
    autoMode: false,           // true: ì‹œê°„ëŒ€ë³„ ìë™ ì „í™˜, false: ìˆ˜ë™ ëª¨ë“œ
    forceMode: 'krx',        // 'auto', 'krx', 'nxt' - ìˆ˜ë™ ëª¨ë“œ ì‹œ ê°•ì œ ì‚¬ìš©í•  ê±°ë˜ì†Œ
    regularHours: {           // ì •ê·œì¥ ì‹œê°„ (KRX)
        start: 900,           // 09:00
        end: 1530            // 15:30
    },
    nxtHours: {              // NXT ì‹œê°„ (ì •ê·œì¥ ì´í›„ë§Œ)
        start: 1600,          // 16:00 (ì •ê·œì¥ ì¢…ë£Œ í›„)  
        end: 2000            // 20:00
    }
};

// ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸
let isRunning = false;

// --- 2. ìë™ í™•ì¥ í—¬í¼ í•¨ìˆ˜ (Auto-Expansion Helper Functions) ---
// HTTP Agent ìµœì í™” (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
const insecureAgent = new https.Agent({ 
    rejectUnauthorized: false, 
    keepAlive: false,
    maxSockets: 5,
    maxFreeSockets: 2,
    timeout: 30000,
    freeSocketTimeout: 15000
});

// ğŸ¯ ì–¸ë¡ ì‚¬ ì¶”ì¶œ í•¨ìˆ˜ - ë‹¤ì–‘í•œ ì„ íƒìë¡œ ë²”ìš©ì  ì¶”ì¶œ
function extractPressFromElement($el) {
    const pressSelectors = [
        // íŠ¹í™” ì„ íƒì (ë„¤ì´ë²„ ë‰´ìŠ¤ ìµœì‹  êµ¬ì¡°)
        '.sds-comps-text:not(.sds-comps-text-type-headline1)',  // SDS í…ìŠ¤íŠ¸ (ì œëª© ì œì™¸)
        'div > span:first-child',          // ì²« ë²ˆì§¸ ìŠ¤íŒ¬ (ì–¸ë¡ ì‚¬ëª… íŒ¨í„´)
        '[class*="info"]:not([href])',    // info í´ë˜ìŠ¤ (ë§í¬ ì•„ë‹Œ ê²ƒ)
        
        // ê¸°ì¡´ ì„ íƒìë“¤ (í˜¸í™˜ì„±)
        '.news_info .press',               // ë‰´ìŠ¤ ì •ë³´ì˜ ì–¸ë¡ ì‚¬
        '.info_group .press',              // ì •ë³´ ê·¸ë£¹ì˜ ì–¸ë¡ ì‚¬
        '.info_group .info:first-child',   // ì •ë³´ ê·¸ë£¹ì˜ ì²« ë²ˆì§¸ (ë³´í†µ ì–¸ë¡ ì‚¬)
        '.press',                          // ì–¸ë¡ ì‚¬
        '.source',                         // ë‰´ìŠ¤ ì†ŒìŠ¤
        '.press_name',                     // ì–¸ë¡ ì‚¬ëª…
        '.cp_name',                        // ê³µê¸‰ì‚¬ ì´ë¦„
        '.news_item .info:first-child',    // ë‰´ìŠ¤ ì•„ì´í…œì˜ ì²« ë²ˆì§¸ ì •ë³´
        'a[class*="info"]:first-child',    // ì •ë³´ ë§í¬ì˜ ì²« ë²ˆì§¸
        'span[class*="press"]',            // ì–¸ë¡ ì‚¬ ìŠ¤íŒ¬
        '.outlet',                         // ì–¸ë¡ ì‚¬ ì•„ì›ƒë ›
        '.source_name'                     // ì†ŒìŠ¤ ì´ë¦„
    ];
    
    // ğŸ¯ ì–¸ë¡ ì‚¬ëª… í›„ë³´ ê²€ì¦ í•¨ìˆ˜
    function isValidPressName(text) {
        if (!text || text.length < 2 || text.length > 30) return false;
        
        // ì‹œê°„ ì •ë³´ ì œì™¸
        if (text.includes('ì „') || text.includes('ì‹œê°„') || text.includes('ë¶„') || text.includes('ì¼')) return false;
        if (text.match(/\d+[ì‹œë¶„ì¼]/)) return false;
        if (text.match(/\d{4}[-./]\d{1,2}[-./]\d{1,2}/)) return false;
        
        // ì¼ë°˜ì ì¸ ì–¸ë¡ ì‚¬ ë‹¨ì–´ í‚¨ì›Œë“œ
        if (text === 'ë‰´ìŠ¤' || text === 'ê¸°ì‚¬' || text === 'ë„¤ì´ë²„ë‰´ìŠ¤') return false;
        
        // ë„ˆë¬´ ë§ì´ ê³¼ë¶„í•œ ë‚´ìš© ì œì™¸ (ì œëª©ì´ë‚˜ ë‚´ìš©ìœ¼ë¡œ ë³´ì´ëŠ” ê²½ìš°)
        if (text.includes('ë¹„íŠ¸ì½”ì¸') || text.includes('í•˜ë½') || text.includes('ë‹¬ëŸ¬')) return false;
        
        // ì–¸ë¡ ì‚¬ íŠ¹ì§• ì—…ê±°ë‚˜ ì§§ê³  ì˜ë¯¸ìˆëŠ” ì´ë¦„ (ì˜ˆ: 'ë‰´ìŠ¤', 'íƒ€ì„ìŠ¤', 'ì¸ë•ì˜', 'ì „ìì‹ ë¬¸' ë“± í¬í•¨)
        const pressKeywords = ['ë‰´ìŠ¤', 'ì¼ë³´', 'ê²½ì œ', 'íƒ€ì„ìŠ¤', 'íˆ¬ë°ì´', 'ì‹ ë¬¸', 'ë¯¸ë””ì–´', 'ì €ë„', 'ë§¤ì¼', 'ì£¼ê°„'];
        const hasPressSuffix = pressKeywords.some(keyword => text.includes(keyword));
        
        // ì§§ì§€ë§Œ ì˜ë¯¸ìˆëŠ” ì–¸ë¡ ì‚¬ëª…ì´ê±°ë‚˜, ì–¸ë¡ ì‚¬ í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°
        return (text.length <= 10 && text.match(/[\uac00-\ud7a3]/)) || hasPressSuffix;
    }
    
    for (const selector of pressSelectors) {
        try {
            const extracted = $el.find(selector).text().trim();
            if (isValidPressName(extracted)) {
                return extracted;
            }
        } catch (e) {
            continue;
        }
    }
    return null;
}

// ğŸ¯ URLì—ì„œ ì–¸ë¡ ì‚¬ ì¶”ì¶œ í•¨ìˆ˜ - ë™ì ìœ¼ë¡œ ë„ë©”ì¸ì—ì„œ ì¶”ì¶œ
function extractPressFromUrl(url) {
    if (!url) return null;
    
    // ì£¼ìš” ì–¸ë¡ ì‚¬ ë„ë©”ì¸ ë§¤í•‘
    const pressMapping = {
        'yna.co.kr': 'ì—°í•©ë‰´ìŠ¤',
        'newsis.com': 'ë‰´ì‹œìŠ¤', 
        'mk.co.kr': 'ë§¤ì¼ê²½ì œ',
        'edaily.co.kr': 'ì´ë°ì¼ë¦¬',
        'news1.kr': 'ë‰´ìŠ¤1',
        'dailian.co.kr': 'ë°ì¼ë¦¬ì•ˆ',
        'topstarnews.net': 'í†±ìŠ¤íƒ€ë‰´ìŠ¤',
        'newspim.com': 'ë‰´ìŠ¤í•Œ',
        'finomy.com': 'íŒŒì´ë‚¸ì…œë‰´ìŠ¤',
        'hankyung.com': 'í•œêµ­ê²½ì œ',
        'etnews.com': 'ì „ìì‹ ë¬¸',
        'mt.co.kr': 'ë¨¸ë‹ˆíˆ¬ë°ì´',
        'inews24.com': 'ì•„ì´ë‰´ìŠ¤24',
        'biz.chosun.com': 'ì¡°ì„ ë¹„ì¦ˆ',
        'sedaily.com': 'ì„œìš¸ê²½ì œ',
        'fnnews.com': 'FNë‰´ìŠ¤',
        'ajunews.com': 'ì•„ì£¼ê²½ì œ',
        'businesspost.co.kr': 'ë¹„ì¦ˆë‹ˆìŠ¤í¬ìŠ¤íŠ¸',
        'asiatoday.co.kr': 'ì•„ì‹œì•„íˆ¬ë°ì´',
        'dt.co.kr': 'ë””ì§€í„¸íƒ€ì„ìŠ¤'
    };
    
    // ë„ë©”ì¸ ë§¤í•‘ì—ì„œ ì°¾ê¸°
    for (const [domain, press] of Object.entries(pressMapping)) {
        if (url.includes(domain)) {
            return press;
        }
    }
    
    // ë„ë©”ì¸ì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
    try {
        const urlObj = new URL(url);
        const domain = urlObj.hostname.replace('www.', '');
        const parts = domain.split('.');
        
        if (parts.length >= 2) {
            // ë„ë©”ì¸ì˜ ì£¼ìš” ë¶€ë¶„ì„ ì–¸ë¡ ì‚¬ëª…ìœ¼ë¡œ ì‚¬ìš© (ê°„ë‹¨í•œ ë§¤í•‘)
            const mainDomain = parts[parts.length - 2];
            const domainToPress = {
                'chosun': 'ì¡°ì„ ì¼ë³´',
                'donga': 'ë™ì•„ì¼ë³´', 
                'joongang': 'ì¤‘ì•™ì¼ë³´',
                'hani': 'í•œê²¨ë ˆ',
                'khan': 'ê²½í–¥ì‹ ë¬¸',
                'segye': 'ì„¸ê³„ì¼ë³´',
                'kmib': 'êµ­ë¯¼ì¼ë³´'
            };
            
            return domainToPress[mainDomain] || null;
        }
    } catch (e) {
        return null;
    }
    
    return null;
}

// ğŸ¯ ì„¤ëª… í…ìŠ¤íŠ¸ í´ë¦¬ë‹ í•¨ìˆ˜ - ì¤‘ë³µëœ ì–¸ë¡ ì‚¬ëª…ê³¼ ì‹œê°„ ì •ë³´ ì œê±°
function cleanDescriptionText(text, pressName, timeText) {
    if (!text) return text;
    
    let cleaned = text;
    
    // ì–¸ë¡ ì‚¬ëª… ì œê±° (ì •í™•í•œ ì¼ì¹˜ì™€ ë¶€ë¶„ ì¼ì¹˜ ëª¨ë‘)
    if (pressName && pressName !== 'ì–¸ë¡ ì‚¬ ë¯¸ìƒ') {
        // ì–¸ë¡ ì‚¬ëª…ì´ ë°˜ë³µë˜ëŠ” íŒ¨í„´ ì œê±°
        const pressPattern = new RegExp(pressName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        cleaned = cleaned.replace(pressPattern, '').trim();
    }
    
    // ì‹œê°„ ì •ë³´ ì œê±° (ì •í™•í•œ ì¼ì¹˜)
    if (timeText && timeText !== 'ì‹œê°„ ë¯¸ìƒ') {
        const timePattern = new RegExp(timeText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        cleaned = cleaned.replace(timePattern, '').trim();
    }
    
    // ì¼ë°˜ì ì¸ ì‹œê°„ íŒ¨í„´ë“¤ ì œê±°
    const timePatterns = [
        /\d+ì‹œê°„\s*ì „/g,
        /\d+ë¶„\s*ì „/g,
        /\d+ì¼\s*ì „/g,
        /\d+ì£¼\s*ì „/g,
        /\d+ê°œì›”\s*ì „/g,
        /\d{4}-\d{2}-\d{2}/g,
        /\d{1,2}ì›”\s*\d{1,2}ì¼/g
    ];
    
    timePatterns.forEach(pattern => {
        cleaned = cleaned.replace(pattern, '').trim();
    });
    
    // ğŸ¯ ë„¤ì´ë²„ ë‰´ìŠ¤ íŠ¹ìˆ˜ íŒ¨í„´ë“¤ ì œê±°
    const naverPatterns = [
        /ë„¤ì´ë²„ë‰´ìŠ¤/g,                    // "ë„¤ì´ë²„ë‰´ìŠ¤" ì œê±°
        /ë„¤ì´ë²„\s*ë‰´ìŠ¤/g,                 // "ë„¤ì´ë²„ ë‰´ìŠ¤" ì œê±°
        /Keepì—\s*ì €ì¥/g,                // "Keepì— ì €ì¥" ì œê±°
        /Keepì—\s*ë°”ë¡œê°€ê¸°/g,            // "Keepì— ë°”ë¡œê°€ê¸°" ì œê±°
        /ë°”ë¡œê°€ê¸°/g,                     // "ë°”ë¡œê°€ê¸°" ì œê±°
        /ì €ì¥/g,                         // "ì €ì¥" ì œê±° (ë‹¨ë…)
        /ì–¸ë¡ ì‚¬\s*ì„ ì •/g,                // "ì–¸ë¡ ì‚¬ ì„ ì •" ì œê±°
        /ì£¼ìš”ê¸°ì‚¬/g,                     // "ì£¼ìš”ê¸°ì‚¬" ì œê±°
        /ì‹¬ì¸µê¸°íš/g,                     // "ì‹¬ì¸µê¸°íš" ì œê±°
        /[A-Z]\d+ë©´\s*\d+ë‹¨/g,           // "A18ë©´ 1ë‹¨" ë“± ì‹ ë¬¸ ë©´ ì •ë³´ ì œê±°
        /\d+ë©´\s*\d+ë‹¨/g,               // "18ë©´ 1ë‹¨" ë“± ì‹ ë¬¸ ë©´ ì •ë³´ ì œê±°
        /[A-Z]\d+ë©´\s*TOP/g,              // "A28ë©´ TOP" ë“± ì‹ ë¬¸ ë©´ ì •ë³´ ì œê±°
        /\d+ë©´\s*TOP/g,                  // "15ë©´ TOP" ë“± ì‹ ë¬¸ ë©´ ì •ë³´ ì œê±°
        /ë©´\s*TOP/g,                     // "ë©´ TOP" ë“± ì‹ ë¬¸ ë©´ ì •ë³´ ì œê±°
    ];
    
    naverPatterns.forEach(pattern => {
        cleaned = cleaned.replace(pattern, '').trim();
    });
    
    // ì—°ì†ëœ ê³µë°± ì •ë¦¬
    cleaned = cleaned.replace(/\s+/g, ' ').trim();
    
    // ì‹œì‘ì´ë‚˜ ëì˜ ë¶ˆí•„ìš”í•œ êµ¬ë‘ì  ì œê±°
    cleaned = cleaned.replace(/^[.,;:\s]+|[.,;:\s]+$/g, '').trim();
    
    // ë„ˆë¬´ ì§§ì€ í…ìŠ¤íŠ¸ëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜ (ì˜ë¯¸ ì—†ëŠ” í…ìŠ¤íŠ¸)
    if (cleaned.length < 10) {
        return '';
    }
    
    return cleaned;
}

// ğŸ¯ ì‹œê°„ ì¶”ì¶œ í•¨ìˆ˜ - ë‹¤ì–‘í•œ í˜•íƒœì˜ ì‹œê°„ ì •ë³´ ì¶”ì¶œ (ë„¤ì´ë²„ ë‰´ìŠ¤ ìµœì í™”)
function extractTimeFromElement($el) {
    const timeSelectors = [
        // ë„¤ì´ë²„ ë‰´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ ì „ìš© ì„ íƒìë“¤
        '.sds-comps-text-type-body2',        // ë³¸ë¬¸ í…ìŠ¤íŠ¸ (ì‹œê°„ í¬í•¨)
        '.info_group .info:last-child',      // ì •ë³´ ê·¸ë£¹ì˜ ë§ˆì§€ë§‰ (ë³´í†µ ì‹œê°„)  
        '.info_group .info:nth-child(2)',    // ì •ë³´ ê·¸ë£¹ì˜ ë‘ ë²ˆì§¸ (ì–¸ë¡ ì‚¬ ë‹¤ìŒì´ ì‹œê°„)
        '.news_info .info:last-child',       // ë‰´ìŠ¤ ì •ë³´ì˜ ë§ˆì§€ë§‰ í•­ëª©
        '.info_group .txt_inline',           // ì •ë³´ ê·¸ë£¹ì˜ í…ìŠ¤íŠ¸
        '.date_time',                        // ë‚ ì§œ ì‹œê°„
        '.time',                             // ì‹œê°„
        '.news_date',                        // ë‰´ìŠ¤ ë‚ ì§œ
        'span[class*="time"]',               // ì‹œê°„ ê´€ë ¨ ìŠ¤íŒ¬
        'span[class*="date"]',               // ë‚ ì§œ ê´€ë ¨ ìŠ¤íŒ¬
        '.news_item .info:last-child',       // ë‰´ìŠ¤ ì•„ì´í…œì˜ ë§ˆì§€ë§‰ ì •ë³´
        '.publish_date',                     // ë°œí–‰ ë‚ ì§œ
        '.article_date',                     // ê¸°ì‚¬ ë‚ ì§œ
        // ì¶”ê°€ ë„¤ì´ë²„ ì„ íƒìë“¤
        '.press_date',                       // ì–¸ë¡ ì‚¬ ë‚ ì§œ
        '.txt_inline',                       // ì¸ë¼ì¸ í…ìŠ¤íŠ¸
        '.sub_txt',                          // ì„œë¸Œ í…ìŠ¤íŠ¸
        '.desc_txt'                          // ì„¤ëª… í…ìŠ¤íŠ¸
    ];
    
    // 1. íŠ¹ì • ì„ íƒìì—ì„œ ì‹œê°„ ì¶”ì¶œ
    for (const selector of timeSelectors) {
        try {
            const extracted = $el.find(selector).text().trim();
            if (extracted && isValidTimeText(extracted)) {
                // ì‹œê°„ ì •ë³´ë§Œ ì¶”ì¶œ (ì„¤ëª… í…ìŠ¤íŠ¸ì—ì„œ ì‹œê°„ íŒ¨í„´ ì°¾ê¸°)
                const timeFromText = extractTimeFromText(extracted);
                if (timeFromText) {
                    return timeFromText;
                }
            }
        } catch (e) {
            continue;
        }
    }
    
    // 2. ì œí•œëœ ë²”ìœ„ì—ì„œ ì‹œê°„ íŒ¨í„´ ì°¾ê¸° (ì „ì²´ í…ìŠ¤íŠ¸ ëŒ€ì‹  ì²˜ìŒ 300ìë§Œ)
    try {
        const allText = $el.text();
        const limitedText = allText.substring(0, 300); // ì²˜ìŒ 300ìë§Œ ê²€ìƒ‰í•˜ì—¬ ë‹¤ë¥¸ ë‰´ìŠ¤ ì‹œê°„ê³¼ í˜¼ë™ ë°©ì§€
        console.log(`   ğŸ” ì œí•œëœ í…ìŠ¤íŠ¸ì—ì„œ ì‹œê°„ ê²€ìƒ‰: "${limitedText.substring(0, 100)}..."`);
        return extractTimeFromText(limitedText);
    } catch (e) {
        // ë¬´ì‹œ
    }
    
    return null;
}

// ğŸ¯ í…ìŠ¤íŠ¸ì—ì„œ ì‹œê°„ ì •ë³´ ì¶”ì¶œí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function extractTimeFromText(text) {
    if (!text) return null;
    
    const timePatterns = [
        // ğŸ”¥ ìˆ˜ì •: ë” êµ¬ì²´ì ì´ê³  ìµœì‹  ì‹œê°„ë¶€í„° ìš°ì„  ê²€ì‚¬ (ë¶„ -> ì‹œê°„ -> ì¼ -> ì£¼ -> ê°œì›” ìˆœì„œ)
        /(\d+)ë¶„\s*ì „/g,                        // "30ë¶„ ì „" (ê°€ì¥ ìµœê·¼)
        /(\d+)ì‹œê°„\s*ì „/g,                      // "5ì‹œê°„ ì „"
        /(\d+)ì¼\s*ì „/g,                        // "1ì¼ ì „"
        /(\d+)ì£¼\s*ì „/g,                        // "1ì£¼ ì „", "2ì£¼ ì „" 
        /(\d+)ê°œì›”\s*ì „/g,                      // "2ê°œì›” ì „" (ê°€ì¥ ì˜¤ë˜ì „)
        
        // ë‰´ìŠ¤ ê¸°ì‚¬ íŠ¹í™” íŒ¨í„´ë“¤
        /(\d{1,2})ì›”\s*(\d{1,2})ì¼\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2})ì‹œ\s*(\d{1,2})ë¶„/g, // "8ì›” 19ì¼ ì˜¤ì „ 10ì‹œ 57ë¶„"
        /(\d{1,2})ì›”\s*(\d{1,2})ì¼\s*(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2})[:ï¼š]\s*(\d{2})/g,   // "8ì›” 19ì¼ ì˜¤ì „ 10:57"
        /(\d{4})[-./ë…„]\s*(\d{1,2})[-./ì›”]\s*(\d{1,2})/g,                      // "2025ë…„ 8ì›” 19ì¼"
        
        // ê¸°ë³¸ ì‹œê°„ í˜•íƒœ
        /(ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}[:ï¼š]\d{2}/g,      // "ì˜¤ì „ 10:30"
        /\d{1,2}[:ï¼š]\d{2}/g,                   // "14:30"
        /\d{1,2}ì›”\s*\d{1,2}ì¼/g,               // "1ì›” 15ì¼"
        /(ì˜¤ëŠ˜|ì–´ì œ|ê·¸ì œ)\s*\d{1,2}[:ï¼š]\d{2}/g, // "ì˜¤ëŠ˜ 14:30"
        /\d{4}[-./]\d{1,2}[-./]\d{1,2}/g       // "2024-01-01"
    ];
    
    // ğŸ”¥ ê°œì„ ëœ ë°©ë²•: ëª¨ë“  íŒ¨í„´ì„ ì°¾ì•„ì„œ ê°€ì¥ ìµœê·¼ ì‹œê°„ì„ ì„ íƒ
    let bestMatch = null;
    let bestScore = Infinity; // ë‚®ì„ìˆ˜ë¡ ë” ìµœê·¼
    
    for (const pattern of timePatterns) {
        const matches = text.match(pattern);
        if (matches && matches.length > 0) {
            const timeText = matches[0].trim();
            const score = getTimeScore(timeText); // ì‹œê°„ì„ ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜í•´ì„œ ì ìˆ˜ ê³„ì‚°
            
            if (score < bestScore) {
                bestMatch = timeText;
                bestScore = score;
            }
        }
    }
    
    return bestMatch;
}

// ğŸ¯ ì‹œê°„ í…ìŠ¤íŠ¸ë¥¼ ì ìˆ˜ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ë” ìµœê·¼)
function getTimeScore(timeText) {
    if (!timeText) return Infinity;
    
    // ë¶„ ì „
    let match = timeText.match(/(\d+)ë¶„\s*ì „/);
    if (match) {
        return parseInt(match[1]); // ë¶„ ê·¸ëŒ€ë¡œ ë°˜í™˜ (5ë¶„ ì „ = 5ì )
    }
    
    // ì‹œê°„ ì „
    match = timeText.match(/(\d+)ì‹œê°„\s*ì „/);
    if (match) {
        return parseInt(match[1]) * 60; // ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜ (5ì‹œê°„ ì „ = 300ì )
    }
    
    // ì¼ ì „
    match = timeText.match(/(\d+)ì¼\s*ì „/);
    if (match) {
        return parseInt(match[1]) * 24 * 60; // ì¼ì„ ë¶„ìœ¼ë¡œ ë³€í™˜ (3ì¼ ì „ = 4320ì )
    }
    
    // ì£¼ ì „
    match = timeText.match(/(\d+)ì£¼\s*ì „/);
    if (match) {
        return parseInt(match[1]) * 7 * 24 * 60; // ì£¼ë¥¼ ë¶„ìœ¼ë¡œ ë³€í™˜
    }
    
    // ê°œì›” ì „
    match = timeText.match(/(\d+)ê°œì›”\s*ì „/);
    if (match) {
        return parseInt(match[1]) * 30 * 24 * 60; // ê°œì›”ì„ ë¶„ìœ¼ë¡œ ë³€í™˜ (ëŒ€ëµ 30ì¼ë¡œ ê³„ì‚°)
    }
    
    // ê¸°íƒ€ íŒ¨í„´ë“¤ì€ ë³´í†µ ìµœê·¼ ì‹œê°„ì´ë¯€ë¡œ ì¤‘ê°„ ì ìˆ˜ ë¶€ì—¬
    return 1440; // 1ì¼ ì •ë„ì˜ ì ìˆ˜ (24ì‹œê°„ * 60ë¶„)
}

// ğŸ¯ ìœ íš¨í•œ ì‹œê°„ í…ìŠ¤íŠ¸ì¸ì§€ íŒë‹¨í•˜ëŠ” í•¨ìˆ˜
function isValidTimeText(text) {
    if (!text || text.length > 30) return false;
    
    // ì‹œê°„ ê´€ë ¨ í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€
    const timeKeywords = ['ì „', 'ì‹œê°„', 'ë¶„', 'ì¼', 'ì˜¤ëŠ˜', 'ì–´ì œ', 'ì›”', 'ì¼'];
    const hasTimeKeyword = timeKeywords.some(keyword => text.includes(keyword));
    
    // ë‚ ì§œ/ì‹œê°„ íŒ¨í„´ ë§¤ì¹˜ ì—¬ë¶€
    const timePatterns = [
        /\d+[ê°œì›”ì£¼ì¼ë¶„ì‹œ]\s*ì „/,             // "2ê°œì›” ì „", "1ì£¼ ì „", "5ë¶„ ì „", "2ì‹œê°„ ì „"
        /\d{4}[-./]\d{1,2}[-./]\d{1,2}/,      // "2024-01-01"
        /\d{1,2}[:ï¼]\d{2}/,                  // "14:30"
        /\d{1,2}ì›”\s*\d{1,2}ì¼/               // "1ì›” 15ì¼"
    ];
    const hasTimePattern = timePatterns.some(pattern => pattern.test(text));
    
    return hasTimeKeyword || hasTimePattern;
}

// ğŸ¯ ë‰´ìŠ¤ ê²€ìƒ‰ìš© í™œì„±í™”ëœ ìì‚°ë§Œ í•„í„°ë§í•˜ëŠ” í•¨ìˆ˜
function getNewsEnabledAssets() {
    const newsEnabledAssets = ASSETS_TO_WATCH.filter(asset => asset.newsEnabled);
    console.log(`ğŸ“° ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”ëœ ìì‚°: ${newsEnabledAssets.length}/${ASSETS_TO_WATCH.length}ê°œ`);
    newsEnabledAssets.forEach(asset => {
        console.log(`   ğŸ“° ${asset.name} (${asset.type}) - ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”`);
    });
    
    const newsDisabledAssets = ASSETS_TO_WATCH.filter(asset => !asset.newsEnabled);
    if (newsDisabledAssets.length > 0) {
        console.log(`ğŸ“° ë‰´ìŠ¤ ê²€ìƒ‰ ë¹„í™œì„±í™”ëœ ìì‚°: ${newsDisabledAssets.length}ê°œ`);
        newsDisabledAssets.forEach(asset => {
            console.log(`   âŒ ${asset.name} (${asset.type}) - ë‰´ìŠ¤ ê²€ìƒ‰ ì•ˆí•¨`);
        });
    }
    
    return newsEnabledAssets;
}


// ì£¼ë§/ê³µíœ´ì¼ ì²´í¬ í•¨ìˆ˜ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
function isKoreanBusinessDay() {
    const now = new Date();
    const kstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
    const dayOfWeek = kstNow.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼
    
    // ì£¼ë§ ì²´í¬ (í† ìš”ì¼, ì¼ìš”ì¼)
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        console.log(`-> ğŸ“… ì£¼ë§ì…ë‹ˆë‹¤ (${dayOfWeek === 0 ? 'ì¼ìš”ì¼' : 'í† ìš”ì¼'}) - ì£¼ì‹ ì•Œë¦¼ ì œì™¸`);
        return false;
    }
    
    // í•œêµ­ ê³µíœ´ì¼ ì²´í¬ (ì£¼ìš” ê³µíœ´ì¼ë§Œ í¬í•¨)
    const month = kstNow.getMonth() + 1;
    const date = kstNow.getDate();
    
    // ì‹ ì •
    if (month === 1 && date === 1) return false;
    
    // ì„¤ë‚  ì—°íœ´ (ìŒë ¥ì´ë¼ ì •í™•í•˜ì§€ ì•ŠìŒ - í•„ìš”ì‹œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
    // ì¶”ì„ ì—°íœ´ (ìŒë ¥ì´ë¼ ì •í™•í•˜ì§€ ì•ŠìŒ - í•„ìš”ì‹œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©)
    
    // ì–´ë¦°ì´ë‚ 
    if (month === 5 && date === 5) return false;
    
    // í˜„ì¶©ì¼
    if (month === 6 && date === 6) return false;
    
    // ê´‘ë³µì ˆ
    if (month === 8 && date === 15) return false;
    
    // ê°œì²œì ˆ
    if (month === 10 && date === 3) return false;
    
    // í•œê¸€ë‚ 
    if (month === 10 && date === 9) return false;
    
    // í¬ë¦¬ìŠ¤ë§ˆìŠ¤
    if (month === 12 && date === 25) return false;
    
    console.log(`-> ğŸ“… í‰ì¼ì…ë‹ˆë‹¤ - ì£¼ì‹ ì•Œë¦¼ í—ˆìš©`);
    return true;
}


// ğŸ¯ ìë™ ìƒíƒœ ì´ˆê¸°í™” - ìƒˆë¡œìš´ ìì‚°ì´ ì¶”ê°€ë˜ë©´ ìë™ìœ¼ë¡œ ìƒíƒœ ìƒì„±
function initializeAssetStates(currentState) {
    let newAssetsAdded = 0;
    
    // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ ìƒíƒœ ì´ˆê¸°í™”
    if (!currentState.newsSearchState) {
        currentState.newsSearchState = {
            currentAssetIndex: 0,
            lastSearchTime: 0
        };
        console.log(`ğŸ†• ë‰´ìŠ¤ ê²€ìƒ‰ ìƒíƒœ ì´ˆê¸°í™”`);
    }
    
    ASSETS_TO_WATCH.forEach(asset => {
        if (!currentState.assetStates[asset.name]) {
            currentState.assetStates[asset.name] = {
                priceHistory: [],
                lastAlertPrice: 0,
                lastReportPrice: 0,
                wasInDeviation: false,
                lastTrendAlertTime: 0,      // ğŸ”¥ ì¶”ê°€: ë§ˆì§€ë§‰ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ ì‹œê°„
                lastTrendAlertPrice: 0,     // ğŸ”¥ ì¶”ê°€: ë§ˆì§€ë§‰ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ ê°€ê²©
                trendAlertDirection: null,  // ğŸ”¥ ì¶”ê°€: ë§ˆì§€ë§‰ ì¶”ì„¸ì´íƒˆ ë°©í–¥ ('up' ë˜ëŠ” 'down')
                openingPrice: 0,
                openingPriceDate: '',
                // ğŸš€ ìë™ ì¶”ê°€ ì •ë³´
                addedDate: new Date().toISOString(),
                totalAlerts: 0,
                lastUpdate: null
            };
            newAssetsAdded++;
            console.log(`ğŸ†• ìƒˆ ìì‚° ìƒíƒœ ì´ˆê¸°í™”: ${asset.name} (${asset.type})`);
        } else {
            // ê¸°ì¡´ ìì‚°ì— ìƒˆ í•„ë“œ ì¶”ê°€ (í˜¸í™˜ì„±)
            if (!currentState.assetStates[asset.name].hasOwnProperty('lastTrendAlertTime')) {
                currentState.assetStates[asset.name].lastTrendAlertTime = 0;
                currentState.assetStates[asset.name].lastTrendAlertPrice = 0;
                currentState.assetStates[asset.name].trendAlertDirection = null;
                console.log(`ğŸ”„ ${asset.name}ì— ì¶”ì„¸ì´íƒˆ ì¶”ì  í•„ë“œ ì¶”ê°€`);
            }
        }
    });
    
    if (newAssetsAdded > 0) {
        console.log(`âœ… ${newAssetsAdded}ê°œì˜ ìƒˆ ìì‚° ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    
    return currentState;
}

// í™œì„±í™”ëœ ìì‚°ë§Œ í•„í„°ë§í•˜ëŠ” í•¨ìˆ˜ (ê°€ê²© ëª¨ë‹ˆí„°ë§ìš©)
function getEnabledAssets() {
    const enabledAssets = ASSETS_TO_WATCH.filter(asset => asset.enabled);
    console.log(`ğŸ“Š ê°€ê²© ëª¨ë‹ˆí„°ë§ í™œì„±í™”ëœ ìì‚°: ${enabledAssets.length}/${ASSETS_TO_WATCH.length}ê°œ`);
    enabledAssets.forEach(asset => {
        console.log(`   âœ… ${asset.name} (${asset.type}) - ê¸‰ë“±ë½:Â±${asset.spikeThreshold}%, ì¶”ì„¸ì´íƒˆ:Â±${asset.trendThreshold}%`);
    });
    
    const disabledAssets = ASSETS_TO_WATCH.filter(asset => !asset.enabled);
    if (disabledAssets.length > 0) {
        console.log(`ğŸ“Š ê°€ê²© ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”ëœ ìì‚°: ${disabledAssets.length}ê°œ`);
        disabledAssets.forEach(asset => {
            console.log(`   âŒ ${asset.name} (${asset.type}) - ê°€ê²© ëª¨ë‹ˆí„°ë§ ì•ˆí•¨`);
        });
    }
    
    return enabledAssets;
}

// ğŸ¯ ìŠ¤ë§ˆíŠ¸ ê°€ê²© ì„ íƒì - ìì‚° íƒ€ì…ê³¼ ê±°ë˜ ì‹œê°„ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì ì ˆí•œ ì„ íƒì ì‚¬ìš©
function getPriceSelectors(assetType, assetName) {
    const selectors = {
        // ì•”í˜¸í™”íìš© ì„ íƒìë“¤
        crypto: [
            '.coin_rate .price_value',
            '.spt_con strong', 
            '.price_now strong',
            '.coin_price',
            '.price em',
            '.coinone_price',
            '.coin_info .price'
        ],
        // ì£¼ì‹ìš© ì„ íƒìë“¤ (ê±°ë˜ ì‹œê°„ëŒ€ë³„)
        stock: {
            // ì •ê·œì¥ ì‹œê°„ (9:00-15:30) - KRX ì •ê·œì¥ ê°€ê²© ìš°ì„ 
            regular: [
                '.spt_con:has(.store_name:contains("KRX")) strong',    // KRX ê°€ê²©
                '.stock_info:has(.store_name:contains("KRX")) + * strong', // KRX ì˜ì—­ì˜ strong
                '.spt_con strong',              // ì²« ë²ˆì§¸ spt_con (ë³´í†µ KRX)
                '.price em',
                '.stock_price .price',
                '.price_now strong'
            ],
            // NXT ì‹œê°„ (8:00-20:00, ì •ê·œì¥ ì™¸) - NXT ê°€ê²© ìš°ì„   
            nxt: [
                '.spt_con:has(.store_name:contains("NXT")) strong',    // NXT ê°€ê²©
                '.stock_info:has(.store_name:contains("NXT")) + * strong', // NXT ì˜ì—­ì˜ strong
                '.spt_con:nth-child(2) strong', // ë‘ ë²ˆì§¸ spt_con (ë³´í†µ NXT)
                '.spt_con strong',              // í´ë°±: ì²« ë²ˆì§¸ spt_con
                '.price em'
            ]
        }
    };
    
    if (assetType === 'crypto') {
        return selectors.crypto;
    } else if (assetType === 'stock') {
        // ğŸ• NXT/KRX ì „í™˜ ëª¨ë“œ í™•ì¸
        let tradingSession = 'regular'; // ê¸°ë³¸ê°’
        
        if (!TRADING_SCHEDULE.autoMode) {
            // ğŸ”§ ìˆ˜ë™ ëª¨ë“œ: ê°•ì œ ì„¤ì • ì‚¬ìš©
            if (TRADING_SCHEDULE.forceMode === 'nxt') {
                tradingSession = 'nxt';
                console.log(`-> ğŸ”§ ${assetName} ìˆ˜ë™ ëª¨ë“œ - NXT ê°•ì œ ì‚¬ìš©`);
            } else if (TRADING_SCHEDULE.forceMode === 'krx') {
                tradingSession = 'regular';
                console.log(`-> ğŸ”§ ${assetName} ìˆ˜ë™ ëª¨ë“œ - KRX ê°•ì œ ì‚¬ìš©`);
            } else {
                // forceModeê°€ 'auto'ì¸ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                tradingSession = 'regular';
                console.log(`-> ğŸ”§ ${assetName} ìˆ˜ë™ ëª¨ë“œ - ê¸°ë³¸ê°’(KRX) ì‚¬ìš©`);
            }
        } else {
            // ğŸ• ìë™ ëª¨ë“œ: ì‹œê°„ëŒ€ë³„ ì „í™˜
            const now = new Date();
            const kstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
            const hour = kstNow.getHours();
            const minute = kstNow.getMinutes();
            const currentTime = hour * 100 + minute; // HHMM í˜•ì‹
            
            if (currentTime >= TRADING_SCHEDULE.regularHours.start && currentTime <= TRADING_SCHEDULE.regularHours.end) {
                // ì •ê·œì¥ ì‹œê°„
                tradingSession = 'regular';
                console.log(`-> ğŸ“ˆ ${assetName} ì •ê·œì¥ ì‹œê°„ (${hour}:${minute.toString().padStart(2, '0')}) - ì •ê·œì¥ ê°€ê²© ìš°ì„ `);
            } else if (currentTime >= TRADING_SCHEDULE.nxtHours.start && currentTime <= TRADING_SCHEDULE.nxtHours.end) {
                // NXT ì‹œê°„ (ì •ê·œì¥ ì™¸)
                tradingSession = 'nxt';
                console.log(`-> ğŸŒ™ ${assetName} NXT ì‹œê°„ (${hour}:${minute.toString().padStart(2, '0')}) - NXT ê°€ê²© ìš°ì„ `);
            } else {
                // ê±°ë˜ ì‹œê°„ ì™¸
                tradingSession = 'regular'; // ê¸°ë³¸ê°’ìœ¼ë¡œ ì •ê·œì¥ ê°€ê²©
                console.log(`-> ğŸ˜´ ${assetName} ê±°ë˜ ì‹œê°„ ì™¸ (${hour}:${minute.toString().padStart(2, '0')}) - ì •ê·œì¥ ê°€ê²© ì‚¬ìš©`);
            }
        }
        
        return selectors.stock[tradingSession];
    }
    
    // ê¸°ë³¸ ì„ íƒì
    return ['.spt_con strong', '.price em', '.price_value'];
}

// ğŸ¯ ìë™ ê°€ê²© íŒŒì‹± - ì—¬ëŸ¬ ì„ íƒìë¥¼ ìë™ìœ¼ë¡œ ì‹œë„ (ì£¼ì‹ ì‹œê°„ëŒ€ë³„ ì§€ì›)
function parsePrice($, asset) {
    const selectors = getPriceSelectors(asset.type, asset.name);
    
    console.log(`ğŸ” ${asset.name} ê°€ê²© íŒŒì‹± ì‹œë„ ì¤‘...`);
    
    // ğŸ”¥ ì£¼ì‹ì˜ ê²½ìš° KRX/NXT êµ¬ë¶„ íŒŒì‹±
    if (asset.type === 'stock') {
        return parseStockPrice($, asset, selectors);
    }
    
    // ê¸°ì¡´ ë°©ì‹ (ì•”í˜¸í™”í ë“±)
    for (let i = 0; i < selectors.length; i++) {
        const selector = selectors[i];
        const priceText = $(selector).first().text().trim();
        
        if (priceText) {
            console.log(`   ì‹œë„ ${i + 1}: ${selector} â†’ "${priceText}"`);
            
            // ìˆ«ì ì¶”ì¶œ ë° ê²€ì¦
            const cleanedText = priceText.replace(/[^\d.,]/g, '').replace(/,/g, '');
            const price = parseFloat(cleanedText);
            
            if (!isNaN(price) && price > 0) {
                console.log(`   âœ… ì„±ê³µ! ì„ íƒì: ${selector}, ê°€ê²©: ${price.toLocaleString()}ì›`);
                return price;
            } else {
                console.log(`   âŒ ìˆ«ì ë³€í™˜ ì‹¤íŒ¨: "${cleanedText}"`);
            }
        } else {
            console.log(`   ì‹œë„ ${i + 1}: ${selector} â†’ í…ìŠ¤íŠ¸ ì—†ìŒ`);
        }
    }
    
    console.log(`   âŒ ëª¨ë“  ì„ íƒì ì‹¤íŒ¨ (${selectors.length}ê°œ ì‹œë„)`);
    return null;
}

// ğŸ”¥ ì£¼ì‹ ì „ìš© ê°€ê²© íŒŒì‹± í•¨ìˆ˜ (KRX/NXT êµ¬ë¶„) - ìˆ˜ì •ëœ ë¶€ë¶„
// ğŸ”¥ ìˆ˜ì •ëœ ì£¼ì‹ ì „ìš© ê°€ê²© íŒŒì‹± í•¨ìˆ˜ (NXT Pre Market ì§€ì›)
function parseStockPrice($, asset, selectors) {
    // í˜„ì¬ ì‹œê°„ í™•ì¸ (í•œêµ­ ì‹œê°„)
    const now = new Date();
    const kstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
    const hour = kstNow.getHours();
    const minute = kstNow.getMinutes();
    const currentTime = hour * 100 + minute;
    
    const isRegularHours = currentTime >= 900 && currentTime <= 1530;
    const isNxtHours = currentTime >= 800 && currentTime <= 2000;
    
    console.log(`   ğŸ“Š í˜„ì¬ ì‹œê°„: ${hour}:${minute.toString().padStart(2, '0')} (ì •ê·œì¥: ${isRegularHours}, NXT: ${isNxtHours})`);
    
    // ğŸ¯ ë°©ë²• 1: KRX/NXT êµ¬ë¶„í•´ì„œ ê°€ê²© ì¶”ì¶œ
    let krxPrice = null;
    let nxtPrice = null;
    
    // KRX ë° NXT ê°€ê²© ì°¾ê¸°
    $('.spt_con').each((index, element) => {
        const $element = $(element);
        const storeName = $element.find('.store_name').text().trim();
        const priceText = $element.find('strong').text().trim();
        
        console.log(`   ğŸ” ë°œê²¬ëœ ê±°ë˜ì†Œ: "${storeName}", ê°€ê²©: "${priceText}"`);
        
        if (storeName === 'KRX' && priceText) {
            const cleanedText = priceText.replace(/[^\d.,]/g, '').replace(/,/g, '');
            const price = parseFloat(cleanedText);
            if (!isNaN(price) && price > 0) {
                krxPrice = price;
                console.log(`   âœ… KRX ê°€ê²© ë°œê²¬: ${krxPrice.toLocaleString()}ì›`);
            }
        }
        
        // ğŸ”¥ ìˆ˜ì •: NXT Pre Marketë„ ì¸ì‹í•˜ë„ë¡ ë³€ê²½
        if ((storeName === 'NXT' || storeName === 'NXT Pre Market' || storeName.includes('NXT')) && priceText) {
            const cleanedText = priceText.replace(/[^\d.,]/g, '').replace(/,/g, '');
            const price = parseFloat(cleanedText);
            if (!isNaN(price) && price > 0) {
                nxtPrice = price;
                console.log(`   âœ… NXT ê°€ê²© ë°œê²¬: ${nxtPrice.toLocaleString()}ì› (ê±°ë˜ì†Œëª…: "${storeName}")`);
            }
        }
    });
    
    // ğŸ¯ ìˆ˜ë™ ëª¨ë“œ ì²´í¬ í›„ ê°€ê²© ì„ íƒ
    if (!TRADING_SCHEDULE.autoMode) {
        // ğŸ”§ ìˆ˜ë™ ëª¨ë“œ: ê°•ì œ ì„¤ì • ì‚¬ìš©
        if (TRADING_SCHEDULE.forceMode === 'nxt' && nxtPrice) {
            console.log(`   ğŸ”§ ìˆ˜ë™ ëª¨ë“œ - NXT ê°•ì œ ì‚¬ìš©: ${nxtPrice.toLocaleString()}ì›`);
            return nxtPrice;
        } else if (TRADING_SCHEDULE.forceMode === 'krx' && krxPrice) {
            console.log(`   ğŸ”§ ìˆ˜ë™ ëª¨ë“œ - KRX ê°•ì œ ì‚¬ìš©: ${krxPrice.toLocaleString()}ì›`);
            return krxPrice;
        } else if (krxPrice) {
            console.log(`   ğŸ”§ ìˆ˜ë™ ëª¨ë“œ - KRX ê¸°ë³¸ê°’ ì‚¬ìš©: ${krxPrice.toLocaleString()}ì›`);
            return krxPrice;
        } else if (nxtPrice) {
            console.log(`   ğŸ”§ ìˆ˜ë™ ëª¨ë“œ - NXT ëŒ€ì²´ê°’ ì‚¬ìš©: ${nxtPrice.toLocaleString()}ì›`);
            return nxtPrice;
        }
    } else {
        // ğŸ• ìë™ ëª¨ë“œ: ì‹œê°„ëŒ€ì— ë”°ë¥¸ ê°€ê²© ì„ íƒ
        if (isRegularHours && krxPrice) {
            console.log(`   ğŸ›ï¸ ì •ê·œì¥ ì‹œê°„ - KRX ê°€ê²© ì‚¬ìš©: ${krxPrice.toLocaleString()}ì›`);
            return krxPrice;
        } else if (isNxtHours && nxtPrice) {
            console.log(`   ğŸŒ™ NXT ì‹œê°„ - NXT ê°€ê²© ì‚¬ìš©: ${nxtPrice.toLocaleString()}ì›`);
            return nxtPrice;
        } else if (krxPrice) {
            console.log(`   ğŸ›ï¸ ê¸°ë³¸ê°’ - KRX ê°€ê²© ì‚¬ìš©: ${krxPrice.toLocaleString()}ì›`);
            return krxPrice;
        } else if (nxtPrice) {
            console.log(`   ğŸŒ™ ëŒ€ì²´ê°’ - NXT ê°€ê²© ì‚¬ìš©: ${nxtPrice.toLocaleString()}ì›`);
            return nxtPrice;
        }
    }
    
    // ğŸ¯ ë°©ë²• 2: ê¸°ì¡´ ì„ íƒìë“¤ë¡œ í´ë°±
    console.log(`   âš ï¸ KRX/NXT êµ¬ë¶„ ì‹¤íŒ¨, ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ì‹œë„...`);
    
    for (let i = 0; i < selectors.length; i++) {
        const selector = selectors[i];
        const priceText = $(selector).first().text().trim();
        
        if (priceText) {
            console.log(`   ì‹œë„ ${i + 1}: ${selector} â†’ "${priceText}"`);
            
            const cleanedText = priceText.replace(/[^\d.,]/g, '').replace(/,/g, '');
            const price = parseFloat(cleanedText);
            
            if (!isNaN(price) && price > 0) {
                console.log(`   âœ… í´ë°± ì„±ê³µ! ì„ íƒì: ${selector}, ê°€ê²©: ${price.toLocaleString()}ì›`);
                return price;
            }
        }
    }
    
    console.log(`   âŒ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨`);
    return null;
}

// ìì‚° ì„¤ì • ë³€ê²½ í•¨ìˆ˜ë“¤
function enableAsset(assetName) {
    const asset = ASSETS_TO_WATCH.find(a => a.name === assetName);
    if (asset) {
        asset.enabled = true;
        console.log(`âœ… ${assetName} ê°€ê²© ëª¨ë‹ˆí„°ë§ í™œì„±í™”ë¨ - ë‹¤ìŒ ëª¨ë‹ˆí„°ë§ë¶€í„° ì ìš©`);
        return true;
    } else {
        console.log(`âŒ ${assetName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìì‚°: ${ASSETS_TO_WATCH.map(a => a.name).join(', ')}`);
        return false;
    }
}

function disableAsset(assetName) {
    const asset = ASSETS_TO_WATCH.find(a => a.name === assetName);
    if (asset) {
        asset.enabled = false;
        console.log(`âŒ ${assetName} ê°€ê²© ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”ë¨ - ë‹¤ìŒ ëª¨ë‹ˆí„°ë§ë¶€í„° ì ìš©`);
        return true;
    } else {
        console.log(`âŒ ${assetName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìì‚°: ${ASSETS_TO_WATCH.map(a => a.name).join(', ')}`);
        return false;
    }
}

function toggleAsset(assetName) {
    const asset = ASSETS_TO_WATCH.find(a => a.name === assetName);
    if (asset) {
        asset.enabled = !asset.enabled;
        console.log(`ğŸ”„ ${assetName} ê°€ê²© ëª¨ë‹ˆí„°ë§ ${asset.enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë¨ - ë‹¤ìŒ ëª¨ë‹ˆí„°ë§ë¶€í„° ì ìš©`);
        return asset.enabled;
    } else {
        console.log(`âŒ ${assetName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìì‚°: ${ASSETS_TO_WATCH.map(a => a.name).join(', ')}`);
        return false;
    }
}

// ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ ì„¤ì • ë³€ê²½ í•¨ìˆ˜ë“¤
function enableNews(assetName) {
    const asset = ASSETS_TO_WATCH.find(a => a.name === assetName);
    if (asset) {
        asset.newsEnabled = true;
        console.log(`ğŸ“° ${assetName} ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”ë¨ - ë‹¤ìŒ ë‰´ìŠ¤ ê²€ìƒ‰ë¶€í„° ì ìš©`);
        return true;
    } else {
        console.log(`âŒ ${assetName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìì‚°: ${ASSETS_TO_WATCH.map(a => a.name).join(', ')}`);
        return false;
    }
}

function disableNews(assetName) {
    const asset = ASSETS_TO_WATCH.find(a => a.name === assetName);
    if (asset) {
        asset.newsEnabled = false;
        console.log(`ğŸ“° ${assetName} ë‰´ìŠ¤ ê²€ìƒ‰ ë¹„í™œì„±í™”ë¨ - ë‹¤ìŒ ë‰´ìŠ¤ ê²€ìƒ‰ë¶€í„° ì ìš©`);
        return true;
    } else {
        console.log(`âŒ ${assetName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìì‚°: ${ASSETS_TO_WATCH.map(a => a.name).join(', ')}`);
        return false;
    }
}

function toggleNews(assetName) {
    const asset = ASSETS_TO_WATCH.find(a => a.name === assetName);
    if (asset) {
        asset.newsEnabled = !asset.newsEnabled;
        console.log(`ğŸ“° ${assetName} ë‰´ìŠ¤ ê²€ìƒ‰ ${asset.newsEnabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë¨ - ë‹¤ìŒ ë‰´ìŠ¤ ê²€ìƒ‰ë¶€í„° ì ìš©`);
        return asset.newsEnabled;
    } else {
        console.log(`âŒ ${assetName}ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        console.log(`ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ìì‚°: ${ASSETS_TO_WATCH.map(a => a.name).join(', ')}`);
        return false;
    }
}

// ì „ì²´ ìì‚° ìƒíƒœ ë³´ê¸°
function showAssetStatus() {
    console.log('\nğŸ“Š ì „ì²´ ìì‚° ëª¨ë‹ˆí„°ë§ ìƒíƒœ:');
    console.log('='.repeat(80));
    ASSETS_TO_WATCH.forEach((asset, index) => {
        const priceStatus = asset.enabled ? 'ğŸŸ¢ í™œì„±í™”' : 'ğŸ”´ ë¹„í™œì„±í™”';
        const newsStatus = asset.newsEnabled ? 'ğŸ“° í™œì„±í™”' : 'ğŸ“° ë¹„í™œì„±í™”';
        const typeIcon = asset.type === 'crypto' ? 'â‚¿' : 'ğŸ“ˆ';
        console.log(`${index + 1}. ${typeIcon} ${asset.name} (${asset.type})`);
        console.log(`   ê°€ê²© ëª¨ë‹ˆí„°ë§: ${priceStatus}`);
        console.log(`   ë‰´ìŠ¤ ê²€ìƒ‰: ${newsStatus}`);
        console.log(`   ê²€ìƒ‰ì–´: "${asset.query}"`);
        console.log(`   ê¸‰ë“±ë½: Â±${asset.spikeThreshold}%, ì¶”ì„¸ì´íƒˆ: Â±${asset.trendThreshold}%`);
        console.log('');
    });
    console.log('='.repeat(80));
    
    const priceEnabled = ASSETS_TO_WATCH.filter(a => a.enabled).length;
    const newsEnabled = ASSETS_TO_WATCH.filter(a => a.newsEnabled).length;
    const total = ASSETS_TO_WATCH.length;
    console.log(`ğŸ“Š ìš”ì•½:`);
    console.log(`   ê°€ê²© ëª¨ë‹ˆí„°ë§: ${priceEnabled}ê°œ / ì „ì²´ ${total}ê°œ`);
    console.log(`   ë‰´ìŠ¤ ê²€ìƒ‰: ${newsEnabled}ê°œ / ì „ì²´ ${total}ê°œ`);
}

// ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ ìƒíƒœ ê´€ë¦¬
function readState() {
    try {
        if (fs.existsSync(STATE_FILE)) { 
            const data = fs.readFileSync(STATE_FILE, 'utf-8');
            
            // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB ì œí•œ)
            if (data.length > 10 * 1024 * 1024) {
                console.warn('âš ï¸ ìƒíƒœ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ë°±ì—… í›„ ì¬ìƒì„±...');
                
                // ë°±ì—… ìƒì„±
                const backupFile = `${STATE_FILE}.backup.${Date.now()}`;
                fs.writeFileSync(backupFile, data);
                
                // ìƒˆ ìƒíƒœë¡œ ì¬ìƒì„±
                const newState = { 
                    newsLink: null, 
                    newsHistory: [],
                    assetStates: {}, 
                    lastPeriodicReportTime: 0 
                };
                return initializeAssetStates(newState);
            }
            
            const state = JSON.parse(data);
            
            if (!state.newsHistory) {
                state.newsHistory = [];
            }
            
            // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”: ì˜¤ë˜ëœ ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬ ì •ë¦¬
            if (state.newsHistory && state.newsHistory.length > MAX_NEWS_HISTORY) {
                console.log(`ğŸ—‘ï¸ ì˜¤ë˜ëœ ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬ ì •ë¦¬: ${state.newsHistory.length} -> ${MAX_NEWS_HISTORY}`);
                state.newsHistory = state.newsHistory.slice(-MAX_NEWS_HISTORY);
            }
            
            // ğŸš€ ìƒˆ ìì‚° ìë™ ì´ˆê¸°í™”
            return initializeAssetStates(state);
        }
    } catch (error) { 
        console.error('ìƒíƒœ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error.message); 
        
        // ì†ìƒëœ íŒŒì¼ ë°±ì—… í›„ ì¬ìƒì„±
        if (fs.existsSync(STATE_FILE)) {
            const backupFile = `${STATE_FILE}.corrupted.${Date.now()}`;
            try {
                fs.copyFileSync(STATE_FILE, backupFile);
                console.log(`ğŸ“‹ ì†ìƒëœ ìƒíƒœ íŒŒì¼ì„ ${backupFile}ë¡œ ë°±ì—…í–ˆìŠµë‹ˆë‹¤.`);
            } catch (backupError) {
                console.error('ë°±ì—… ì‹¤íŒ¨:', backupError.message);
            }
        }
    }
    
    const newState = { 
        newsLink: null, 
        newsHistory: [],
        assetStates: {}, 
        lastPeriodicReportTime: 0 
    };
    
    // ğŸš€ ìƒˆ ìƒíƒœ íŒŒì¼ ìƒì„± ì‹œì—ë„ ìë™ ì´ˆê¸°í™”
    return initializeAssetStates(newState);
}

function writeState(newState) { 
    try { 
        fs.writeFileSync(STATE_FILE, JSON.stringify(newState, null, 2), 'utf-8'); 
    } catch (error) { 
        console.error('ìƒíƒœ íŒŒì¼ ì“°ê¸° ì˜¤ë¥˜:', error.message); 
    } 
}

async function sendNotification(message) { 
    console.log('ğŸ“¤ ë„¤ì´ë²„ì›ìŠ¤ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„...'); 
    try { 
        await fetch(NAVER_WORKS_HOOK_URL, { 
            method: 'POST', 
            body: message, 
            headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, 
            agent: insecureAgent 
        }); 
        console.log('âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!'); 
    } catch (error) { 
        console.error('âŒ ë„¤ì´ë²„ì›ìŠ¤ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error.message); 
    } 
}

// ğŸ¯ ìƒˆë¡œìš´ Flex Message ì „ì†¡ í•¨ìˆ˜
async function sendFlexNotification(flexMessage) { 
    console.log('ğŸ“¤ ë„¤ì´ë²„ì›ìŠ¤ë¡œ Flex Message ì „ì†¡ ì‹œë„...'); 
    try { 
        // Flex Messageë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
        const messageBody = JSON.stringify(flexMessage, null, 2);
        
        await fetch(NAVER_WORKS_HOOK_URL, { 
            method: 'POST', 
            body: messageBody, 
            headers: { 
                'Content-Type': 'application/json'  // JSON í˜•íƒœë¡œ ì „ì†¡
            }, 
            agent: insecureAgent 
        }); 
        console.log('âœ… Flex Message ì „ì†¡ ì„±ê³µ!'); 
        
        // ë””ë²„ê¹…ìš© ë¡œê·¸
        console.log('ğŸ“‹ ì „ì†¡ëœ Flex Message:');
        console.log(messageBody.substring(0, 500) + '...');
        
    } catch (error) { 
        console.error('âŒ ë„¤ì´ë²„ì›ìŠ¤ Flex Message ì „ì†¡ ì‹¤íŒ¨:', error.message); 
        
        // ğŸ”„ í´ë°±: ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì „ì†¡
        console.log('ğŸ”„ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ í´ë°± ì „ì†¡ ì‹œë„...');
        const altText = flexMessage.content.altText;
        const bodyContents = flexMessage.content.contents.body.contents;
        
        let fallbackMessage = altText + '\n\n';
        bodyContents.forEach(content => {
            if (content.type === 'text' && !content.text.startsWith('â°')) {
                fallbackMessage += content.text + '\n';
            } else if (content.type === 'text' && content.text.startsWith('â°')) {
                fallbackMessage += '\n' + content.text;
            }
        });
        
        await sendNotification(fallbackMessage);
        console.log('âœ… í´ë°± í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');
    } 
}

// ğŸ¯ ê¸‰ë“±ë½ ì•Œë¦¼ì„ Flex Messageë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
async function sendPriceAlertFlexMessage(asset, currentPrice, alertReason, alertEmoji, analysisInfo) {
    console.log('ğŸ“¤ ê¸‰ë“±ë½ ì•Œë¦¼ Flex Message ì „ì†¡ ì‹œë„...');
    
    // ğŸ¨ ìƒìŠ¹/í•˜ë½ì— ë”°ë¥¸ ìƒ‰ìƒ ê²°ì •
    let backgroundColor = "#0E71EB"; // ê¸°ë³¸ íŒŒë€ìƒ‰
    let alertType = "ì‹œì„¸ ë³€ë™";
    
    // alertReasonì—ì„œ ìƒìŠ¹/í•˜ë½ íŒë‹¨
    if (alertReason.includes('+') || 
        alertReason.includes('ìƒìŠ¹') || 
        alertReason.includes('ê¸‰ë“±') || 
        alertReason.includes('í­ë“±') || 
        alertReason.includes('ëŒ€í­ë“±')) {
        backgroundColor = "#FF4444"; // ë¹¨ê°„ìƒ‰ (ìƒìŠ¹)
        alertType = "ê¸‰ë“± ì•Œë¦¼";
    } else if (alertReason.includes('-') || 
               alertReason.includes('í•˜ë½') || 
               alertReason.includes('ê¸‰ë½') || 
               alertReason.includes('í­ë½') || 
               alertReason.includes('ëŒ€í­ë½')) {
        backgroundColor = "#4444FF"; // íŒŒë€ìƒ‰ (í•˜ë½)
        alertType = "ê¸‰ë½ ì•Œë¦¼";
    }
    
    const typeIcon = asset.type === 'crypto' ? 'â‚¿' : 'ğŸ“ˆ';
    
    // í•œêµ­ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
    const now = new Date();
    const kstTime = now.toLocaleString('ko-KR', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: true
    });
    
    // ğŸ¯ ê¸‰ë“±ë½ Flex Message êµ¬ì¡°
    const flexMessage = {
        "content": {
            "type": "flex",
            "altText": `${alertEmoji} [${alertType}] ${typeIcon} ${asset.name} - ${alertReason}`,
            "contents": {
                "type": "bubble",
                "size": "mega",
                "header": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": `${alertEmoji} ${alertType}`,
                            "weight": "bold",
                            "size": "lg",
                            "color": "#FFFFFF"
                        },
                        {
                            "type": "text",
                            "text": `${typeIcon} ${asset.name}`,
                            "size": "md",
                            "color": "#E0E0E0"
                        }
                    ],
                    "backgroundColor": backgroundColor,
                    "paddingAll": "15px"
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "spacing": "md",
                    "contents": [
                        {
                            "type": "text",
                            "text": `ğŸ’° í˜„ì¬ê°€: ${currentPrice.toLocaleString()}ì›`,
                            "wrap": true,
                            "size": "md",
                            "weight": "bold",
                            "color": "#222222"
                        },
                        {
                            "type": "text",
                            "text": `ğŸ“Š ì‚¬ìœ : ${alertReason}`,
                            "wrap": true,
                            "size": "sm",
                            "color": "#333333"
                        },
                        {
                            "type": "text",
                            "text": `âš™ï¸ ì„¤ì •ê°’: ê¸‰ë“±ë½ Â±${asset.spikeThreshold}%, ì¶”ì„¸ì´íƒˆ Â±${asset.trendThreshold}%`,
                            "wrap": true,
                            "size": "xs",
                            "color": "#666666"
                        },
                        {
                            "type": "text",
                            "text": `ğŸ” ${analysisInfo}`,
                            "wrap": true,
                            "size": "xs",
                            "color": "#666666"
                        },
                        {
                            "type": "separator",
                            "margin": "md"
                        },
                        {
                            "type": "text",
                            "text": `â° ${kstTime}`,
                            "size": "xs",
                            "color": "#888888",
                            "align": "end"
                        }
                    ]
                }
            }
        }
    };
    
    await sendFlexNotification(flexMessage);
}

// ğŸ¤– ê°œì„ ëœ ë‰´ìŠ¤ ê°ì • ë¶„ì„ í•¨ìˆ˜ import (2025-09-01 ì—…ê·¸ë ˆì´ë“œ: 15% â†’ 80% ì •í™•ë„)
// ê¸°ì¡´ 500ì¤„ ë³µì¡í•œ í•¨ìˆ˜ë¥¼ ê°„ë‹¨í•˜ê³  ì •í™•í•œ í•¨ìˆ˜ë¡œ êµì²´ (15% â†’ 80% ì •í™•ë„)
const { analyzeNewsSentiment } = require('./improved-sentiment.js');
    const hasNeutralPattern = neutralIndicators.some(pattern => pattern.test(text));
    
    if (!hasStrongEmotion && hasNeutralPattern) {
        return {
            sentiment: 'neutral',
            confidence: 85,
            emoji: 'ğŸ“Š',
            scores: { positive: 0, negative: 0, neutral: 85 },
            keywords: { positive: [], negative: [], neutral: ['ì¼ë°˜ ë³´ë„/ë¶„ì„'] }
        };
    }
    
    // === STEP 2: ê°•í™”ëœ ê°ì • íŒ¨í„´ ë§¤ì¹­ ===
    
    let positiveScore = 0;
    let negativeScore = 0;
    let positiveReasons = [];
    let negativeReasons = [];
    
    // ğŸŸ¢ ê¸ì • íŒ¨í„´ (ê°€ì¤‘ì¹˜ + ë§¥ë½ ê³ ë ¤)
    const positivePatterns = {
        // ì´ˆê°•ë ¥ í˜¸ì¬ (ê°€ì¤‘ì¹˜ 10)
        'ì‹ ê¸°ë¡': 10, 'ì‚¬ìƒìµœê³ ': 10, 'ì—­ëŒ€ìµœê³ ': 10,
        'ìƒí•œê°€': 10, 'ì‹ ê³ ê°€': 9, 'ìµœê³ ê°€': 8,
        
        // ê°•ë ¥ ìƒìŠ¹ (ê°€ì¤‘ì¹˜ 7-8)
        'í­ë“±': 8, 'ê¸‰ë“±': 7, 'ì¹˜ì†Ÿ': 7, 'ê¸‰ìƒìŠ¹': 7,
        'ëŒ€í­ìƒìŠ¹': 8, 'ê°•ì„¸': 6, 'ìƒìŠ¹ì„¸': 6,
        
        // ì‚¬ì—… í˜¸ì¬ (ê°€ì¤‘ì¹˜ 6-7)
        'ìƒì¥': 8, 'ë¦¬ìŠ¤íŒ…': 8, 'ê±°ë˜ì†Œë“±ë¡': 7,
        'íˆ¬ììœ ì¹˜': 7, 'í€ë”©': 7, 'ìê¸ˆì¡°ë‹¬': 6,
        'íŒŒíŠ¸ë„ˆì‹­': 6, 'ì œíœ´': 6, 'í˜‘ë ¥': 5, 'ê³„ì•½ì²´ê²°': 7,
        'ì„ ì •': 6, 'íŒŒíŠ¸ë„ˆì‚¬': 5, 'í˜‘ë ¥ì‚¬': 5,
        
        // ì‹¤ì  ê°œì„  (ê°€ì¤‘ì¹˜ 6-8)
        'í‘ìì „í™˜': 8, 'ì‹¤ì ê°œì„ ': 7, 'ìˆ˜ìµì¦ê°€': 6,
        'ë§¤ì¶œì¦ê°€': 6, 'ì„±ì¥': 5, 'íšŒë³µ': 5, 'ë°˜ë“±': 6,
        
        // ê¸°ìˆ /í˜ì‹  (ê°€ì¤‘ì¹˜ 5-6)
        'í˜ì‹ ': 6, 'ì‹ ê¸°ìˆ ': 6, 'íŠ¹í—ˆ': 5, 'ê°œë°œì„±ê³µ': 7,
        'í•´ì™¸ì§„ì¶œ': 5, 'ê¸€ë¡œë²Œ': 4, 'ìˆ˜ì¶œ': 4,
        
        // ìƒíƒœê³„/í™•ì¥ (ê°€ì¤‘ì¹˜ 4-6)
        'ìƒíƒœê³„': 5, 'êµ¬ì¶•': 4, 'í™•ëŒ€': 5, 'í™•ì¥': 5,
        'ì‹¤ìƒí™œ': 4, 'í™œìš©': 4, 'ë„ì…': 4, 'ì ìš©': 3,
        
        // ì¼ë°˜ ê¸ì • (ê°€ì¤‘ì¹˜ 3-4)
        'ìƒìŠ¹': 4, 'ì¦ê°€': 3, 'ê°œì„ ': 4, 'í˜¸ì¬': 5,
        'ì¢‹': 3, 'ìš°ìˆ˜': 4, 'ì„±ê³µ': 5, 'ì…ì¦': 4
    };
    
    // ğŸ”¥ ê°•í™”ëœ ê¸ˆìœµ ì „ë¬¸ìš©ì–´ í‚¤ì›Œë“œ ì‚¬ì „ - ì•…ì¬ (ë¶€ì •)
    const negativeKeywords = {
        // ì´ˆê°•ë ¥ í•˜ë½ (ê°€ì¤‘ì¹˜ 5)
        'í­ë½': 5, 'ê¸‰ë½': 4, 'ì¶”ë½': 4, 'í•˜í•œê°€': 5, 'ìµœì €ê°€': 4,
        
        // ê°•ë ¥ í•˜ë½ (ê°€ì¤‘ì¹˜ 3)
        'ê¸‰í•˜ë½': 3, 'ë¶•ê´´': 3, 'ê¸‰ë°˜ë½': 3, 'ì•½ì„¸': 3, 'í•˜ë½ì„¸': 3, 'ëŒ€í­í•˜ë½': 3,
        
        // ì¼ë°˜ í•˜ë½ (ê°€ì¤‘ì¹˜ 2)
        'í•˜ë½': 2, 'ë‚´ë¦¼': 2, 'ë‚´ë¦¼ì„¸': 2, 'ê°ì†Œ': 2, 'ì•…ì¬': 2, 'ë§ˆì´ë„ˆìŠ¤': 2, 
        'í•˜ë½í­': 2, 'í•˜ë½ë¥ ': 2, 'ë–¨ì–´ì§': 2, 'í•˜íšŒ': 2,
        
        // ë¶€ì •ì  ì‚¬ê±´ (ê°€ì¤‘ì¹˜ 2-3)
        'ì‚¬ê¸°': 3, 'í”¼ì‹±': 3, 'ë²”ì£„': 3, 'í•´í‚¹': 3, 'ìœ„í—˜': 2, 'ìš°ë ¤': 2, 'ê²½ê³ ': 2,
        'ì œì¬': 3, 'ê·œì œ': 2, 'ê¸ˆì§€': 3, 'ì¤‘ë‹¨': 2, 'ì·¨ì†Œ': 2,
        
        // ê°•ë ¥ ì•…ì¬ (ê°€ì¤‘ì¹˜ 4-5)
        'ì‹¤ì ì•…í™”': 5, 'ì ì': 4, 'ì†ì‹¤': 3, 'ìœ„ê¸°': 4, 'ì¶©ê²©': 4, 'íŒ¨ë‹‰': 5, 'íˆ¬ë§¤': 4,
        
        // ì‹œì¥ ë¶€ì • (ê°€ì¤‘ì¹˜ 2-3)
        'ë§¤ë„': 2, 'ê³µí¬': 3, 'ë¶ˆì‹ ': 2, 'ì˜êµ¬ì‹¬': 2,
        'ê²½ê³„': 2, 'ì£¼ì˜': 2, 'ìœ„í—˜': 3, 'ë²„ë¸”': 3, 'ê±°í’ˆ': 3,
        
        // ê¸°ì—… ë¶€ì • (ê°€ì¤‘ì¹˜ 3-4)
        'ì†Œì†¡': 3, 'ë¶„ìŸ': 3, 'ì œì¬': 4, 'ì²˜ë²Œ': 4, 'ê°ì‚¬': 2, 'ìˆ˜ì‚¬': 4,
        'íš¡ë ¹': 5, 'ë¹„ë¦¬': 4, 'ìŠ¤ìº”ë“¤': 4, 'ë…¼ë€': 2, 'ê·œì œ': 3,
        
        // ğŸ¢ ë‹¤ë‚ /í•€í…Œí¬ íŠ¹í™” ì•…ì¬ (ê°€ì¤‘ì¹˜ 3-5)
        'ê²°ì œì˜¤ë¥˜': 4, 'ì‹œìŠ¤í…œì¥ì• ': 4, 'ë³´ì•ˆì‚¬ê³ ': 5, 'í•´í‚¹': 5,
        'ê°œì¸ì •ë³´ìœ ì¶œ': 5, 'ê¸ˆìœµì‚¬ê³ ': 5, 'ì„œë¹„ìŠ¤ì¤‘ë‹¨': 4, 'ì¥ì• ë°œìƒ': 4,
        'í˜ì´ì•±ì˜¤ë¥˜': 3, 'ê²°ì œì‹¤íŒ¨': 3, 'ì¸ì¦ì˜¤ë¥˜': 3, 'ê¸ˆìœµë‹¹êµ­': 4,
        
        // ğŸª™ ì•”í˜¸í™”í íŠ¹í™” ì•…ì¬ (ê°€ì¤‘ì¹˜ 3-5)
        'ìƒì¥íì§€': 5, 'ë¸ë¦¬ìŠ¤íŒ…': 5, 'ê±°ë˜ì •ì§€': 5, 'ì¶œê¸ˆì¤‘ë‹¨': 5,
        'ì½”ì¸í•´í‚¹': 5, 'ê±°ë˜ì†Œí•´í‚¹': 5, 'ì§€ê°‘í•´í‚¹': 5, 'ìŠ¤ìº ': 5,
        'í°ì§€': 5, 'ëŸ¬ê·¸í’€': 5, 'ì½”ì¸ì‚¬ê¸°': 5, 'ê°€ìƒí™”íê·œì œ': 4,
        'ì±„êµ´ê¸ˆì§€': 4, 'ê±°ë˜ê¸ˆì§€': 4, 'ì•”í˜¸í™”íê¸ˆì§€': 4,
        
        // ğŸš¨ ì‚¬ê¸°/ë²”ì£„ ê´€ë ¨ ì•…ì¬ (ê°€ì¤‘ì¹˜ 4-5) 
        'ë³´ì´ìŠ¤í”¼ì‹±': 5, 'ì „í™”ì‚¬ê¸°': 5, 'íˆ¬ìì‚¬ê¸°': 5, 'í”¼ì‹±': 4,
        'ì‚¬ê¸°': 4, 'í”¼í•´': 3, 'ë²”ì£„': 4, 'ë¶ˆë²•': 4, 'ì•…ìš©': 3, 'ë„ìš©': 4,
        
        // ğŸ’³ í•€í…Œí¬ ê·œì œ ì•…ì¬ (ê°€ì¤‘ì¹˜ 3-4)
        'í•€í…Œí¬ê·œì œ': 4, 'ê¸ˆìœµê·œì œ': 4, 'ê²°ì œê·œì œ': 3, 'ë¼ì´ì„ ìŠ¤ì·¨ì†Œ': 5,
        'ì˜ì—…ì •ì§€': 5, 'ì—…ë¬´ê°œì„ ëª…ë ¹': 4, 'ê³¼ì§•ê¸ˆ': 3, 'ì œì¬ì¡°ì¹˜': 4
    };
    
    // ì¤‘ë¦½ í‚¤ì›Œë“œ (íŒ©íŠ¸ ìœ„ì£¼) - ê°€ì¤‘ì¹˜ ì‹œìŠ¤í…œ
    const neutralKeywords = {
        'ë°œí‘œ': 1, 'ê³µì‹œ': 1, 'ë³´ê³ ': 1, 'ì˜ˆì •': 1, 'ê³„íš': 1, 'ì „ë§': 1,
        'ë¶„ì„': 1, 'ì˜ˆì¸¡': 1, 'ì˜ê²¬': 1, 'í‰ê°€': 1, 'ê²€í† ': 1, 'ë…¼ì˜': 1
    };
    
    // ì‹œê°„/ê·œëª¨ ìˆ˜ì‹ì–´ íŒ¨í„´ ì •ì˜ (ì„íŒ©íŠ¸ í¬ê¸° ì¡°ì ˆ)
    const timeScalePatterns = {
        // ì‹œê°„ ê´€ë ¨ ìˆ˜ì‹ì–´
        'ë‹¨ê¸°': 0.7, 'ì´ˆë‹¨ê¸°': 0.5, 'ì¼ì‹œì ': 0.6, 'ìˆœê°„ì ': 0.5,
        'ì¤‘ê¸°': 1.0, 'ë‹¨ì¤‘ê¸°': 0.8, 
        'ì¥ê¸°': 1.3, 'ì¥ê¸°ì ': 1.3, 'ì§€ì†ì ': 1.4, 'ì§€ì†ê°€ëŠ¥': 1.5,
        'í•­êµ¬ì ': 1.6, 'ì˜êµ¬ì ': 1.8, 'êµ¬ì¡°ì ': 1.7,
        
        // ê·œëª¨ ê´€ë ¨ ìˆ˜ì‹ì–´  
        'ì†Œê·œëª¨': 0.6, 'ì†Œí­': 0.5, 'ë¯¸ì†Œ': 0.3, 'ì œí•œì ': 0.6, 'ë¶€ë¶„ì ': 0.7,
        'ì¤‘ê·œëª¨': 1.0, 'ì ë‹¹í•œ': 1.0, 'ë³´í†µ': 1.0,
        'ëŒ€ê·œëª¨': 1.8, 'ëŒ€í­': 2.0, 'ì „ë©´ì ': 2.2, 'ê´‘ë²”ìœ„': 2.0,
        'ì´ˆëŒ€í˜•': 2.5, 'ë©”ê°€': 2.3, 'ê¸°ê°€': 2.5, 'ì „ì²´': 2.0, 'ì „ ì„¸ê³„': 2.8,
        
        // ë¹ˆë„ ê´€ë ¨ ìˆ˜ì‹ì–´
        'ì²˜ìŒ': 1.5, 'ìµœì´ˆ': 1.6, 'ì²«': 1.3, 'ì‹ ê·œ': 1.2,
        'ì¬ì°¨': 1.1, 'ë‹¤ì‹œ': 1.0, 'ë°˜ë³µ': 0.9, 'ë˜ë‹¤ì‹œ': 0.8,
        'ì—°ì†': 1.4, 'ì§€ì†': 1.3, 'ê³„ì†': 1.2, 'ê¾¸ì¤€íˆ': 1.3,
        
        // ê°•ë„ ê´€ë ¨ ìˆ˜ì‹ì–´ (ê¸°ì¡´ intensityPatternsì™€ ë³´ì™„)
        'ì™„ì „': 2.0, 'ì ˆëŒ€': 2.2, '100%': 2.5, 'ì „ì ìœ¼ë¡œ': 2.1,
        'ë°˜': 0.5, 'ì ˆë°˜': 0.5, 'ë¶€ë¶„': 0.7, 'ì¼ë¶€': 0.6
    };
    
    let positiveScore = 0;
    let negativeScore = 0;
    let neutralScore = 0;
    
    let foundPositive = [];
    let foundNegative = [];
    let foundNeutral = [];
    
    // ë¶€ì •ì–´ íŒ¨í„´ ì •ì˜
    const negationPatterns = [
        'ì•ˆ', 'ì•Š', 'ì—†', 'ëª»', 'ì•„ë‹ˆ', 'ë¶€ì¡±', 'ë¯¸í¡', 'ë¶ˆê°€', 'ê¸ˆì§€', 'ì¤‘ì§€'
    ];
    
    // ê°•ë„ í‘œí˜„ íŒ¨í„´ ì •ì˜ (ë°°ìˆ˜ ì ìš©)
    const intensityPatterns = {
        'ë§¤ìš°': 2.0, 'ì•„ì£¼': 2.0, 'ìƒë‹¹íˆ': 1.8, 'í¬ê²Œ': 1.8, 'ëŒ€í­': 2.2,
        'ê¸‰ê²©íˆ': 2.0, 'ê¸‰ì†íˆ': 1.8, 'ëŒ€ê·œëª¨': 2.0, 'ëŒ€ëŸ‰': 1.8,
        'ì—„ì²­': 2.5, 'ê·¹ë„ë¡œ': 2.5, 'ì‹¬ê°í•˜ê²Œ': 2.2, 'í˜„ì €íˆ': 1.8,
        'ì••ë„ì ìœ¼ë¡œ': 2.3, 'í­ë°œì ìœ¼ë¡œ': 2.5, 'ê¸°ë¡ì ìœ¼ë¡œ': 2.2,
        'ì‚¬ìƒìµœëŒ€': 3.0, 'ì—­ëŒ€ìµœê³ ': 2.8, 'ì—­ëŒ€ìµœì €': 2.8,
        'ì†Œí­': 0.5, 'ë¯¸ë¯¸í•˜ê²Œ': 0.3, 'ì•½ê°„': 0.6, 'ë‹¤ì†Œ': 0.7, 'ì¡°ê¸ˆ': 0.5
    };
    
    // ë¶€ì •ì–´ ë° ê°•ë„ í‘œí˜„ ì²˜ë¦¬ í•¨ìˆ˜
    function processAdvancedSentiment(text, keywords, isPositive) {
        let score = 0;
        let found = [];
        
        Object.entries(keywords).forEach(([keyword, weight]) => {
            // ì¼ë°˜ ë§¤ì¹­
            const matches = (text.match(new RegExp(keyword, 'g')) || []).length;
            if (matches > 0) {
                // í‚¤ì›Œë“œ ì•ë’¤ 10ê¸€ì ë²”ìœ„ì—ì„œ ë§¥ë½ ë¶„ì„
                const keywordRegex = new RegExp(`(.{0,10})${keyword}(.{0,10})`, 'g');
                const contexts = [...text.matchAll(keywordRegex)];
                
                let positiveMatches = 0;
                let negativeMatches = 0;
                let totalIntensityMultiplier = 1.0;
                
                contexts.forEach(match => {
                    const before = match[1] || '';
                    const after = match[2] || '';
                    const context = before + after;
                    
                    // ë¶€ì •ì–´ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const hasNegation = negationPatterns.some(neg => context.includes(neg));
                    
                    // ê°•ë„ í‘œí˜„ í™•ì¸ ë° ë°°ìˆ˜ ê³„ì‚°
                    let intensityMultiplier = 1.0;
                    let timeScaleMultiplier = 1.0;
                    
                    // ê°•ë„ í‘œí˜„ íŒ¨í„´ í™•ì¸
                    Object.entries(intensityPatterns).forEach(([pattern, multiplier]) => {
                        if (context.includes(pattern)) {
                            intensityMultiplier = Math.max(intensityMultiplier, multiplier);
                        }
                    });
                    
                    // ì‹œê°„/ê·œëª¨ íŒ¨í„´ í™•ì¸
                    Object.entries(timeScalePatterns).forEach(([pattern, multiplier]) => {
                        if (context.includes(pattern)) {
                            timeScaleMultiplier = Math.max(timeScaleMultiplier, multiplier);
                        }
                    });
                    
                    // ë‘ ë°°ìˆ˜ë¥¼ ì¡°í•© (ìµœëŒ€ê°’ ì œí•œ)
                    const combinedMultiplier = Math.min(intensityMultiplier * timeScaleMultiplier, 5.0);
                    totalIntensityMultiplier *= combinedMultiplier;
                    
                    if (hasNegation) {
                        negativeMatches++;
                    } else {
                        positiveMatches++;
                    }
                });
                
                if (positiveMatches > 0) {
                    const baseScore = positiveMatches * weight;
                    const finalScore = Math.round(baseScore * totalIntensityMultiplier);
                    score += isPositive ? finalScore : -finalScore;
                    
                    const multiplierText = totalIntensityMultiplier !== 1.0 ? `Ã—${totalIntensityMultiplier.toFixed(1)}` : '';
                    found.push(`${keyword}(${positiveMatches}Ã—${weight}${multiplierText}=${finalScore})`);
                }
                
                if (negativeMatches > 0) {
                    const baseScore = negativeMatches * weight;
                    const finalScore = Math.round(baseScore * totalIntensityMultiplier);
                    score += isPositive ? -finalScore : finalScore;
                    
                    const multiplierText = totalIntensityMultiplier !== 1.0 ? `Ã—${totalIntensityMultiplier.toFixed(1)}` : '';
                    found.push(`${keyword}_ë¶€ì •(${negativeMatches}Ã—${weight}${multiplierText}=${finalScore})`);
                }
            }
        });
        
        return { score, found };
    }
    
    // ë¬¸ì¥ë³„ ë§¥ë½ ë¶„ì„ í•¨ìˆ˜
    function analyzeContextualSentiment() {
        let totalPositiveScore = 0;
        let totalNegativeScore = 0;
        let totalNeutralScore = 0;
        let allFoundPositive = [];
        let allFoundNegative = [];
        let allFoundNeutral = [];
        
        // ë¬¸ì¥ë³„ë¡œ ê°ì • ë¶„ì„
        sentences.forEach((sentence, index) => {
            if (sentence.trim().length < 3) return; // ë„ˆë¬´ ì§§ì€ ë¬¸ì¥ ì œì™¸
            
            console.log(`   ë¬¸ì¥ ${index + 1}: "${sentence.trim()}"`);
            
            // ê° ë¬¸ì¥ì— ëŒ€í•´ ê³ ê¸‰ ê°ì • ë¶„ì„ ìˆ˜í–‰
            const sentencePositive = processAdvancedSentiment(sentence, positiveKeywords, true);
            const sentenceNegative = processAdvancedSentiment(sentence, negativeKeywords, false);
            const sentenceNeutral = processAdvancedSentiment(sentence, neutralKeywords, true);
            
            // ë¬¸ì¥ë³„ ê°ì • ìš°ì„¸ë„ ê³„ì‚° (í•œ ë¬¸ì¥ì—ì„œ í˜¼ì¬ëœ ê°ì • ì²˜ë¦¬)
            const sentenceTotal = Math.abs(sentencePositive.score) + Math.abs(sentenceNegative.score);
            let sentenceWeight = 1.0;
            
            // ë¬¸ì¥ ê¸¸ì´ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜ (ê¸´ ë¬¸ì¥ì¼ìˆ˜ë¡ ì¤‘ìš”ë„ ì¦ê°€)
            if (sentence.length > 30) sentenceWeight *= 1.2;
            else if (sentence.length < 10) sentenceWeight *= 0.8;
            
            // ì œëª©ì— ê°€ê¹Œìš´ ë¬¸ì¥ì¼ìˆ˜ë¡ ì¤‘ìš”ë„ ì¦ê°€
            if (index === 0) sentenceWeight *= 1.5; // ì²« ë²ˆì§¸ ë¬¸ì¥ (ì œëª© ë¶€ë¶„)
            
            // ì¡°ê±´ë¶€ ë¬¸ì¥ ê°ì§€ ("ë§Œì•½", "ê°€ì •í•˜ë©´" ë“± - ê°€ì¤‘ì¹˜ ê°ì†Œ)
            if (sentence.includes('ë§Œì•½') || sentence.includes('ê°€ì •') || sentence.includes('ì˜ˆìƒ') || 
                sentence.includes('ì „ë§') || sentence.includes('ì˜ˆì¸¡')) {
                sentenceWeight *= 0.7;
                console.log(`     â†’ ì¡°ê±´ë¶€/ì˜ˆì¸¡ ë¬¸ì¥ìœ¼ë¡œ ê°€ì¤‘ì¹˜ ê°ì†Œ: ${sentenceWeight.toFixed(1)}`);
            }
            
            // ğŸš¨ ë¶€ì •ì  ë§¥ë½ì—ì„œ ì¦ê°€ í‘œí˜„ ê°ì§€ (ê°€ì¤‘ì¹˜ ì „í™˜)
            const hasNegativeContext = sentence.includes('ë³´ì´ìŠ¤í”¼ì‹±') || sentence.includes('ì‚¬ê¸°') || 
                                     sentence.includes('í”¼í•´') || sentence.includes('ë²”ì£„') || 
                                     sentence.includes('ì•…ìš©') || sentence.includes('ë¶ˆë²•') ||
                                     sentence.includes('í•´í‚¹') || sentence.includes('ë„ìš©');
                                     
            if (hasNegativeContext) {
                // ë¶€ì •ì  ë§¥ë½ì—ì„œ "ì¦ê°€/í­ì¦/ê¸‰ì¦" í‘œí˜„ì€ ë” ë¶€ì •ì ìœ¼ë¡œ í•´ì„
                const increaseWords = ['ì¦ê°€', 'í­ì¦', 'ê¸‰ì¦', 'ëŠ˜ì–´ë‚˜', 'í™•ì‚°', 'ë²ˆì§€'];
                let contextualNegativeBonus = 0;
                
                increaseWords.forEach(word => {
                    if (sentence.includes(word)) {
                        contextualNegativeBonus += 3; // ë¶€ì • ë§¥ë½ì—ì„œ ì¦ê°€ = ë” ë‚˜ì¨
                        console.log(`     â†’ ë¶€ì •ì  ë§¥ë½ì—ì„œ "${word}" ê°ì§€: ë¶€ì • ì ìˆ˜ +3`);
                    }
                });
                
                // ë¶€ì •ì  ë§¥ë½ì—ì„œ ìˆ˜ì¹˜ ì¦ê°€ í‘œí˜„ (2ë°°, 6ë°°, 10ë°° ë“±)
                const numberIncreaseMatch = sentence.match(/(\d+)ë°°/);
                if (numberIncreaseMatch) {
                    const multiplier = parseInt(numberIncreaseMatch[1]);
                    if (multiplier >= 2) {
                        const bonus = Math.min(multiplier, 10); // ìµœëŒ€ 10ì 
                        contextualNegativeBonus += bonus;
                        console.log(`     â†’ ë¶€ì •ì  ë§¥ë½ì—ì„œ "${multiplier}ë°°" ê°ì§€: ë¶€ì • ì ìˆ˜ +${bonus}`);
                    }
                }
                
                sentenceNegative.score += contextualNegativeBonus;
            }
            
            // ê°ì •ì´ í˜¼ì¬ëœ ê²½ìš° ì²˜ë¦¬
            if (sentenceTotal > 0) {
                const positiveRatio = Math.abs(sentencePositive.score) / sentenceTotal;
                const negativeRatio = Math.abs(sentenceNegative.score) / sentenceTotal;
                
                // ìš°ì„¸í•œ ê°ì •ì— ë” ë§ì€ ê°€ì¤‘ì¹˜ ë¶€ì—¬
                const adjustedPositive = Math.round(sentencePositive.score * sentenceWeight * positiveRatio);
                const adjustedNegative = Math.round(sentenceNegative.score * sentenceWeight * negativeRatio);
                const adjustedNeutral = Math.round(sentenceNeutral.score * sentenceWeight);
                
                totalPositiveScore += adjustedPositive;
                totalNegativeScore += adjustedNegative;
                totalNeutralScore += adjustedNeutral;
                
                console.log(`     â†’ ê°ì •ì ìˆ˜: ê¸ì •=${adjustedPositive}, ë¶€ì •=${adjustedNegative}, ì¤‘ë¦½=${adjustedNeutral}`);
                
                // ë°œê²¬ëœ í‚¤ì›Œë“œì— ë¬¸ì¥ ë²ˆí˜¸ ì¶”ê°€
                sentencePositive.found.forEach(item => 
                    allFoundPositive.push(`[ë¬¸ì¥${index + 1}]${item}`));
                sentenceNegative.found.forEach(item => 
                    allFoundNegative.push(`[ë¬¸ì¥${index + 1}]${item}`));
                sentenceNeutral.found.forEach(item => 
                    allFoundNeutral.push(`[ë¬¸ì¥${index + 1}]${item}`));
            }
        });
        
        return {
            positiveScore: Math.max(0, totalPositiveScore),
            negativeScore: Math.max(0, totalNegativeScore),
            neutralScore: Math.abs(totalNeutralScore),
            foundPositive: allFoundPositive,
            foundNegative: allFoundNegative,
            foundNeutral: allFoundNeutral
        };
    }
    
    // ë§¥ë½ ê¸°ë°˜ ê°ì • ë¶„ì„ ì‹¤í–‰
    const contextualResult = analyzeContextualSentiment();
    
    // ë§¥ë½ ë¶„ì„ ê²°ê³¼ ì ìš©
    positiveScore = contextualResult.positiveScore;
    negativeScore = contextualResult.negativeScore;
    neutralScore = contextualResult.neutralScore;
    
    // ğŸ”¥ ë§¥ë½ ê¸°ë°˜ ê°ì • ë³´ì • (ë¶€ì •ì  ë§¥ë½ì—ì„œ ì¦ê°€ í‘œí˜„ ì²˜ë¦¬)
    function applyContextualCorrection() {
        const fullText = (title + ' ' + description).toLowerCase();
        
        // ë¶€ì •ì  ë§¥ë½ í‚¤ì›Œë“œë“¤
        const negativeContexts = [
            'ë²”ì£„', 'ì‚¬ê¸°', 'í”¼ì‹±', 'í•´í‚¹', 'ìœ„ë°˜', 'ë¶ˆë²•', 'ì•…ìš©', 'í”¼í•´', 
            'ë¬¸ì œ', 'ìš°ë ¤', 'ìœ„í—˜', 'ê²½ê³ ', 'ì œì¬', 'ì²˜ë²Œ', 'ì†Œì†¡', 'ë¶„ìŸ',
            'ì†ì‹¤', 'ì ì', 'ì‹¤ì ì•…í™”', 'ìœ„ê¸°', 'ì¶©ê²©', 'íŒ¨ë‹‰'
        ];
        
        // ì¦ê°€ í‘œí˜„ í‚¤ì›Œë“œë“¤  
        const increaseWords = [
            'ì¦ê°€', 'ìƒìŠ¹', 'ê¸‰ì¦', 'í­ì¦', 'ëŠ˜ì–´', 'í™•ì‚°', 'ë²ˆì ¸', 'ê¸‰ë“±',
            'ì¹˜ì†Ÿ', 'ë°°', 'ì¦ê°€ìœ¨', 'ìƒìŠ¹ë¥ ', 'ëŠ˜ì–´ë‚˜', 'ì»¤ì§€'
        ];
        
        // ë¶€ì •ì  ë§¥ë½ì´ ìˆëŠ”ì§€ í™•ì¸
        let hasNegativeContext = false;
        let foundNegativeContext = '';
        
        for (const negContext of negativeContexts) {
            if (fullText.includes(negContext)) {
                hasNegativeContext = true;
                foundNegativeContext = negContext;
                break;
            }
        }
        
        // ì¦ê°€ í‘œí˜„ì´ ìˆëŠ”ì§€ í™•ì¸
        let hasIncreaseTerm = false;
        let foundIncreaseTerm = '';
        
        for (const increaseTerm of increaseWords) {
            if (fullText.includes(increaseTerm)) {
                hasIncreaseTerm = true;
                foundIncreaseTerm = increaseTerm;
                break;
            }
        }
        
        // ë¶€ì •ì  ë§¥ë½ + ì¦ê°€ í‘œí˜„ = ë¶€ì •ìœ¼ë¡œ ë³´ì •
        if (hasNegativeContext && hasIncreaseTerm) {
            console.log(`   ğŸ”§ ë§¥ë½ ë³´ì •: "${foundNegativeContext}" + "${foundIncreaseTerm}" â†’ ë¶€ì •ìœ¼ë¡œ ë³€ê²½`);
            
            // ê¸ì • ì ìˆ˜ë¥¼ ë¶€ì •ìœ¼ë¡œ ì´ë™
            if (positiveScore > 0) {
                const transferScore = positiveScore;
                positiveScore = 0;
                negativeScore += transferScore + 2; // ì¶”ê°€ ë¶€ì • ì ìˆ˜
                
                foundNegative.push(`ë§¥ë½ë³´ì •(${foundNegativeContext}+${foundIncreaseTerm}=+${transferScore + 2}ì )`);
                console.log(`   ğŸ”„ ì ìˆ˜ ì´ë™: ê¸ì • ${transferScore}ì  â†’ ë¶€ì •ìœ¼ë¡œ ì „í™˜ (+2 ë³´ë„ˆìŠ¤)`);
            } else {
                // ê¸ì • ì ìˆ˜ê°€ ì—†ì–´ë„ ë¶€ì • ì ìˆ˜ ì¶”ê°€
                negativeScore += 2;
                foundNegative.push(`ë§¥ë½ë¶€ì •(${foundNegativeContext}+${foundIncreaseTerm}=+2ì )`);
                console.log(`   â• ë§¥ë½ ë¶€ì • ì ìˆ˜ ì¶”ê°€: +2ì `);
            }
        }
        
        return {
            correctedPositive: positiveScore,
            correctedNegative: negativeScore,
            correctedNeutral: neutralScore,
            contextCorrection: hasNegativeContext && hasIncreaseTerm ? `${foundNegativeContext}+${foundIncreaseTerm}` : null
        };
    }
    
    // ë§¥ë½ ë³´ì • ì ìš©
    const correction = applyContextualCorrection();
    positiveScore = correction.correctedPositive;
    negativeScore = correction.correctedNegative;
    neutralScore = correction.correctedNeutral;
    
    // ë°œê²¬ëœ í‚¤ì›Œë“œ ëª©ë¡ (ë¬¸ì¥ ë²ˆí˜¸ í¬í•¨)
    foundPositive = contextualResult.foundPositive;
    foundNegative = contextualResult.foundNegative;
    foundNeutral = contextualResult.foundNeutral;
    
    // ê°ì • ë¶„ë¥˜ ë° ì‹ ë¢°ë„ ê³„ì‚°
    const totalScore = positiveScore + negativeScore + neutralScore;
    let sentiment, confidence, emoji;
    
    if (totalScore === 0) {
        sentiment = 'neutral';
        confidence = 0.3; // í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ë‚®ì€ ì‹ ë¢°ë„
        emoji = 'ğŸ˜';
    } else if (positiveScore > negativeScore) {
        const ratio = positiveScore / (positiveScore + negativeScore);
        sentiment = 'positive';
        
        // ğŸ”§ ê°œì„ ëœ ì‹ ë¢°ë„ ê³„ì‚°: ì‹¤ì œ ì ìˆ˜ ê°•ë„ì™€ ë¹„ìœ¨ ê³ ë ¤
        const scoreStrength = Math.min(positiveScore, 5) / 5; // 0~1 (ìµœëŒ€ 5ì  ê¸°ì¤€)
        const dominanceRatio = (positiveScore - negativeScore) / (positiveScore + negativeScore); // ìš°ì„¸ë„
        confidence = Math.min(0.85, 0.3 + scoreStrength * 0.4 + dominanceRatio * 0.15); // 0.3~0.85
        
        if (positiveScore >= 3) emoji = 'ğŸš€'; // ê°•í•œ í˜¸ì¬
        else if (positiveScore >= 2) emoji = 'ğŸ“ˆ'; // í˜¸ì¬  
        else emoji = 'ğŸ˜Š'; // ì•½ê°„ ê¸ì •
    } else if (negativeScore > positiveScore) {
        const ratio = negativeScore / (positiveScore + negativeScore);
        sentiment = 'negative';
        
        // ğŸ”§ ê°œì„ ëœ ì‹ ë¢°ë„ ê³„ì‚°: ì‹¤ì œ ì ìˆ˜ ê°•ë„ì™€ ë¹„ìœ¨ ê³ ë ¤
        const scoreStrength = Math.min(negativeScore, 5) / 5; // 0~1 (ìµœëŒ€ 5ì  ê¸°ì¤€)
        const dominanceRatio = (negativeScore - positiveScore) / (positiveScore + negativeScore); // ìš°ì„¸ë„
        confidence = Math.min(0.85, 0.3 + scoreStrength * 0.4 + dominanceRatio * 0.15); // 0.3~0.85
        
        if (negativeScore >= 3) emoji = 'ğŸ’€'; // ê°•í•œ ì•…ì¬
        else if (negativeScore >= 2) emoji = 'ğŸ“‰'; // ì•…ì¬
        else emoji = 'ğŸ˜°'; // ì•½ê°„ ë¶€ì •
    } else {
        sentiment = 'neutral';
        confidence = 0.6;
        emoji = 'ğŸ¤”';
    }
    
    const result = {
        sentiment: sentiment,
        confidence: Math.round(confidence * 100),
        emoji: emoji,
        scores: {
            positive: positiveScore,
            negative: negativeScore,
            neutral: neutralScore
        },
        keywords: {
            positive: foundPositive,
            negative: foundNegative,
            neutral: foundNeutral
        }
    };
    
    // ë¡œê·¸ ì¶œë ¥
    console.log(`   ê°ì •: ${sentiment} (${emoji})`);
    console.log(`   ì‹ ë¢°ë„: ${result.confidence}%`);
    console.log(`   ì ìˆ˜: ê¸ì • ${positiveScore}, ë¶€ì • ${negativeScore}, ì¤‘ë¦½ ${neutralScore}`);
    if (foundPositive.length > 0) console.log(`   ğŸŸ¢ ê¸ì • í‚¤ì›Œë“œ: ${foundPositive.join(', ')}`);
    if (foundNegative.length > 0) console.log(`   ğŸ”´ ë¶€ì • í‚¤ì›Œë“œ: ${foundNegative.join(', ')}`);
    if (foundNeutral.length > 0) console.log(`   âšª ì¤‘ë¦½ í‚¤ì›Œë“œ: ${foundNeutral.join(', ')}`);
    
    return result;
}

// ê¸°ì¡´ ì¤‘ë³µëœ sendNewsFlexMessage í•¨ìˆ˜ë“¤ì„ ëª¨ë‘ ì œê±°í•˜ê³  ì´ê²ƒìœ¼ë¡œ êµì²´

// ğŸ¯ ë‰´ìŠ¤ ì•Œë¦¼ì„ Flex Messageë¡œ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜ (footer ë§í¬ ì¶”ê°€)
async function sendNewsFlexMessage(newsItem) {
    console.log(`\nğŸ“¤ [${newsItem.searchedAsset}] Flex Message ë‰´ìŠ¤ ì•Œë¦¼ ë°œì†¡ ì‹œì‘...`);
    
    // ğŸ¤– ë‰´ìŠ¤ ê°ì • ë¶„ì„ ìˆ˜í–‰
    const sentimentAnalysis = analyzeNewsSentiment(newsItem.title, newsItem.description || '');
    
    // ê°ì •ì— ë”°ë¥¸ í—¤ë” ìƒ‰ìƒ ê²°ì •
    let headerColor = '#1E3A8A'; // ê¸°ë³¸ íŒŒë€ìƒ‰ (ë‰´ìŠ¤)
    let headerText = 'ğŸ“° ë‰´ìŠ¤ ì•Œë¦¼';
    
    if (sentimentAnalysis.confidence >= 60) { // ì‹ ë¢°ë„ 60% ì´ìƒì¼ ë•Œë§Œ ìƒ‰ìƒ ë³€ê²½
        switch (sentimentAnalysis.sentiment) {
            case 'positive':
                headerColor = '#059669'; // ì´ˆë¡ìƒ‰ (í˜¸ì¬)
                headerText = `ğŸ“° ë‰´ìŠ¤ ì•Œë¦¼ ${sentimentAnalysis.emoji}`;
                break;
            case 'negative':
                headerColor = '#DC2626'; // ë¹¨ê°„ìƒ‰ (ì•…ì¬)
                headerText = `ğŸ“° ë‰´ìŠ¤ ì•Œë¦¼ ${sentimentAnalysis.emoji}`;
                break;
            default:
                headerText = `ğŸ“° ë‰´ìŠ¤ ì•Œë¦¼ ${sentimentAnalysis.emoji}`;
                break;
        }
    }
    
    const flexMessage = {
        "content": {
            "type": "flex",
            "altText": `ğŸ“° [${newsItem.searchedAsset}] ${newsItem.title}`,
            "contents": {
            type: 'bubble',
            size: 'mega',
            header: {
                type: 'box',
                layout: 'vertical',
                paddingTop: 'md',
                paddingBottom: 'sm',
                backgroundColor: headerColor,
                contents: [
                    {
                        type: 'text',
                        text: headerText,
                        color: '#FFFFFF',
                        weight: 'bold',
                        size: 'md'
                    },
                    {
                        type: 'text',
                        text: `ğŸ¯ ${newsItem.searchedAsset}`,
                        color: '#93C5FD',
                        size: 'sm',
                        margin: 'xs'
                    }
                ]
            },
            body: {
                type: 'box',
                layout: 'vertical',
                paddingAll: 'md',
                contents: [
                    {
                        type: 'text',
                        text: newsItem.title,
                        weight: 'bold',
                        size: 'md',
                        wrap: true,
                        color: '#1F2937'
                    },
                    {
                        type: 'separator',
                        margin: 'md'
                    },
                    {
                        type: 'box',
                        layout: 'vertical',
                        margin: 'md',
                        contents: [
                            {
                                type: 'box',
                                layout: 'baseline',
                                contents: [
                                    {
                                        type: 'text',
                                        text: 'ğŸ“°',
                                        size: 'sm',
                                        flex: 0
                                    },
                                    {
                                        type: 'text',
                                        text: newsItem.press,
                                        size: 'sm',
                                        color: '#6B7280',
                                        margin: 'sm',
                                        flex: 1
                                    }
                                ]
                            },
                            {
                                type: 'box',
                                layout: 'baseline',
                                margin: 'sm',
                                contents: [
                                    {
                                        type: 'text',
                                        text: 'â°',
                                        size: 'sm',
                                        flex: 0
                                    },
                                    {
                                        type: 'text',
                                        text: newsItem.time,
                                        size: 'sm',
                                        color: '#6B7280',
                                        margin: 'sm',
                                        flex: 1
                                    }
                                ]
                            },
                            {
                                type: 'box',
                                layout: 'baseline',
                                margin: 'sm',
                                contents: [
                                    {
                                        type: 'text',
                                        text: 'ğŸ¤–',
                                        size: 'sm',
                                        flex: 0
                                    },
                                    {
                                        type: 'text',
                                        text: `ê°ì •ë¶„ì„: ${sentimentAnalysis.emoji} ${sentimentAnalysis.sentiment} (${sentimentAnalysis.confidence}%)`,
                                        size: 'sm',
                                        color: sentimentAnalysis.sentiment === 'positive' ? '#059669' : 
                                               sentimentAnalysis.sentiment === 'negative' ? '#DC2626' : '#6B7280',
                                        margin: 'sm',
                                        flex: 1
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        type: 'text',
                        text: newsItem.description.length > 200 ? 
                              newsItem.description.substring(0, 200) + '...' : 
                              newsItem.description,
                        size: 'sm',
                        color: '#4B5563',
                        margin: 'md',
                        wrap: true
                    }
                ]
            },
            footer: {
                type: 'box',
                layout: 'vertical',
                spacing: 'sm',
                contents: [
                    {
                        type: 'button',
                        style: 'primary',
                        color: '#8B5CF6',
                        height: 'sm',
                        action: {
                            type: 'uri',
                            label: 'ğŸ“° ë‰´ìŠ¤ ì „ë¬¸ ë³´ê¸°',
                            uri: newsItem.link
                        }
                    }
                ]
            }
        }
        }
    };
    
    try {
        await sendFlexNotification(flexMessage);
        console.log(`âœ… [${newsItem.searchedAsset}] Flex ë‰´ìŠ¤ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!`);
    } catch (error) {
        console.error(`âŒ [${newsItem.searchedAsset}] Flex ë‰´ìŠ¤ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨:`, error.message);
        // ì‹¤íŒ¨ ì‹œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´ ë°œì†¡
        const fallbackMessage = `ğŸ“° [${newsItem.searchedAsset}] ${newsItem.title}\n\n` +
                               `ğŸ“° ${newsItem.press} | â° ${newsItem.time}\n\n` +
                               `${newsItem.description.substring(0, 100)}...\n\n` +
                               `ğŸ”— ${newsItem.link}`;
        await sendNotification(fallbackMessage);
        console.log(`âœ… [${newsItem.searchedAsset}] ëŒ€ì²´ í…ìŠ¤íŠ¸ ë‰´ìŠ¤ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ!`);
    }
}

// ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ fetch í•¨ìˆ˜ (ì¬ì‹œë„ ë¡œì§ ì¶”ê°€)
async function fetchWithCurl(url, options = { isJson: true }) { 
    const headers = options.headers || {}; 
    let headerString = ''; 
    for (const key in headers) { 
        headerString += `-H "${key}: ${headers[key]}" `; 
    } 
    
    // ë©”ëª¨ë¦¬ ì œí•œ ë° íƒ€ì„ì•„ì›ƒ ì„¤ì • ê°•í™”
    const command = `curl -s -k --max-time 15 --max-filesize 10485760 -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" ${headerString} "${url}"`;
    
    const maxRetries = 3;
    let lastError = null;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try { 
            const { stdout } = await exec(command, { 
                timeout: 15000,
                maxBuffer: 10 * 1024 * 1024, // 10MB ì œí•œ
                killSignal: 'SIGTERM',
                windowsHide: true  // Windowsì—ì„œ cmd ì°½ ìˆ¨ê¸°ê¸°
            }); 
            
            // ì‘ë‹µ í¬ê¸° ì²´í¬
            if (stdout.length > 10 * 1024 * 1024) { // 10MB ì´ˆê³¼
                console.warn(`âš ï¸ ì‘ë‹µ í¬ê¸°ê°€ ë„ˆë¬´ í¼: ${Math.round(stdout.length / 1024 / 1024)}MB`);
                return null;
            }
            
            return options.isJson ? JSON.parse(stdout) : stdout; 
        } catch (error) { 
            lastError = error;
            
            if (error instanceof SyntaxError) { 
                console.error(`âŒ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (URL: ${url})`); 
                break; // JSON íŒŒì‹± ì˜¤ë¥˜ëŠ” ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ
            } else if (attempt < maxRetries) {
                console.warn(`âš ï¸ ìš”ì²­ ì‹¤íŒ¨ (${attempt}/${maxRetries}), ì¬ì‹œë„ ì¤‘... (URL: ${url})`);
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // ì§€ìˆ˜ ë°±ì˜¤í”„
            } else {
                console.error(`âŒ curl ì‹¤í–‰ ì˜¤ë¥˜ (URL: ${url}):`, error.message); 
            }
        } 
    }
    
    return null; 
}

// ì‹¤ì œ ë‰´ìŠ¤ ë‚ ì§œ ê²€ì¦ (ì‹œê°„ í‘œí˜„ ê¸°ë°˜) - ê°œì„ ëœ ë²„ì „
function isNewsRecentByTime(timeText, maxAgeHours = 6) { // 6ì‹œê°„ìœ¼ë¡œ ì¶•ì†Œ
    try {
        console.log(`â° ì‹œê°„ í…ìŠ¤íŠ¸ ë¶„ì„: "${timeText}" (ê¸°ì¤€: ${maxAgeHours}ì‹œê°„)`);
        
        // ëª…í™•í•˜ê²Œ ì˜¤ë˜ëœ í‘œí˜„ë“¤ ì²´í¬
        const oldKeywords = ['ì¼ ì „', 'ì¼ì „', 'ì£¼ ì „', 'ì£¼ì „', 'ê°œì›” ì „', 'ë‹¬ ì „', 'ë…„ ì „', 'ë…„ì „'];
        const isOld = oldKeywords.some(keyword => timeText.includes(keyword));
        
        if (isOld) {
            console.log(`âŒ ì˜¤ë˜ëœ ë‰´ìŠ¤ í‚¤ì›Œë“œ ë°œê²¬: ${timeText}`);
            return false;
        }
        
        // ì‹œê°„ í‘œí˜„ì´ ìˆëŠ” ê²½ìš° íŒŒì‹±í•´ì„œ ì²´í¬
        if (timeText.includes('ì‹œê°„ ì „') || timeText.includes('ì‹œê°„ì „')) {
            const hours = parseInt(timeText.match(/(\d+)ì‹œê°„/)?.[1] || '0');
            console.log(`â° ${hours}ì‹œê°„ ì „ ë‰´ìŠ¤ (ê¸°ì¤€: ${maxAgeHours}ì‹œê°„)`);
            if (hours > maxAgeHours) {
                console.log(`âŒ ë„ˆë¬´ ì˜¤ë˜ëœ ë‰´ìŠ¤: ${hours}ì‹œê°„ ì „ > ${maxAgeHours}ì‹œê°„`);
                return false;
            } else {
                console.log(`âœ… í—ˆìš© ë²”ìœ„ ë‚´ ë‰´ìŠ¤: ${hours}ì‹œê°„ ì „ â‰¤ ${maxAgeHours}ì‹œê°„`);
                return true;
            }
        }
        
        // ë¶„ ë‹¨ìœ„, ì˜¤ëŠ˜, ì–´ì œ, ìµœê·¼ì€ ìµœì‹ ìœ¼ë¡œ ê°„ì£¼
        const recentKeywords = ['ë¶„ ì „', 'ë¶„ì „', 'ì˜¤ëŠ˜', 'today', 'ì–´ì œ', 'yesterday', 'ìµœê·¼'];
        const isRecent = recentKeywords.some(keyword => timeText.includes(keyword));
        
        if (isRecent) {
            console.log(`âœ… ìµœì‹  ë‰´ìŠ¤ í™•ì¸: ${timeText}`);
            return true;
        }
        
        // ğŸ”¥ "ì‹œê°„ ë¯¸ìƒ"ì¸ ê²½ìš°ëŠ” ê±°ë¶€í•˜ë„ë¡ ë³€ê²½
        if (timeText.includes('ì‹œê°„ ë¯¸ìƒ') || timeText.includes('ë¯¸ìƒ')) {
            console.log(`âŒ ì‹œê°„ ë¯¸ìƒìœ¼ë¡œ ì œì™¸: ${timeText}`);
            return false;
        }
        
        // í™•ì‹¤í•˜ì§€ ì•Šì€ ê²½ìš°ë„ í—ˆìš© (ë” ê´€ëŒ€í•˜ê²Œ)
        console.log(`â“ ë¶ˆí™•ì‹¤í•œ ì‹œê°„ í‘œí˜„, í—ˆìš©: ${timeText}`);
        return true; // ë” ê´€ëŒ€í•˜ê²Œ ë³€ê²½
        
    } catch (error) {
        console.error(`âŒ ì‹œê°„ íŒŒì‹± ì˜¤ë¥˜: ${error.message}`);
        return true; // ì˜¤ë¥˜ ì‹œ í—ˆìš©í•˜ë„ë¡ ë³€ê²½
    }
}
// ë‰´ìŠ¤ ì¤‘ë³µ ì²´í¬
function isNewsAlreadySent(newsItem, newsHistory) {
    const isDuplicateByLink = newsHistory.some(historyItem => historyItem.link === newsItem.link);
    const isDuplicateByTitle = newsHistory.some(historyItem => 
        historyItem.title && newsItem.title && 
        historyItem.title.trim().toLowerCase() === newsItem.title.trim().toLowerCase()
    );
    
    return isDuplicateByLink || isDuplicateByTitle;
}

function addNewsToHistory(newsItem, currentState) {
    const newsHistoryItem = {
        title: newsItem.title,
        link: newsItem.link,
        timestamp: new Date().getTime(),
        pubDate: newsItem.pubDate,
        source: newsItem.source || newsItem.press || 'Unknown'
    };
    
    currentState.newsHistory.unshift(newsHistoryItem);
    
    if (currentState.newsHistory.length > MAX_NEWS_HISTORY) {
        currentState.newsHistory = currentState.newsHistory.slice(0, MAX_NEWS_HISTORY);
    }
    
    currentState.newsLink = newsItem.link;
    
    console.log(`ğŸ“ ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€: ${newsItem.title.substring(0, 50)}...`);
    console.log(`ğŸ“Š í˜„ì¬ íˆìŠ¤í† ë¦¬ ê°œìˆ˜: ${currentState.newsHistory.length}/${MAX_NEWS_HISTORY}`);
}

// --- 3. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ (Core Feature Functions) ---

// ğŸ”¥ ìì‚°ë³„ ê°œë³„ ë‰´ìŠ¤ ê²€ìƒ‰ - 1ë¶„ì— í•˜ë‚˜ì”© ìˆœí™˜ ê²€ìƒ‰ (ê°œì„ ëœ ë²„ì „)
async function checkNewsWithRotatingAssets(currentState) {
    console.log(`\nğŸ“° [ë‰´ìŠ¤] ìì‚°ë³„ ìˆœí™˜ ë‰´ìŠ¤ ê²€ìƒ‰ ì‹œì‘...`);
    
    // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”ëœ ìì‚° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const newsEnabledAssets = getNewsEnabledAssets();
    
    if (newsEnabledAssets.length === 0) {
        console.log('âš ï¸ ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤. ë‰´ìŠ¤ ê²€ìƒ‰ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
        return;
    }
    
    // ë‰´ìŠ¤ ê²€ìƒ‰ ìƒíƒœ í™•ì¸
    const newsState = currentState.newsSearchState;
    const currentTime = Date.now();
    
    // ğŸ¯ ë‹¤ìŒ ê²€ìƒ‰í•  ìì‚° ê²°ì • (ìˆœí™˜ ë°©ì‹)
    if (!newsState || newsState.currentAssetIndex >= newsEnabledAssets.length) {
        newsState.currentAssetIndex = 0;
    }
    
    const targetAsset = newsEnabledAssets[newsState.currentAssetIndex];
    const searchQuery = targetAsset.name;
    
    console.log(`ğŸ¯ í˜„ì¬ ë‰´ìŠ¤ ê²€ìƒ‰ ëŒ€ìƒ: ${targetAsset.name} (${newsState.currentAssetIndex + 1}/${newsEnabledAssets.length})`);
    console.log(`ğŸ” ê²€ìƒ‰ ì¿¼ë¦¬: "${searchQuery}"`);
    console.log(`ğŸ“‹ í˜„ì¬ ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬: ${currentState.newsHistory.length}ê°œ`);
    console.log(`â° ë‰´ìŠ¤ í•„í„°ë§: ìµœê·¼ ${MAX_NEWS_AGE_HOURS}ì‹œê°„ ì´ë‚´ë§Œ í—ˆìš©`);
    
    // ğŸ”„ ë‹¤ìŒ ê²€ìƒ‰ì„ ìœ„í•´ ì¸ë±ìŠ¤ ì¦ê°€
    newsState.currentAssetIndex = (newsState.currentAssetIndex + 1) % newsEnabledAssets.length;
    newsState.lastSearchTime = currentTime;
    
    // ë‹¤ìŒ ê²€ìƒ‰ ì˜ˆì • ìì‚° í‘œì‹œ
    const nextAssetIndex = newsState.currentAssetIndex;
    const nextAsset = newsEnabledAssets[nextAssetIndex];
    console.log(`â¡ï¸ ë‹¤ìŒ ë‰´ìŠ¤ ê²€ìƒ‰ ì˜ˆì •: ${nextAsset.name} (1ë¶„ í›„)`);
    
    // ğŸ¯ ìƒˆë¡œìš´ ë„¤ì´ë²„ ë‰´ìŠ¤ ê²€ìƒ‰ URL (ìµœì‹ ìˆœ ì •ë ¬)
    //const searchUrl = `https://search.naver.com/search.naver?ssc=tab.news.all&where=news&sm=tab_jum&query=${encodeURIComponent(searchQuery)}`;  // ê¸°ë³¸ ê²€ìƒ‰
    //const searchUrl = `https://search.naver.com/search.naver?ssc=tab.news.all&query=${encodeURIComponent(searchQuery)}&sm=tab_opt&sort=0&photo=0&field=0&pd=0&ds=2025.08.31&de=2025.08.31&docid=&related=0&mynews=0&office_type=0&office_section_code=0&news_office_checked=&nso=so%3Ar%2Cp%3Aall&is_sug_officeid=0&office_category=0&service_area=0`  // ì •í™•ë„ìˆœ
    // ë™ì  ë‚ ì§œ ìƒì„± (ì˜¤ëŠ˜ ë‚ ì§œ)
    const today = new Date();
    const todayStr = today.getFullYear() + '.' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '.' + 
                     String(today.getDate()).padStart(2, '0');
    
    const searchUrl = `https://search.naver.com/search.naver?ssc=tab.news.all&query=${encodeURIComponent(searchQuery)}&sm=tab_opt&sort=1&photo=0&field=0&pd=-1&ds=${todayStr}&de=${todayStr}&docid=&related=0&mynews=0&office_type=0&office_section_code=0&news_office_checked=&nso=so%3Add%2Cp%3Aall&is_sug_officeid=0&office_category=0&service_area=0`  // ìµœì‹ ìˆœ (ì˜¤ëŠ˜ ë‚ ì§œ ìë™)
    console.log(`ğŸŒ ê²€ìƒ‰ URL: ${searchUrl}`);
    
    try {
        const html = await fetchWithCurl(searchUrl, { isJson: false });
        if (!html) {
            console.log(`âŒ ${targetAsset.name} ë‰´ìŠ¤ í˜ì´ì§€ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
            return;
        }

        console.log(`âœ… ${targetAsset.name} HTML ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì„±ê³µ (ê¸¸ì´: ${html.length}ì)`);
        
        const $ = cheerio.load(html);
        
        // ğŸ” ìƒˆë¡œìš´ ë„¤ì´ë²„ ë‰´ìŠ¤ êµ¬ì¡° ë¶„ì„
        console.log(`\nğŸ” ${targetAsset.name} HTML êµ¬ì¡° ë¶„ì„...`);
        
        // ğŸ¯ 2025ë…„ ìƒˆë¡œìš´ ë„¤ì´ë²„ ë‰´ìŠ¤ ì„ íƒìë“¤ (ì‹¤ì œ HTML ê¸°ë°˜)
        const newsSelectors = [
            // ğŸ”¥ ê°œë³„ ë‰´ìŠ¤ ì•„ì´í…œì— ë” ì§‘ì¤‘í•œ ì„ íƒìë“¤ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
            '.sds-comps-base-layout.sds-comps-full-layout',      // ê°œë³„ ë‰´ìŠ¤ ì»¨í…Œì´ë„ˆ
            'div[class*="sds-comps-base-layout"][class*="sds-comps-full-layout"]', // ê°œë³„ ë‰´ìŠ¤ (ë¶€ë¶„ ë§¤ì¹­)  
            '.news_item, .list_news li, .bx, .news',             // ì „í†µì ì¸ ê°œë³„ ë‰´ìŠ¤ ì•„ì´í…œ
            'div[data-template-id="layout"]',                     // ë ˆì´ì•„ì›ƒ í…œí”Œë¦¿
            // ğŸ”¥ ë” êµ¬ì²´ì ì¸ ê°œë³„ ë‰´ìŠ¤ ì„ íƒìë“¤
            '.sds-comps-vertical-layout.NYqAjUWdQsgkJBAODPln',    // ê° ë‰´ìŠ¤ í•­ëª©ì˜ ë©”ì¸ ì»¨í…Œì´ë„ˆ
            '.sds-comps-vertical-layout.fds-news-item-list-tab',  // ë‰´ìŠ¤ ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ íƒ­
            // ê¸°ì¡´ ì„ íƒìë“¤ (í˜¸í™˜ì„±)
            '.JYgn_vFQHubpClbvwVL_',    // ë©”ì¸ ë‰´ìŠ¤ ì»¨í…Œì´ë„ˆ (ìƒˆë¡œìš´ ë„¤ì´ë²„ êµ¬ì¡°)
            '.fds-news-item-list-desk .JYgn_vFQHubpClbvwVL_', // ë” êµ¬ì²´ì ì¸ ê²½ë¡œ
            '.news_area',               // ê¸°ì¡´ ì„ íƒì (í˜¸í™˜ì„±)
            '.api_subject_bx',          // API ë‰´ìŠ¤ ë°•ìŠ¤
            'div[class*="JYgn_vFQHubpClbvwVL"]', // ë¶€ë¶„ ë§¤ì¹­
            'div[class*="news"]',       // ë‰´ìŠ¤ í¬í•¨ í´ë˜ìŠ¤
            '.sds-comps-vertical-layout:has(.sds-comps-text-type-headline1)', // headline1 í¬í•¨í•œ ì»¨í…Œì´ë„ˆ
            'article',                  // HTML5 article íƒœê·¸
            '.news_wrap',               // ë‰´ìŠ¤ ë©í¼
            '.group_news > li'          // ê·¸ë£¹ ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸
        ];

        let newsItems = [];
        let bestSelector = '';
        const processedLinks = new Set(); // ì¤‘ë³µ ë§í¬ ë°©ì§€

        // ì„ íƒìë³„ë¡œ ì‹œë„í•˜ì—¬ ê°€ì¥ ì¢‹ì€ ê²°ê³¼ ì°¾ê¸°
        for (const selector of newsSelectors) {
            console.log(`ğŸ” ${targetAsset.name} ì„ íƒì ì‹œë„: ${selector}`);
            const elements = $(selector);
            console.log(`   â†’ ì°¾ì€ ìš”ì†Œ: ${elements.length}ê°œ`);
            
            if (elements.length > 0) {
                bestSelector = selector;
                console.log(`âœ… ${targetAsset.name} ìµœì  ì„ íƒì ë°œê²¬: ${selector} (${elements.length}ê°œ ìš”ì†Œ)`);
                
                // ê° ë‰´ìŠ¤ í•­ëª©ì—ì„œ ë°ì´í„° ì¶”ì¶œ
                elements.each((index, element) => {
                    if (index < Math.min(elements.length, 20) && newsItems.length < 10) { // ë” ë§ì€ ìš”ì†Œë¥¼ ì‹œë„
                        console.log(`\nğŸ“„ ${targetAsset.name} [${index + 1}] ì²˜ë¦¬ ì¤‘...`);
                        
                        const $el = $(element);
                        
                        // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì •ë³´ ì¶”ì¶œ ì‹œë„
                        let title = '', link = '', summary = '', press = '', time = '';
                        
                        // ì œëª© ì¶”ì¶œ (ì—¬ëŸ¬ ë°©ë²• ì‹œë„) - ê°œì„ ëœ ë²„ì „
                        title = $el.find('.sds-comps-text-type-headline1').text().trim() ||
                               $el.find('.news_tit').text().trim() ||
                               $el.find('a[class*="news"]').first().text().trim() ||
                               $el.find('a').first().text().trim() ||  // ğŸ¯ base-layoutì—ì„œ ì²« ë²ˆì§¸ a íƒœê·¸
                               $el.find('h2, h3').text().trim() ||
                               $el.find('.title').text().trim() ||
                               '';
                        
                        // ğŸ”¥ ì œëª© ê¸¸ì´ ì œí•œ - ë„ˆë¬´ ê¸´ ì œëª©(ì—¬ëŸ¬ ë‰´ìŠ¤ê°€ ì—°ê²°ëœ ê²½ìš°) ë°©ì§€
                        if (title && title.length > 200) {
                            // ì²« ë²ˆì§¸ ë¬¸ì¥ì´ë‚˜ ì˜ë¯¸ìˆëŠ” ë¶€ë¶„ë§Œ ì¶”ì¶œ
                            const sentences = title.split(/[.!?â€¦]|\.\.\./).filter(s => s.trim().length > 0);
                            if (sentences.length > 0) {
                                title = sentences[0].trim();
                                console.log(`   âœ‚ï¸ ì œëª© ê¸¸ì´ ì œí•œ: ${title.length}ìë¡œ ë‹¨ì¶•`);
                            } else {
                                // ë¬¸ì¥ ë¶„í• ì´ ì•ˆ ë˜ë©´ ì²« 100ìë§Œ ì‚¬ìš©
                                title = title.substring(0, 100).trim() + '...';
                                console.log(`   âœ‚ï¸ ì œëª© ê¸¸ì´ ê°•ì œ ì œí•œ: 100ì`);
                            }
                        }
                        
                        // ë§í¬ ì¶”ì¶œ
                        link = $el.find('.sds-comps-text-type-headline1').parent().attr('href') ||
                              $el.find('a[href*="news"]').first().attr('href') ||
                              $el.find('a').first().attr('href') ||
                              '';
                        
                        // ë§í¬ê°€ ìƒëŒ€ê²½ë¡œì¸ ê²½ìš° ì ˆëŒ€ê²½ë¡œë¡œ ë³€í™˜
                        if (link && link.startsWith('/')) {
                            link = 'https://search.naver.com' + link;
                        }
                        
                        // ìš”ì•½/ì„¤ëª… ì¶”ì¶œ - ê°œì„ ëœ ë²„ì „ (í†±ìŠ¤íƒ€ë‰´ìŠ¤ íŒ¨í„´ ì§€ì›)
                        summary = $el.find('.sds-comps-text-type-body1').text().trim() ||  // í†±ìŠ¤íƒ€ë‰´ìŠ¤ ì‹ ì„¤ëª… (3ì¤„ ì œí•œ)
                                 $el.find('.sds-comps-text-type-body2').text().trim() ||
                                 $el.find('.news_dsc').text().trim() ||
                                 $el.find('.dsc_txt_wrap').text().trim() ||
                                 '';
                        
                        // ğŸ¯ base-layout ìš”ì†Œì—ì„œ ì„¤ëª… ì¶”ì¶œ (ì œëª© ì œì™¸í•œ ì „ì²´ í…ìŠ¤íŠ¸)
                        if (!summary && $el.hasClass('sds-comps-base-layout')) {
                            const fullText = $el.text().trim();
                            const firstLink = $el.find('a').first();
                            const titleText = firstLink.text().trim();
                            
                            if (fullText && titleText && fullText.length > titleText.length) {
                                // ì œëª© ë¶€ë¶„ì„ ì œê±°í•˜ê³  ë‚˜ë¨¸ì§€ë¥¼ ì„¤ëª…ìœ¼ë¡œ ì‚¬ìš©
                                summary = fullText.replace(titleText, '').trim();
                                // ì‹œì‘ ë¶€ë¶„ì˜ ë¶ˆí•„ìš”í•œ ë¬¸ì ì œê±°
                                summary = summary.replace(/^[\s\n\r]+/, '').trim();
                            }
                        }
                        
                        // ì–¸ë¡ ì‚¬ ì¶”ì¶œ - ë„¤ì´ë²„ ë‰´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§€ ê¸°ì¤€ (ë²”ìš©ì  ì ‘ê·¼)
                        press = extractPressFromElement($el) || extractPressFromUrl(link) || 'ì–¸ë¡ ì‚¬ ë¯¸ìƒ';
                        
                        // ì‹œê°„ ì¶”ì¶œ - ê°œì„ ëœ ë°©ë²• (ë” ì •í™•í•œ ë²”ìœ„ì—ì„œ ì¶”ì¶œ)
                        time = extractTimeFromElement($el);
                        
                        // ì‹œê°„ì´ ì¶”ì¶œë˜ì§€ ì•Šì€ ê²½ìš° ì„¤ëª… í…ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
                        if (!time && summary) {
                            const extractedFromSummary = extractTimeFromText(summary);
                            if (extractedFromSummary) {
                                time = extractedFromSummary;
                                console.log(`   ğŸ”§ ì„¤ëª…ì—ì„œ ì‹œê°„ ì¶”ì¶œ: "${extractedFromSummary}"`);
                            }
                        }
                        
                        // ì—¬ì „íˆ ì‹œê°„ì´ ì—†ìœ¼ë©´ ì „ì²´ ìš”ì†Œ í…ìŠ¤íŠ¸ì—ì„œ ì ê·¹ ê²€ìƒ‰
                        if (!time || time === 'ì‹œê°„ ë¯¸ìƒ') {
                            const fullElementText = $el.text();
                            const extractedFromFullText = extractTimeFromText(fullElementText);
                            if (extractedFromFullText) {
                                time = extractedFromFullText;
                                console.log(`   ğŸ”§ ì „ì²´ ìš”ì†Œì—ì„œ ì‹œê°„ ì¶”ì¶œ: "${extractedFromFullText}"`);
                            } else {
                                // ğŸ”¥ ì‹œê°„ ì •ë³´ë¥¼ ì „í˜€ ì°¾ì§€ ëª»í•œ ê²½ìš°ì—ë§Œ "ì‹œê°„ ë¯¸ìƒ"ìœ¼ë¡œ ì²˜ë¦¬
                                // "ìµœê·¼"ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ 6ì‹œê°„ í•„í„°ë¥¼ ìš°íšŒí•˜ë¯€ë¡œ ìœ„í—˜í•¨
                                time = 'ì‹œê°„ ë¯¸ìƒ';
                                console.log(`   âŒ ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, "ì‹œê°„ ë¯¸ìƒ"ìœ¼ë¡œ ì²˜ë¦¬`);
                            }
                        }
                        
                        time = time || 'ì‹œê°„ ë¯¸ìƒ';
                        
                        // ì„¤ëª… í…ìŠ¤íŠ¸ í´ë¦¬ë‹ - ì¤‘ë³µëœ ì–¸ë¡ ì‚¬ëª…ê³¼ ì‹œê°„ ì •ë³´ ì œê±°
                        if (summary) {
                            const originalSummary = summary;
                            summary = cleanDescriptionText(summary, press, time);
                            if (originalSummary !== summary) {
                                console.log(`   ğŸ§¹ ì„¤ëª… í´ë¦¬ë‹: "${originalSummary.substring(0, 50)}..." -> "${summary.substring(0, 50)}..."`);
                            }
                        }
                        
                        console.log(`   ğŸ“ ì œëª©: ${title ? title.substring(0, 50) + '...' : 'âŒ ì¶”ì¶œ ì‹¤íŒ¨'}`);
                        console.log(`   ğŸ”— ë§í¬: ${link ? link.substring(0, 50) + '...' : 'âŒ ì¶”ì¶œ ì‹¤íŒ¨'}`);
                        console.log(`   ğŸ“° ì–¸ë¡ ì‚¬: ${press || 'âŒ ì¶”ì¶œ ì‹¤íŒ¨'}`);
                        console.log(`   â° ì‹œê°„: ${time || 'âŒ ì¶”ì¶œ ì‹¤íŒ¨'}`);
                        console.log(`   ğŸ“„ ì„¤ëª…: ${summary ? summary.substring(0, 100) + '...' : 'âŒ ì¶”ì¶œ ì‹¤íŒ¨'}`);

                        // í‚¤ì›Œë“œ í•„í„°ë§: ì œëª© ë˜ëŠ” ì„¤ëª…ì— ê²€ìƒ‰ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ì•¼ í•¨ (ê°œì„ ëœ ë§¤ì¹­)
                        if (title && link && !processedLinks.has(link)) { // ì¤‘ë³µ ë§í¬ ì²´í¬ ì¶”ê°€
                            processedLinks.add(link); // ë§í¬ ì¶”ê°€
                            const searchKeyword = targetAsset.name.toLowerCase();
                            const titleLower = title.toLowerCase();
                            const descLower = (summary || '').toLowerCase();
                            
                            // ì œëª©ì—ì„œë§Œ í‚¤ì›Œë“œ ê²€ìƒ‰ (ë” ì •í™•í•˜ê²Œ)
                            const titleMatch = titleLower.includes(searchKeyword);
                            
                            if (titleMatch) {
                                console.log(`âœ… ${targetAsset.name} í‚¤ì›Œë“œ í¬í•¨ í™•ì¸ (ì œëª©ì—ì„œ ë°œê²¬)`);
                                
                                const newsItem = {
                                    title: title,
                                    link: link,
                                    description: summary || 'ì„¤ëª… ì—†ìŒ',
                                    press: press || 'ì–¸ë¡ ì‚¬ ë¯¸ìƒ',
                                    time: time || 'ì‹œê°„ ë¯¸ìƒ',
                                    searchedAsset: targetAsset.name
                                };
                                
                                newsItems.push(newsItem);
                                console.log(`âœ… ${targetAsset.name} ë‰´ìŠ¤ ì•„ì´í…œ ì¶”ê°€!`);
                                
                            } else {
                                console.log(`ğŸš« ${targetAsset.name} í‚¤ì›Œë“œ ë¯¸í¬í•¨ìœ¼ë¡œ ì œì™¸ (ê²€ìƒ‰ì–´: "${searchKeyword}")`);
                            }
                        } else {
                            console.log(`âŒ í•„ìˆ˜ ì •ë³´ ë¶€ì¡±ìœ¼ë¡œ ê±´ë„ˆëœ€`);
                        }
                    }
                });
                
                // ğŸ”¥ ì¶©ë¶„í•œ ë‰´ìŠ¤ë¥¼ ì°¾ì•˜ê±°ë‚˜, ìœ íš¨í•œ ë‰´ìŠ¤ê°€ ìˆìœ¼ë©´ ê³„ì† ì‹œë„í•˜ì§€ ì•ŠìŒ
                if (newsItems.length >= 3) {
                    console.log(`âœ… ${targetAsset.name} ì¶©ë¶„í•œ ë‰´ìŠ¤ í™•ë³´ (${newsItems.length}ê°œ), ê²€ìƒ‰ ì¤‘ë‹¨`);
                    break;
                }
                // ì ì€ ìˆ˜ì˜ ë‰´ìŠ¤ë¼ë„ ìˆìœ¼ë©´ ë‹¤ìŒ ì„ íƒìë„ ì‹œë„í•´ë³¼ ìˆ˜ ìˆë„ë¡ í•¨
                console.log(`ğŸ”„ ${targetAsset.name} ë” ë§ì€ ë‰´ìŠ¤ ì°¾ê¸° ìœ„í•´ ë‹¤ìŒ ì„ íƒì ì‹œë„ (í˜„ì¬: ${newsItems.length}ê°œ)`);
            }
        }

        if (newsItems.length === 0) {
            console.log(`âŒ ${targetAsset.name} ì¶”ì¶œëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        console.log(`\n=== ${targetAsset.name}: ì´ ${newsItems.length}ê°œì˜ ë‰´ìŠ¤ ì•„ì´í…œ ì¶”ì¶œ ì™„ë£Œ ===`);

        // ğŸ”¥ ì²« ë²ˆì§¸ ë‰´ìŠ¤ë§Œ í™•ì¸í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
        let newNewsCount = 0;
        
        console.log(`\n=== ${targetAsset.name} ì²« ë²ˆì§¸ ë‰´ìŠ¤ í™•ì¸ ===`);
        
        if (newsItems.length === 0) {
            console.log(`âŒ ${targetAsset.name} ì¶”ì¶œëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        } else {
            // ì²« ë²ˆì§¸ ë‰´ìŠ¤ë§Œ í™•ì¸
            const firstNews = newsItems[0];
            console.log(`\nğŸ“„ ${targetAsset.name} ì²« ë²ˆì§¸ ë‰´ìŠ¤ í™•ì¸: ${firstNews.title.substring(0, 50)}...`);
            console.log(`   ğŸ”— ë§í¬: ${firstNews.link}`);
            console.log(`   â° ì‹œê°„: ${firstNews.time}`);
            
            // ì¤‘ë³µ ì²´í¬ (ì´ë¯¸ ë°œì†¡í–ˆëŠ”ì§€ í™•ì¸)
            const isDuplicate = isNewsAlreadySent(firstNews, currentState.newsHistory);
            console.log(`âœ… ì¤‘ë³µ ì—¬ë¶€: ${isDuplicate ? 'ì´ë¯¸ ë°œì†¡í•¨' : 'ìƒˆë¡œìš´ ë‰´ìŠ¤'}`);
            
            if (!isDuplicate) {
                // ìƒˆë¡œìš´ ë‰´ìŠ¤ ë°œê²¬! ì•Œë¦¼ ë°œì†¡
                console.log(`ğŸ‰ ${targetAsset.name} ìƒˆë¡œìš´ ë‰´ìŠ¤ ë°œê²¬!`);
                newNewsCount = 1;
                
                // ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                currentState.newsHistory.push({
                    title: firstNews.title,
                    link: firstNews.link,
                    press: firstNews.press,
                    time: firstNews.time,
                    asset: targetAsset.name,
                    sentAt: new Date().toISOString()
                });
                
                // íˆìŠ¤í† ë¦¬ í¬ê¸° ì œí•œ
                if (currentState.newsHistory.length > MAX_NEWS_HISTORY) {
                    currentState.newsHistory = currentState.newsHistory.slice(-MAX_NEWS_HISTORY);
                    console.log(`ğŸ“‹ ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬ ì •ë¦¬: ìµœëŒ€ ${MAX_NEWS_HISTORY}ê°œ ìœ ì§€`);
                }
                
                // ğŸ¯ Flex Messageë¡œ ë‰´ìŠ¤ ë°œì†¡
                await sendNewsFlexMessage(firstNews);
                
            } else {
                console.log(`ğŸ”„ ${targetAsset.name} ì²« ë²ˆì§¸ ë‰´ìŠ¤ëŠ” ì´ë¯¸ ë°œì†¡í–ˆìŒ. ë„˜ì–´ê°.`);
            }
        }
        
        console.log(`\n=== ${targetAsset.name} ì²˜ë¦¬ ê²°ê³¼ ===`);
        console.log(`ğŸ“Š ì „ì²´ ìˆ˜ì§‘: ${newsItems.length}ê°œ`);
        console.log(`ğŸ‰ ìƒˆë¡œìš´ ë‰´ìŠ¤: ${newNewsCount}ê°œ`);

    } catch (error) {
        console.error(`âŒ ${targetAsset.name} ë‰´ìŠ¤ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:`, error.message);
    }
}


// ğŸš€ ì™„ì „ ìë™í™”ëœ ìì‚° ê°€ê²© ì²´í¬ í•¨ìˆ˜ (ë°©ë²• 2: ëª…ì‹œì  í•œêµ­ ì‹œê°„ ì‚¬ìš©)
async function checkAllEnabledAssets(currentState) {
    console.log('\nğŸ“Š [ìì‚°] ì™„ì „ ìë™í™”ëœ ìì‚° ëª¨ë‹ˆí„°ë§ ì‹œì‘...');
    
    // í™œì„±í™”ëœ ìì‚°ë§Œ ê°€ì ¸ì˜¤ê¸°
    const enabledAssets = getEnabledAssets();
    
    if (enabledAssets.length === 0) {
        console.log('âš ï¸ í™œì„±í™”ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤. ìì‚° ëª¨ë‹ˆí„°ë§ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
        return;
    }
    
    // âœ… ë°©ë²• 2: ëª…ì‹œì ìœ¼ë¡œ í•œêµ­ ì‹œê°„ ì‚¬ìš©
    const now = new Date();
    const kstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
    const todayStr = kstNow.toISOString().split('T')[0];
    const currentHour = kstNow.getHours();

    for (const asset of enabledAssets) {
        console.log(`\nâ–¶ ${asset.name} (${asset.type}) ìë™ ëª¨ë‹ˆí„°ë§ ì¤‘...`);
        console.log(`   ê²€ìƒ‰ì–´: "${asset.query}"`);
        console.log(`   ê¸‰ë“±ë½: Â±${asset.spikeThreshold}%, ì¶”ì„¸ì´íƒˆ: Â±${asset.trendThreshold}%`);
        
        if (asset.type === 'stock' && !isKoreanBusinessDay()) {
        console.log(`-> ğŸš« ${asset.name}: ì£¼ë§/ê³µíœ´ì¼ë¡œ ì¸í•´ ì£¼ì‹ ì•Œë¦¼ ì œì™¸`);
        continue;
    }


        const url = `https://search.naver.com/search.naver?query=${encodeURIComponent(asset.query)}`;
        const html = await fetchWithCurl(url, { isJson: false });
        if (!html) { 
            console.log('-> âŒ HTMLì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); 
            continue; 
        }
        
        const $ = cheerio.load(html);
        
        // ğŸš€ ìë™ ê°€ê²© íŒŒì‹± ì‹œë„
        const currentPrice = parsePrice($, asset);
        if (currentPrice === null) {
            console.log(`-> âŒ ${asset.name} ê°€ê²© íŒŒì‹± ì‹¤íŒ¨`);
            continue;
        }
        
        console.log(`-> âœ… ${asset.name} í˜„ì¬ê°€: ${currentPrice.toLocaleString()}ì›`);
        
        // ìì‚° ìƒíƒœ ìë™ ì´ˆê¸°í™” ë° ì—…ë°ì´íŠ¸
        if (!currentState.assetStates[asset.name]) {
            currentState.assetStates[asset.name] = { 
                priceHistory: [], 
                lastAlertPrice: 0, 
                lastReportPrice: 0, 
                wasInDeviation: false, 
                lastTrendAlertTime: 0,      // ğŸ”¥ ì¶”ê°€: ë§ˆì§€ë§‰ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ ì‹œê°„
                lastTrendAlertPrice: 0,     // ğŸ”¥ ì¶”ê°€: ë§ˆì§€ë§‰ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ ê°€ê²©
                trendAlertDirection: null,  // ğŸ”¥ ì¶”ê°€: ë§ˆì§€ë§‰ ì¶”ì„¸ì´íƒˆ ë°©í–¥ ('up' ë˜ëŠ” 'down')
                openingPrice: 0, 
                openingPriceDate: '',
                addedDate: new Date().toISOString(),
                totalAlerts: 0,
                lastUpdate: null
            };
            console.log(`ğŸ†• ${asset.name} ìƒíƒœ ìë™ ìƒì„±`);
        }
        
        const assetState = currentState.assetStates[asset.name];
        assetState.lastUpdate = new Date().toISOString();
        
        const marketOpenHour = asset.type === 'stock' ? 9 : 0;
        
        // âœ… ìˆ˜ì •: ê°™ì€ ì‹œê°„ëŒ€ ê¸°ì¤€ìœ¼ë¡œ í†µì¼ (í•œêµ­ ì‹œê°„)
        if (assetState.openingPriceDate !== todayStr && currentHour >= marketOpenHour) {
            assetState.openingPrice = currentPrice;
            assetState.openingPriceDate = todayStr;
            console.log(`-> ğŸ“ˆ ${asset.name} ê¸ˆì¼ ì‹œê°€(${currentPrice.toLocaleString()}ì›) ìë™ ê¸°ë¡ (${currentHour}ì‹œ)`);
        }
        
        assetState.priceHistory.push(currentPrice);
       if (assetState.priceHistory.length > MA_PERIOD) { 
           assetState.priceHistory.shift(); 
       }
       
       // ğŸ¯ ë¶„ì„ 1: ì§ì „ ê°€ê²© ëŒ€ë¹„ ê¸‰ë“±ë½ (ë°ì´í„° 2ê°œë§Œ ìˆì–´ë„ ë¶„ì„ ê°€ëŠ¥)
       let spikePercent = 0;
       let canAnalyzeSpike = false;
       
       if (assetState.priceHistory.length >= 2) {
           // ì§ì „ ê°€ê²©ê³¼ ë¹„êµ
           const prevPrice = assetState.priceHistory[assetState.priceHistory.length - 2];
           spikePercent = ((currentPrice - prevPrice) / prevPrice) * 100;
           canAnalyzeSpike = true;
           console.log(`-> ğŸ“Š ì§ì „ ê°€ê²© ëŒ€ë¹„: ${prevPrice.toLocaleString()}ì› â†’ ${currentPrice.toLocaleString()}ì› (${spikePercent > 0 ? '+' : ''}${spikePercent.toFixed(2)}%)`);
       } else if (assetState.lastAlertPrice > 0) {
           // ë§ˆì§€ë§‰ ì•Œë¦¼ ê°€ê²©ê³¼ ë¹„êµ (ìµœì´ˆ ë°ì´í„°ì¼ ë•Œ)
           spikePercent = ((currentPrice - assetState.lastAlertPrice) / assetState.lastAlertPrice) * 100;
           canAnalyzeSpike = true;
           console.log(`-> ğŸ“Š ì´ì „ ì•Œë¦¼ê°€ ëŒ€ë¹„: ${assetState.lastAlertPrice.toLocaleString()}ì› â†’ ${currentPrice.toLocaleString()}ì› (${spikePercent > 0 ? '+' : ''}${spikePercent.toFixed(2)}%)`);
       } else {
           console.log(`-> ğŸ“Š ì§ì „ ê°€ê²© ë¹„êµ: ë°ì´í„° ë¶€ì¡± (${assetState.priceHistory.length}/2)`);
       }
       
       // ğŸ¯ ë¶„ì„ 2: ì´ë™í‰ê·  ëŒ€ë¹„ ì¶”ì„¸ ì´íƒˆ (ì¶©ë¶„í•œ ë°ì´í„° í•„ìš”)
       let deviationPercent = 0;
       let canAnalyzeTrend = false;
       let actualPeriod = 0;
       
       const minDataForTrend = Math.min(10, MA_PERIOD);  // ì¶”ì„¸ ë¶„ì„ì€ ìµœì†Œ 10ê°œ í•„ìš”
       if (assetState.priceHistory.length >= minDataForTrend) {
           actualPeriod = Math.min(assetState.priceHistory.length, MA_PERIOD);
           const recentPrices = assetState.priceHistory.slice(-actualPeriod);
           const movingAverage = recentPrices.reduce((a, b) => a + b, 0) / actualPeriod;
           deviationPercent = ((currentPrice - movingAverage) / movingAverage) * 100;
           canAnalyzeTrend = true;
           
           console.log(`-> ğŸ“Š ${actualPeriod}ë¶„ ì´ë™í‰ê· : ${movingAverage.toFixed(2)}ì›`);
           console.log(`-> ğŸ“Š í‰ê·  ì´íƒˆë¥ : ${deviationPercent > 0 ? '+' : ''}${deviationPercent.toFixed(2)}% (ì„ê³„ê°’: Â±${asset.trendThreshold}%)`);
       } else {
           console.log(`-> ğŸ“Š ì¶”ì„¸ ë¶„ì„: ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (${assetState.priceHistory.length}/${minDataForTrend})`);
       }
       
       // ë¶„ì„ ê°€ëŠ¥ ì—¬ë¶€ í‘œì‹œ
       console.log(`-> ğŸ¯ ë¶„ì„ ê°€ëŠ¥: ê¸‰ë“±ë½ ${canAnalyzeSpike ? 'âœ…' : 'âŒ'}, ì¶”ì„¸ì´íƒˆ ${canAnalyzeTrend ? 'âœ…' : 'âŒ'}`);
       
       if (!canAnalyzeSpike && !canAnalyzeTrend) {
           console.log(`-> â³ ë¶„ì„ ëŒ€ê¸° ì¤‘... ê¸‰ë“±ë½ê¹Œì§€ ${Math.max(0, 2 - assetState.priceHistory.length)}ë¶„, ì¶”ì„¸ë¶„ì„ê¹Œì§€ ${Math.max(0, minDataForTrend - assetState.priceHistory.length)}ë¶„`);
           continue;
       };
       
       // ğŸ¯ ì•Œë¦¼ ì¡°ê±´ ì²´í¬: ë‘ ê°€ì§€ ë¶„ì„ ëª¨ë‘ í™•ì¸
       let alertReason = null;
       let alertEmoji = '';
       let wasInDeviation = assetState.wasInDeviation || false;
       
       // ğŸš€ ë©‹ì§„ ë‹¨ê³„ë³„ ì´ëª¨ì§€ í•¨ìˆ˜ (ì„íŒ©íŠ¸ & ì—ë„ˆì§€ ê°•í™”)
       function getEmojiByPercent(percent, isSpike = false) {
           const absPercent = Math.abs(percent);
           
           if (percent > 0) {
               // ğŸ”¥ ìƒìŠ¹ ì´ëª¨ì§€ (ì„íŒ©íŠ¸ & ì—ë„ˆì§€ ê°•í™”)
               if (absPercent >= 15) return 'ğŸš€';    // 15% ì´ìƒ ì´ˆëŒ€í˜• í­ë“±
               if (absPercent >= 10) return 'ğŸš€';    // 10% ì´ìƒ ëŒ€í­ë“±
               if (absPercent >= 7) return 'ğŸ”¥';     // 7% ì´ìƒ í­ë“±
               if (absPercent >= 5) return 'âš¡';     // 5% ì´ìƒ ê¸‰ë“±
               if (absPercent >= 3) return 'ğŸ’';     // 3% ì´ìƒ ìƒìŠ¹
               if (absPercent >= 1) return 'âœ¨';     // 1% ì´ìƒ ì†Œí­ìƒìŠ¹
               return 'ğŸŒŸ';                             // 1% ë¯¸ë§Œ ë¯¸ì„¸ìƒìŠ¹ (ë³„)
           } else {
               // ğŸ’€ í•˜ë½ ì´ëª¨ì§€ (ì„íŒ©íŠ¸ & ê¸´ì¥ê° ê°•í™”)
               if (absPercent >= 15) return 'ğŸ’€';    // 15% ì´ìƒ ì´ˆëŒ€í˜• í­ë½
               if (absPercent >= 10) return 'ğŸ’€';    // 10% ì´ìƒ ëŒ€í­ë½
               if (absPercent >= 7) return 'âš ï¸';     // 7% ì´ìƒ í­ë½
               if (absPercent >= 5) return 'ğŸ’¥';     // 5% ì´ìƒ ê¸‰ë½
               if (absPercent >= 3) return 'â„ï¸';     // 3% ì´ìƒ í•˜ë½
               if (absPercent >= 1) return 'ğŸ˜°';     // 1% ì´ìƒ ì†Œí­í•˜ë½
               return 'ğŸ˜”';                             // 1% ë¯¸ë§Œ ë¯¸ì„¸í•˜ë½ (ì•„ì‰¬ì›€)
           }
       }
       
       // 1. ê¸‰ë“±ë½ ì²´í¬ (ì§ì „ ê°€ê²© ëŒ€ë¹„)
       if (canAnalyzeSpike && Math.abs(spikePercent) >= asset.spikeThreshold) {
           alertEmoji = getEmojiByPercent(spikePercent, true);
           if (spikePercent > 0) {
               // ìƒìŠ¹ ë‹¨ê³„ë³„ í‘œí˜„
               const absPercent = Math.abs(spikePercent);
               if (absPercent >= 10) alertReason = `ğŸ”¥ ëŒ€í­ë“± (+${spikePercent.toFixed(2)}%)`;
               else if (absPercent >= 7) alertReason = `í­ë“± (+${spikePercent.toFixed(2)}%)`;
               else if (absPercent >= 5) alertReason = `ê¸‰ë“± (+${spikePercent.toFixed(2)}%)`;
               else if (absPercent >= 3) alertReason = `ìƒìŠ¹ (+${spikePercent.toFixed(2)}%)`;
               else alertReason = `ì†Œí­ìƒìŠ¹ (+${spikePercent.toFixed(2)}%)`;
           } else {
               // í•˜ë½ ë‹¨ê³„ë³„ í‘œí˜„
               const absPercent = Math.abs(spikePercent);
               if (absPercent >= 10) alertReason = `ğŸ’€ ëŒ€í­ë½ (${spikePercent.toFixed(2)}%)`;
               else if (absPercent >= 7) alertReason = `í­ë½ (${spikePercent.toFixed(2)}%)`;
               else if (absPercent >= 5) alertReason = `ê¸‰ë½ (${spikePercent.toFixed(2)}%)`;
               else if (absPercent >= 3) alertReason = `í•˜ë½ (${spikePercent.toFixed(2)}%)`;
               else alertReason = `ì†Œí­í•˜ë½ (${spikePercent.toFixed(2)}%)`;
           }
       }
       // 2. ğŸ”¥ ìˆ˜ì •ëœ ì¶”ì„¸ ì´íƒˆ ì²´í¬ (ì´ë™í‰ê·  ëŒ€ë¹„) - ê°€ê²© ê¸°ì¤€ ì¬ì•Œë¦¼ ë°©ì‹
       else if (canAnalyzeTrend) {
           const isInDeviation = Math.abs(deviationPercent) >= asset.trendThreshold;
           const currentDirection = deviationPercent > 0 ? 'up' : 'down';
           
           console.log(`-> ğŸ¯ ì¶”ì„¸ì´íƒˆ ìƒíƒœ: ${isInDeviation ? 'ì´íƒˆì¤‘' : 'ì •ìƒ'}`);
           console.log(`-> ğŸ“Š í˜„ì¬ ê°€ê²©: ${currentPrice}, ë§ˆì§€ë§‰ ì•Œë¦¼ ê°€ê²©: ${assetState.lastTrendAlertPrice || 'ì—†ìŒ'}`);
           console.log(`-> ğŸ”„ ë§ˆì§€ë§‰ ì•Œë¦¼ ë°©í–¥: ${assetState.trendAlertDirection || 'ì—†ìŒ'}, í˜„ì¬ ë°©í–¥: ${currentDirection}`);
           
           let shouldAlert = false;
           
           if (isInDeviation) {
               // ì²« ë²ˆì§¸ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ (ì•„ì§ ì•Œë¦¼ì´ ì—†ì—ˆë˜ ê²½ìš°)
               if (!assetState.lastTrendAlertPrice || !assetState.trendAlertDirection) {
                   shouldAlert = true;
                   console.log(`-> ğŸ†• ì²« ë²ˆì§¸ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ ì¡°ê±´ ì¶©ì¡±`);
               }
               // ë°©í–¥ì´ ë°”ë€ ê²½ìš° (ìƒìŠ¹ -> í•˜ë½ ë˜ëŠ” í•˜ë½ -> ìƒìŠ¹)
               else if (assetState.trendAlertDirection !== currentDirection) {
                   shouldAlert = true;
                   console.log(`-> ğŸ”„ ì¶”ì„¸ ë°©í–¥ ë³€ê²½: ${assetState.trendAlertDirection} -> ${currentDirection}`);
               }
               // ê°™ì€ ë°©í–¥ì´ì§€ë§Œ ê¸°ì¤€ ê°€ê²©ì„ ë” ì´ˆê³¼í•œ ê²½ìš°
               else if (assetState.trendAlertDirection === currentDirection) {
                   const priceChangeFromLastAlert = ((currentPrice - assetState.lastTrendAlertPrice) / assetState.lastTrendAlertPrice) * 100;
                   const absChangeFromLastAlert = Math.abs(priceChangeFromLastAlert);
                   
                   // ë§ˆì§€ë§‰ ì•Œë¦¼ ê°€ê²©ì—ì„œ ì¶”ê°€ë¡œ trendThreshold% ì´ìƒ ë³€ë™í•œ ê²½ìš°
                   if (absChangeFromLastAlert >= asset.trendThreshold) {
                       shouldAlert = true;
                       console.log(`-> ğŸ“ˆ ê¸°ì¤€ê°€ê²© ì¶”ê°€ ì´ˆê³¼: ${priceChangeFromLastAlert.toFixed(2)}% (ê¸°ì¤€: ${asset.trendThreshold}%)`);
                   } else {
                       console.log(`-> ğŸ”‡ ê¸°ì¤€ê°€ê²© ë¯¸ë‹¬: ${priceChangeFromLastAlert.toFixed(2)}% < ${asset.trendThreshold}%`);
                   }
               }
           }
           
           if (shouldAlert) {
               alertEmoji = getEmojiByPercent(deviationPercent, false);
               if (deviationPercent > 0) {
                   const absPercent = Math.abs(deviationPercent);
                   if (absPercent >= 10) alertReason = `ğŸ”¥ ëŒ€ìƒìŠ¹ ì¶”ì„¸ì´íƒˆ (+${deviationPercent.toFixed(2)}%)`;
                   else if (absPercent >= 7) alertReason = `ê°•ìƒìŠ¹ ì¶”ì„¸ì´íƒˆ (+${deviationPercent.toFixed(2)}%)`;
                   else if (absPercent >= 5) alertReason = `ìƒìŠ¹ ì¶”ì„¸ì´íƒˆ (+${deviationPercent.toFixed(2)}%)`;
                   else alertReason = `ìƒìŠ¹ ì¶”ì„¸ì´íƒˆ (+${deviationPercent.toFixed(2)}%)`;
               } else {
                   const absPercent = Math.abs(deviationPercent);
                   if (absPercent >= 10) alertReason = `ğŸ’€ ëŒ€í•˜ë½ ì¶”ì„¸ì´íƒˆ (${deviationPercent.toFixed(2)}%)`;
                   else if (absPercent >= 7) alertReason = `ê°•í•˜ë½ ì¶”ì„¸ì´íƒˆ (${deviationPercent.toFixed(2)}%)`;
                   else if (absPercent >= 5) alertReason = `í•˜ë½ ì¶”ì„¸ì´íƒˆ (${deviationPercent.toFixed(2)}%)`;
                   else alertReason = `í•˜ë½ ì¶”ì„¸ì´íƒˆ (${deviationPercent.toFixed(2)}%)`;
               }
               
               // ì•Œë¦¼ ê¸°ì¤€ ê°€ê²©ê³¼ ë°©í–¥ ì—…ë°ì´íŠ¸
               assetState.lastTrendAlertTime = Date.now();
               assetState.lastTrendAlertPrice = currentPrice;
               assetState.trendAlertDirection = currentDirection;
               console.log(`-> ğŸš¨ ì¶”ì„¸ì´íƒˆ ì•Œë¦¼ ì¡°ê±´ ì¶©ì¡±! ê¸°ì¤€ ê°€ê²© ${currentPrice}ìœ¼ë¡œ ì—…ë°ì´íŠ¸`);
           }
           
           assetState.wasInDeviation = isInDeviation;
       }
       
       if (alertReason) {
           console.log(`-> ğŸš¨ ${asset.name} ì•Œë¦¼ ì¡°ê±´ ì¶©ì¡±! ì‚¬ìœ : ${alertReason}`);
           
           // ğŸš€ ìë™ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
           const typeIcon = asset.type === 'crypto' ? 'â‚¿' : 'ğŸ“ˆ';
           let analysisInfo = '';
           
           if (canAnalyzeSpike && canAnalyzeTrend) {
               analysisInfo = `ë¶„ì„: ê¸‰ë“±ë½âœ… + ì¶”ì„¸ì´íƒˆâœ… (${actualPeriod}ë¶„ ê¸°ì¤€)`;
           } else if (canAnalyzeSpike) {
               analysisInfo = `ë¶„ì„: ê¸‰ë“±ë½âœ… (ì¶”ì„¸ë¶„ì„ ëŒ€ê¸°ì¤‘)`;
           } else if (canAnalyzeTrend) {
               analysisInfo = `ë¶„ì„: ì¶”ì„¸ì´íƒˆâœ… (${actualPeriod}ë¶„ ê¸°ì¤€)`;
           }
           
           // âœ… Flex Messageë¡œ ê¸‰ë“±ë½ ì•Œë¦¼ ì „ì†¡
           await sendPriceAlertFlexMessage(asset, currentPrice, alertReason, alertEmoji, analysisInfo);
           
           assetState.lastAlertPrice = currentPrice;
           assetState.totalAlerts = (assetState.totalAlerts || 0) + 1;
           
           console.log(`-> âœ… ${asset.name} ê¸‰ë“±ë½ Flex ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ (ì´ ${assetState.totalAlerts}íšŒì§¸)`);
       } else {
           console.log(`-> â¡ï¸ ${asset.name} ë³€ë™ì„± ê¸°ì¤€ ë¯¸ë‹¬`);
           if (canAnalyzeSpike) {
               console.log(`   ê¸‰ë“±ë½: ${Math.abs(spikePercent).toFixed(2)}% < ${asset.spikeThreshold}%`);
           }
           if (canAnalyzeTrend) {
               console.log(`   ì¶”ì„¸ì´íƒˆ: ${Math.abs(deviationPercent).toFixed(2)}% < ${asset.trendThreshold}%`);
           }
       }
   }
}

// ğŸ”¥ ìˆ˜ì •ëœ ìë™ ì •ê¸° ë¦¬í¬íŠ¸ - Flex Message í˜•íƒœë¡œ ì „ì†¡
async function sendAutoPeriodicReport(currentState) {
   console.log('\nğŸ“‹ [ì •ê¸° ë¦¬í¬íŠ¸] í˜ì´ì½”ì¸ ê¸‰ë“±ë½ ê¸°ì¤€ìœ¼ë¡œ ë³€ë™ ì²´í¬ ì¤‘...');
   
   // í™œì„±í™”ëœ ìì‚°ë§Œ ê°€ì ¸ì˜¤ê¸°
   const enabledAssets = getEnabledAssets();
   
   if (enabledAssets.length === 0) {
       console.log('[ì •ê¸° ë¦¬í¬íŠ¸] í™œì„±í™”ëœ ìì‚°ì´ ì—†ì–´ ë¦¬í¬íŠ¸ë¥¼ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
       return;
   }
   
   // ğŸ¯ í˜ì´ì½”ì¸ ì„¤ì • ì°¾ê¸°
   const paycoinAsset = ASSETS_TO_WATCH.find(asset => asset.name === 'í˜ì´ì½”ì¸');
   if (!paycoinAsset) {
       console.log('[ì •ê¸° ë¦¬í¬íŠ¸] âš ï¸ í˜ì´ì½”ì¸ ì„¤ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„ê³„ê°’(1.0%)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
   }
   // ğŸ”¥ ì£¼ì‹ ìì‚° í•„í„°ë§ (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸)
   const filteredAssets = enabledAssets.filter(asset => {
       if (asset.type === 'stock' && !isKoreanBusinessDay()) {
           console.log(`[ì •ê¸° ë¦¬í¬íŠ¸] ğŸš« ${asset.name}: ì£¼ë§/ê³µíœ´ì¼ë¡œ ì¸í•´ ë¦¬í¬íŠ¸ì—ì„œ ì œì™¸`);
           return false;
       }
       return true;
   });
   
   if (filteredAssets.length === 0) {
       console.log('[ì •ê¸° ë¦¬í¬íŠ¸] ì£¼ë§/ê³µíœ´ì¼ë¡œ ì¸í•´ ëª¨ë“  ìì‚°ì´ ì œì™¸ë˜ì–´ ë¦¬í¬íŠ¸ë¥¼ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
       return;
   }
   const reportThreshold = paycoinAsset ? paycoinAsset.spikeThreshold : 1.0; // í˜ì´ì½”ì¸ì˜ ê¸‰ë“±ë½ ì„ê³„ê°’ ì‚¬ìš©
   console.log(`[ì •ê¸° ë¦¬í¬íŠ¸] ğŸ“Š ë³€ë™ ê¸°ì¤€: Â±${reportThreshold}% (í˜ì´ì½”ì¸ ê¸‰ë“±ë½ ì„¤ì •ê°’ ê¸°ì¤€)`);
   
   // ğŸ¯ ìŠ¤ë§ˆíŠ¸ ë¦¬í¬íŠ¸ ì¡°ê±´: ì§ì „ ì •ê¸° ë¦¬í¬íŠ¸ ê°€ê²©ê³¼ í˜„ì¬ ê°€ê²© ë¹„êµ
   let shouldSendReport = false;
   let changeReasons = [];
   let reportPrices = {}; // ì´ë²ˆ ë¦¬í¬íŠ¸ì—ì„œ ì‚¬ìš©í•  ê°€ê²©ë“¤ ì €ì¥
   
   for (const asset of enabledAssets) {
       const assetState = currentState.assetStates[asset.name];
       
       if (assetState && assetState.priceHistory.length > 0) {
           // í˜„ì¬ ì‹¤ì œ ê°€ê²© (ê°€ì¥ ìµœì‹  ê°€ê²©)
           const currentPrice = assetState.priceHistory[assetState.priceHistory.length - 1];
           
           // ì§ì „ ì •ê¸° ë¦¬í¬íŠ¸ì—ì„œ ì‚¬ìš©ëœ ê°€ê²© (lastReportPrice)
           const lastReportPrice = assetState.lastReportPrice || 0;
           
           console.log(`-> ${asset.name}: í˜„ì¬ê°€ ${currentPrice.toLocaleString()}ì›, ì§ì „ ë¦¬í¬íŠ¸ê°€ ${lastReportPrice.toLocaleString()}ì›`);
           
           // ì§ì „ ì •ê¸° ë¦¬í¬íŠ¸ ê°€ê²©ê³¼ ë¹„êµ (í˜ì´ì½”ì¸ ê¸‰ë“±ë½ í¼ì„¼íŠ¸ ê¸°ì¤€)
           if (lastReportPrice > 0) {
               const changeFromLastReport = ((currentPrice - lastReportPrice) / lastReportPrice) * 100;
               console.log(`   ë³€ë™ë¥ : ${changeFromLastReport > 0 ? '+' : ''}${changeFromLastReport.toFixed(2)}% (ê¸°ì¤€: Â±${reportThreshold}%)`);
               
               if (Math.abs(changeFromLastReport) >= reportThreshold) {
                   shouldSendReport = true;
                   changeReasons.push(`${asset.name} ${changeFromLastReport > 0 ? '+' : ''}${changeFromLastReport.toFixed(2)}%`);
                   console.log(`   âœ… ë³€ë™ ê¸°ì¤€ ì¶©ì¡±!`);
               } else {
                   console.log(`   â¡ï¸ ë³€ë™ ê¸°ì¤€ ë¯¸ë‹¬`);
               }
           } else {
               // ì²« ë²ˆì§¸ ë¦¬í¬íŠ¸ì¸ ê²½ìš° ë¬´ì¡°ê±´ ë°œì†¡
               shouldSendReport = true;
               changeReasons.push(`${asset.name} ì²« ë¦¬í¬íŠ¸`);
               console.log(`   ğŸ†• ì²« ë¦¬í¬íŠ¸ - ë¬´ì¡°ê±´ ë°œì†¡`);
           }
           
           // ì´ë²ˆ ë¦¬í¬íŠ¸ì—ì„œ ì‚¬ìš©í•  ê°€ê²© ì €ì¥
           reportPrices[asset.name] = currentPrice;
       }
   }
   
   if (!shouldSendReport) {
       console.log(`[ì •ê¸° ë¦¬í¬íŠ¸] í˜ì´ì½”ì¸ ê¸‰ë“±ë½ ê¸°ì¤€(Â±${reportThreshold}%) ë¯¸ë‹¬ë¡œ ë¦¬í¬íŠ¸ë¥¼ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
       return;
   }
   
   console.log(`[ì •ê¸° ë¦¬í¬íŠ¸] ğŸ¯ ë³€ë™ ê°ì§€ (ê¸°ì¤€: Â±${reportThreshold}%): ${changeReasons.join(', ')}`);
   
   // ğŸš€ Flex Message í˜•íƒœë¡œ ë¦¬í¬íŠ¸ ìƒì„±
   const flexContents = [];
   let hasPrice = false;
   
   // í•œêµ­ ì‹œê°„ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
   const now = new Date();
   const kstTime = now.toLocaleString('ko-KR', {
       timeZone: 'Asia/Seoul',
       year: 'numeric',
       month: 'numeric',
       day: 'numeric',
       hour: 'numeric',
       minute: 'numeric',
       second: 'numeric',
       hour12: true
   });
   
   for (const asset of enabledAssets) {
       const assetState = currentState.assetStates[asset.name];
       if (assetState && assetState.priceHistory.length > 0) {
           // í˜„ì¬ ì‹¤ì œ ê°€ê²© ì‚¬ìš© (60ë¶„ í‰ê· ì´ ì•„ë‹˜)
           const currentPrice = reportPrices[asset.name];
           const lastReportPrice = assetState.lastReportPrice || 0;
           
           // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë‚ ì§œ ê³„ì‚°
           const kstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
           const todayStr = kstNow.toISOString().split('T')[0];
           const openingPrice = assetState.openingPriceDate === todayStr ? assetState.openingPrice : null;
           
           let changeTexts = [];
           let statusEmoji = 'ğŸŸ¢'; // ê¸°ë³¸ê°’
           
           // ì§ì „ ì •ê¸° ë¦¬í¬íŠ¸ ëŒ€ë¹„ ë³€ë™ë¥  ë° ì´ëª¨ì§€ ê²°ì • (ìƒìŠ¹ ë¹¨ê°•, í•˜ë½ íŒŒë‘)
           if (lastReportPrice > 0) {
               const changeFromLastReport = ((currentPrice - lastReportPrice) / lastReportPrice) * 100;
               if (Math.abs(changeFromLastReport) > 0.01) {
                   changeTexts.push(`ë¦¬í¬íŠ¸: ${changeFromLastReport > 0 ? '+' : ''}${changeFromLastReport.toFixed(2)}%`);
                   
                   // ğŸš€ ë©‹ì§„ ë³€ë™ë¥  ì´ëª¨ì§€ (ì„íŒ©íŠ¸ ê°•í™”)
                   const absPercent = Math.abs(changeFromLastReport);
                   if (changeFromLastReport > 0) {
                       // ğŸ”¥ ìƒìŠ¹ ì´ëª¨ì§€ (ì—ë„ˆì§€ & ì„íŒ©íŠ¸)
                       if (absPercent >= 15) statusEmoji = 'ğŸš€';      // 15% ì´ìƒ ì´ˆëŒ€í˜• í­ë“±
                       else if (absPercent >= 10) statusEmoji = 'ğŸš€'; // 10% ì´ìƒ ëŒ€í­ë“±
                       else if (absPercent >= 7) statusEmoji = 'ğŸ”¥';  // 7% ì´ìƒ í­ë“±  
                       else if (absPercent >= 5) statusEmoji = 'âš¡';  // 5% ì´ìƒ ê¸‰ë“±
                       else if (absPercent >= 3) statusEmoji = 'ğŸ’';  // 3% ì´ìƒ ìƒìŠ¹
                       else if (absPercent >= 1) statusEmoji = 'âœ¨';  // 1% ì´ìƒ ì†Œí­ìƒìŠ¹
                       else statusEmoji = 'ğŸŒŸ';                         // 1% ë¯¸ë§Œ ë¯¸ì„¸ìƒìŠ¹
                   } else {
                       // ğŸ’€ í•˜ë½ ì´ëª¨ì§€ (ê¸´ì¥ê° & ì„íŒ©íŠ¸)
                       if (absPercent >= 15) statusEmoji = 'ğŸ’€';      // 15% ì´ìƒ ì´ˆëŒ€í˜• í­ë½
                       else if (absPercent >= 10) statusEmoji = 'ğŸ’€'; // 10% ì´ìƒ ëŒ€í­ë½
                       else if (absPercent >= 7) statusEmoji = 'âš ï¸';  // 7% ì´ìƒ í­ë½
                       else if (absPercent >= 5) statusEmoji = 'ğŸ’¥';  // 5% ì´ìƒ ê¸‰ë½
                       else if (absPercent >= 3) statusEmoji = 'â„ï¸';  // 3% ì´ìƒ í•˜ë½
                       else if (absPercent >= 1) statusEmoji = 'ğŸ˜°';  // 1% ì´ìƒ ì†Œí­í•˜ë½
                       else statusEmoji = 'ğŸ˜”';                         // 1% ë¯¸ë§Œ ë¯¸ì„¸í•˜ë½
                   }
               }
           }
           
           // ì‹œê°€ ëŒ€ë¹„ ë³€ë™ë¥  (ì°¸ê³ ìš©)
           if (openingPrice) {
               const changeFromOpen = ((currentPrice - openingPrice) / openingPrice) * 100;
               if (Math.abs(changeFromOpen) > 0.01) {
                   changeTexts.push(`ì‹œê°€: ${changeFromOpen > 0 ? '+' : ''}${changeFromOpen.toFixed(2)}%`);
               }
           }
           
           const changeString = changeTexts.length > 0 ? ` (${changeTexts.join(', ')})` : '';
           
           // Flex Message ì½˜í…ì¸ ì— ì¶”ê°€
           flexContents.push({
               "type": "text",
               "text": `${statusEmoji} ${asset.name}: ${currentPrice.toLocaleString()}ì›${changeString}`,
               "wrap": true,
               "size": "sm",
               "color": "#222222"
           });
           
           hasPrice = true;
           
           // ì´ë²ˆ ë¦¬í¬íŠ¸ ê°€ê²©ì„ lastReportPriceì— ì €ì¥
           assetState.lastReportPrice = currentPrice;
       }
   }
   
   if (hasPrice) {
       // êµ¬ë¶„ì„ ê³¼ ì‹œê°„ ì¶”ê°€
       flexContents.push({
           "type": "separator",
           "margin": "md"
       });
       
       flexContents.push({
           "type": "text",
           "text": `â° ${kstTime}`,
           "size": "xs",
           "color": "#888888",
           "align": "end"
       });
       
       // ğŸ¯ Flex Message êµ¬ì¡° ìƒì„±
       const flexMessage = {
           "content": {
               "type": "flex",
               "altText": `ğŸ”” ì •ê¸° ì‹œì„¸ ë¦¬í¬íŠ¸ (ë³€ë™ê¸°ì¤€: Â±${reportThreshold}%)`,
               "contents": {
                   "type": "bubble",
                   "size": "mega",
                   "header": {
                       "type": "box",
                       "layout": "vertical",
                       "contents": [
                           {
                               "type": "text",
                               "text": "ğŸ”” ì •ê¸° ì‹œì„¸ ë¦¬í¬íŠ¸",
                               "weight": "bold",
                               "size": "lg",
                               "color": "#FFFFFF"
                           },
                           {
                               "type": "text",
                               "text": `ë³€ë™ê¸°ì¤€: Â±${reportThreshold}%`,
                               "size": "sm",
                               "color": "#E0E0E0"
                           }
                       ],
                       "backgroundColor": "#0E71EB",
                       "paddingAll": "15px"
                   },
                   "body": {
                       "type": "box",
                       "layout": "vertical",
                       "spacing": "md",
                       "contents": flexContents
                   }
               }
           }
       };

       // JSON í˜•íƒœë¡œ ì „ì†¡ (ë„¤ì´ë²„ì›ìŠ¤ì—ì„œ Flex Message ì§€ì›í•˜ëŠ” ê²½ìš°)
       await sendFlexNotification(flexMessage);
       console.log('[ì •ê¸° ë¦¬í¬íŠ¸] Flex Message í˜•íƒœë¡œ ë¦¬í¬íŠ¸ ì „ì†¡ ì™„ë£Œ');
       console.log(`[ì •ê¸° ë¦¬í¬íŠ¸] ê° ìì‚°ì˜ lastReportPrice ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
   } else {
       console.log('[ì •ê¸° ë¦¬í¬íŠ¸] ì „ì†¡í•  ì‹œì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
   }
}

// --- 4. ë©”ì¸ ì‹¤í–‰ ë¡œì§ (Main Execution) ---
async function runAllChecks() {
   // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
   if (isRunning) {
       console.log('âš ï¸ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ ì‹¤í–‰ì„ ë°©ì§€í•©ë‹ˆë‹¤.');
       return;
   }
   
   isRunning = true;
   
   try {
       console.log(`\n===== [${new Date().toLocaleString()}] ğŸš€ ì™„ì „ ìë™í™” ëª¨ë‹ˆí„°ë§ ì‹œì‘ =====`);
       
       // í™œì„±í™”ëœ ìì‚° ìƒíƒœ í‘œì‹œ
       const enabledAssets = getEnabledAssets();
       console.log(`ğŸ¯ ìë™ ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ: ${enabledAssets.map(a => `${a.name}(${a.type})`).join(', ')}`);
       
       const currentState = readState();
       const now = new Date().getTime();
       const timeSinceLastReport = (now - (currentState.lastPeriodicReportTime || 0)) / (1000 * 60);
       
       if (!currentState.lastPeriodicReportTime || timeSinceLastReport >= PERIODIC_REPORT_INTERVAL) {
           await sendAutoPeriodicReport(currentState);
           currentState.lastPeriodicReportTime = now;
       }
       
       await Promise.all([
           checkNewsWithRotatingAssets(currentState),     // ğŸ”¥ ë³€ê²½: ìì‚°ë³„ ìˆœí™˜ ë‰´ìŠ¤ ê²€ìƒ‰
           checkAllEnabledAssets(currentState)            // ğŸš€ í™œì„±í™”ëœ ëª¨ë“  ìì‚° ìë™ ëª¨ë‹ˆí„°ë§
           // ğŸ¢ ë‹¤ë‚  ê¸°ìˆ ë¶„ì„ì€ ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬ì—ì„œ ì‹¤í–‰ë¨ (5ë¶„ ê°„ê²©)
       ]);
       
       writeState(currentState);
       console.log(`\n===== [${new Date().toLocaleString()}] âœ… ì™„ì „ ìë™í™” ëª¨ë‹ˆí„°ë§ ì¢…ë£Œ =====`);
   } catch (error) {
       console.error("âŒ runAllChecks í•¨ìˆ˜ì—ì„œ ì˜ˆì™¸ ë°œìƒ:", error);
       console.error("ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:", error.stack);
   } finally {
       isRunning = false;  // ì‹¤í–‰ ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ
   }
}

// --- 5. ìì‚° ê´€ë¦¬ ëª…ë ¹ì–´ ì²˜ë¦¬ ---
function handleCommand(command) {
   const args = command.toLowerCase().split(' ');
   const action = args[0];
   
   switch (action) {
       case 'status':
       case 'ìƒíƒœ':
           showAssetStatus();
           break;
           
       case 'enable':
       case 'í™œì„±í™”':
           if (args[1]) {
               const assetName = args.slice(1).join(' ');
               enableAsset(assetName);
           } else {
               console.log('ì‚¬ìš©ë²•: enable [ìì‚°ëª…] ë˜ëŠ” í™œì„±í™” [ìì‚°ëª…]');
               console.log(`ì˜ˆì‹œ: enable ì¹´ì´ì•„`);
           }
           break;
           
       case 'disable':
       case 'ë¹„í™œì„±í™”':
           if (args[1]) {
               const assetName = args.slice(1).join(' ');
               disableAsset(assetName);
           } else {
               console.log('ì‚¬ìš©ë²•: disable [ìì‚°ëª…] ë˜ëŠ” ë¹„í™œì„±í™” [ìì‚°ëª…]');
               console.log(`ì˜ˆì‹œ: disable ì¹´ì¹´ì˜¤í˜ì´`);
           }
           break;
           
       case 'toggle':
       case 'í† ê¸€':
           if (args[1]) {
               const assetName = args.slice(1).join(' ');
               toggleAsset(assetName);
           } else {
               console.log('ì‚¬ìš©ë²•: toggle [ìì‚°ëª…] ë˜ëŠ” í† ê¸€ [ìì‚°ëª…]');
               console.log(`ì˜ˆì‹œ: toggle ë‹¤ë‚ `);
           }
           break;

       // ğŸ”¥ ë‰´ìŠ¤ ê²€ìƒ‰ ê´€ë ¨ ëª…ë ¹ì–´ ì¶”ê°€
       case 'news-enable':
       case 'ë‰´ìŠ¤í™œì„±í™”':
           if (args[1]) {
               const assetName = args.slice(1).join(' ');
               enableNews(assetName);
           } else {
               console.log('ì‚¬ìš©ë²•: news-enable [ìì‚°ëª…] ë˜ëŠ” ë‰´ìŠ¤í™œì„±í™” [ìì‚°ëª…]');
               console.log(`ì˜ˆì‹œ: news-enable í˜ì´ì½”ì¸`);
           }
           break;
           
       case 'news-disable':
       case 'ë‰´ìŠ¤ë¹„í™œì„±í™”':
           if (args[1]) {
               const assetName = args.slice(1).join(' ');
               disableNews(assetName);
           } else {
               console.log('ì‚¬ìš©ë²•: news-disable [ìì‚°ëª…] ë˜ëŠ” ë‰´ìŠ¤ë¹„í™œì„±í™” [ìì‚°ëª…]');
               console.log(`ì˜ˆì‹œ: news-disable ì´ë”ë¦¬ì›€`);
           }
           break;
           
       case 'news-toggle':
       case 'ë‰´ìŠ¤í† ê¸€':
           if (args[1]) {
               const assetName = args.slice(1).join(' ');
               toggleNews(assetName);
           } else {
               console.log('ì‚¬ìš©ë²•: news-toggle [ìì‚°ëª…] ë˜ëŠ” ë‰´ìŠ¤í† ê¸€ [ìì‚°ëª…]');
               console.log(`ì˜ˆì‹œ: news-toggle ë¹„íŠ¸ì½”ì¸`);
           }
           break;
           
       case 'add':
       case 'ì¶”ê°€':
           console.log('\nğŸ†• ìƒˆ ìì‚° ì¶”ê°€ ë°©ë²•:');
           console.log('1. ì½”ë“œì—ì„œ ASSETS_TO_WATCH ë°°ì—´ì— ë‹¤ìŒ í˜•íƒœë¡œ ì¶”ê°€:');
           console.log(`{
   name: 'ìƒˆìì‚°ëª…',
   query: 'ìƒˆìì‚°ëª… ì‹œì„¸' ë˜ëŠ” 'ìƒˆìì‚°ëª… ì£¼ê°€',
   type: 'crypto' ë˜ëŠ” 'stock',
   spikeThreshold: 2.0,     // ê¸‰ë“±ë½ %
   trendThreshold: 1.5,     // ì¶”ì„¸ì´íƒˆ %  
   enabled: true,           // ê°€ê²© ëª¨ë‹ˆí„°ë§ í™œì„±í™”
   newsEnabled: true        // ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”
}`);
           console.log('2. ì¬ì‹œì‘í•˜ë©´ ìë™ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ ì‹œì‘!');
           break;
           
       case 'help':
       case 'ë„ì›€ë§':
           console.log('\nğŸ“– ì™„ì „ ìë™í™” ì‹œìŠ¤í…œ ëª…ë ¹ì–´:');
           console.log('=== ê°€ê²© ëª¨ë‹ˆí„°ë§ ===');
           console.log('- status ë˜ëŠ” ìƒíƒœ: ëª¨ë“  ìì‚° ìƒíƒœ ë³´ê¸°');
           console.log('- enable [ìì‚°ëª…]: ê°€ê²© ëª¨ë‹ˆí„°ë§ í™œì„±í™”');
           console.log('- disable [ìì‚°ëª…]: ê°€ê²© ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”');
           console.log('- toggle [ìì‚°ëª…]: ê°€ê²© ëª¨ë‹ˆí„°ë§ ìƒíƒœ ì „í™˜');
           console.log('');
           console.log('=== ë‰´ìŠ¤ ê²€ìƒ‰ ===');
           console.log('- news-enable [ìì‚°ëª…]: ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”');
           console.log('- news-disable [ìì‚°ëª…]: ë‰´ìŠ¤ ê²€ìƒ‰ ë¹„í™œì„±í™”');
           console.log('- news-toggle [ìì‚°ëª…]: ë‰´ìŠ¤ ê²€ìƒ‰ ìƒíƒœ ì „í™˜');
           console.log('');
           console.log('=== ê¸°íƒ€ ===');
           console.log('- add ë˜ëŠ” ì¶”ê°€: ìƒˆ ìì‚° ì¶”ê°€ ë°©ë²• ì•ˆë‚´');
           console.log('- help ë˜ëŠ” ë„ì›€ë§: ì´ ë„ì›€ë§ ë³´ê¸°');
           console.log('\nğŸš€ ìë™í™” ê¸°ëŠ¥:');
           console.log('- ë‰´ìŠ¤ ìì‚°ë³„ ìˆœí™˜ ê²€ìƒ‰ (newsEnabled=trueì¸ ìì‚°ë§Œ)');
           console.log('- ìì‚°ë³„ ë§ì¶¤ ê°€ê²© íŒŒì‹± (enabled=trueì¸ ìì‚°ë§Œ)');
           console.log('- ìë™ ìƒíƒœ ì´ˆê¸°í™” (ìƒˆ ìì‚° ì¶”ê°€ ì‹œ)');
           console.log('- ìŠ¤ë§ˆíŠ¸ ì •ê¸° ë¦¬í¬íŠ¸ (í˜ì´ì½”ì¸ ê¸‰ë“±ë½ ê¸°ì¤€ ë³€ë™ ì‹œë§Œ ë°œì†¡)');
           console.log('- ì¶”ì„¸ì´íƒˆ ê°€ê²© ê¸°ì¤€ ì¬ì•Œë¦¼ ì‹œìŠ¤í…œ (ìš¸ë¦° ê°€ê²© ê¸°ì¤€ìœ¼ë¡œ ì¬ì„¤ì •)');
           console.log('- ğŸ¨ Flex Message ì§€ì› (ìƒìŠ¹ ë¹¨ê°•, í•˜ë½ íŒŒë‘, ë‰´ìŠ¤ ë³´ë¼ìƒ‰)');
           console.log('');
           console.log('=== ğŸ• NXT/KRX ê±°ë˜ì†Œ ì „í™˜ ===');
           console.log('- nxt-auto ë˜ëŠ” auto: ì‹œê°„ëŒ€ë³„ ìë™ ì „í™˜');
           console.log('- nxt-manual ë˜ëŠ” manual: ìˆ˜ë™ ëª¨ë“œ (ê¸°ë³¸ KRX)');
           console.log('- force-nxt ë˜ëŠ” nxt: NXT ê°•ì œ ì‚¬ìš©');
           console.log('- force-krx ë˜ëŠ” krx: KRX ê°•ì œ ì‚¬ìš©');
           console.log('- trading-status: í˜„ì¬ ê±°ë˜ì†Œ ì„¤ì • ìƒíƒœ í™•ì¸');
           break;
           
       // ğŸ• NXT/KRX ê±°ë˜ì†Œ ì „í™˜ ê´€ë ¨ ëª…ë ¹ì–´ ì¶”ê°€
       case 'nxt-auto':
       case 'auto':
           TRADING_SCHEDULE.autoMode = true;
           console.log('âœ… NXT/KRX ìë™ ì „í™˜ ëª¨ë“œ í™œì„±í™” (ì‹œê°„ëŒ€ë³„ ìë™ ì „í™˜)');
           break;
           
       case 'nxt-manual':
       case 'manual':
           TRADING_SCHEDULE.autoMode = false;
           TRADING_SCHEDULE.forceMode = 'auto';
           console.log('ğŸ”§ NXT/KRX ìˆ˜ë™ ëª¨ë“œ í™œì„±í™” (ê¸°ë³¸ê°’: KRX)');
           break;
           
       case 'force-nxt':
       case 'nxt':
           TRADING_SCHEDULE.autoMode = false;
           TRADING_SCHEDULE.forceMode = 'nxt';
           console.log('ğŸŒ™ NXT ê±°ë˜ì†Œ ê°•ì œ ì‚¬ìš© ëª¨ë“œ');
           break;
           
       case 'force-krx':
       case 'krx':
           TRADING_SCHEDULE.autoMode = false;
           TRADING_SCHEDULE.forceMode = 'krx';
           console.log('ğŸ›ï¸ KRX ê±°ë˜ì†Œ ê°•ì œ ì‚¬ìš© ëª¨ë“œ');
           break;
           
       case 'trading-status':
       case 'ê±°ë˜ì†Œìƒíƒœ':
           console.log('\nğŸ• í˜„ì¬ ê±°ë˜ì†Œ ì„¤ì •:');
           console.log(`ìë™ ëª¨ë“œ: ${TRADING_SCHEDULE.autoMode ? 'âœ… í™œì„±í™”' : 'âŒ ë¹„í™œì„±í™”'}`);
           console.log(`ê°•ì œ ëª¨ë“œ: ${TRADING_SCHEDULE.forceMode}`);
           console.log(`ì •ê·œì¥ ì‹œê°„: ${Math.floor(TRADING_SCHEDULE.regularHours.start/100)}:${(TRADING_SCHEDULE.regularHours.start%100).toString().padStart(2,'0')} ~ ${Math.floor(TRADING_SCHEDULE.regularHours.end/100)}:${(TRADING_SCHEDULE.regularHours.end%100).toString().padStart(2,'0')}`);
           console.log(`NXT ì‹œê°„: ${Math.floor(TRADING_SCHEDULE.nxtHours.start/100)}:${(TRADING_SCHEDULE.nxtHours.start%100).toString().padStart(2,'0')} ~ ${Math.floor(TRADING_SCHEDULE.nxtHours.end/100)}:${(TRADING_SCHEDULE.nxtHours.end%100).toString().padStart(2,'0')}`);
           
           // í˜„ì¬ ì‹œê°„ëŒ€ í‘œì‹œ
           const now = new Date();
           const kstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Seoul"}));
           const hour = kstNow.getHours();
           const minute = kstNow.getMinutes();
           const currentTime = hour * 100 + minute;
           
           let currentSession = '';
           if (currentTime >= TRADING_SCHEDULE.regularHours.start && currentTime <= TRADING_SCHEDULE.regularHours.end) {
               currentSession = 'ğŸ“ˆ ì •ê·œì¥ ì‹œê°„ (KRX)';
           } else if (currentTime >= TRADING_SCHEDULE.nxtHours.start && currentTime <= TRADING_SCHEDULE.nxtHours.end) {
               currentSession = 'ğŸŒ™ NXT ì‹œê°„';
           } else {
               currentSession = 'ğŸ˜´ ê±°ë˜ ì‹œê°„ ì™¸';
           }
           
           console.log(`í˜„ì¬ ì‹œê°„: ${hour}:${minute.toString().padStart(2, '0')} - ${currentSession}`);
           break;
           
       default:
           console.log('ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. "help" ë˜ëŠ” "ë„ì›€ë§"ì„ ì…ë ¥í•˜ì„¸ìš”.');
   }
}

// --- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘ ---
console.log(`ğŸš€ ì™„ì „ ìë™í™” ë„¤ì´ë²„ì›ìŠ¤ ì•Œë¦¬ë¯¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!`);
console.log(`âš¡ ì‹¤í–‰ ê°„ê²©: 1ë¶„ë§ˆë‹¤`);
console.log(`ğŸ¯ ì™„ì „ ìë™í™” ê¸°ëŠ¥:`);
console.log(`   - ìì‚° ì¶”ê°€ ì‹œ ìë™ ê²€ìƒ‰ ë° ì•Œë¦¼`);
console.log(`   - ë‰´ìŠ¤ ìì‚°ë³„ ìˆœí™˜ ê²€ìƒ‰ (1ë¶„ì— í•˜ë‚˜ì”©)`);
console.log(`   - ìì‚°ë³„ ë§ì¶¤ ê°€ê²© íŒŒì‹±`);
console.log(`   - ìŠ¤ë§ˆíŠ¸ ì •ê¸° ë¦¬í¬íŠ¸ (í˜ì´ì½”ì¸ ê¸‰ë“±ë½ ê¸°ì¤€)`);
console.log(`   - ì¶”ì„¸ì´íƒˆ ê°€ê²© ê¸°ì¤€ ì¬ì•Œë¦¼ ì‹œìŠ¤í…œ`);
console.log(`   - ğŸ¨ Flex Message ì§€ì› (ìƒìŠ¹ ë¹¨ê°•, í•˜ë½ íŒŒë‘, ë‰´ìŠ¤ ë³´ë¼ìƒ‰)`);

// ìì‚° ìƒíƒœ í‘œì‹œ
showAssetStatus();

console.log(`ğŸ“° ë‰´ìŠ¤ ê²€ìƒ‰: ìì‚°ë³„ ìˆœí™˜ ê²€ìƒ‰ (1ë¶„ì— í•˜ë‚˜ì”©)`);
console.log(`ğŸ“Š ë‰´ìŠ¤ ê²€ìƒ‰ ë°©ì‹: ë„¤ì´ë²„ ê°œë³„ ê²€ìƒ‰ (ë‹¤ì¤‘ ì„ íƒì ì§€ì›)`);
console.log(`ğŸ“‹ ë‰´ìŠ¤ íˆìŠ¤í† ë¦¬: ìµœëŒ€ ${MAX_NEWS_HISTORY}ê°œ ì €ì¥`);
console.log(`â° ë‰´ìŠ¤ í•„í„°ë§: ìµœê·¼ ${MAX_NEWS_AGE_HOURS}ì‹œê°„ ì´ë‚´ë§Œ í—ˆìš©`);
console.log(`ğŸ“Š ê²€ìƒ‰ ë²”ìœ„: ìì‚°ë³„ ìµœì‹  20ê°œ í™•ì¸`);
console.log(`ğŸ“¤ ìµœëŒ€ ì•Œë¦¼ ìˆ˜: ìì‚°ë³„ 2ê°œê¹Œì§€`);
console.log(`â° ì •ê¸° ë¦¬í¬íŠ¸: ${PERIODIC_REPORT_INTERVAL}ë¶„ë§ˆë‹¤ (í˜ì´ì½”ì¸ ê¸‰ë“±ë½ ê¸°ì¤€ ë³€ë™ ì‹œë§Œ)`);
console.log(`ğŸ“Š ì´ë™í‰ê· : ${MA_PERIOD}ë¶„ ê¸°ì¤€`);
console.log(`ğŸ”„ ì¶”ì„¸ì´íƒˆ ì¬ì•Œë¦¼: ê°€ê²© ê¸°ì¤€ ì¬ì„¤ì • ë°©ì‹`);

console.log(`\nğŸ’¡ ìƒˆ ìì‚° ì¶”ê°€ ë°©ë²•:`);
console.log(`1. ASSETS_TO_WATCH ë°°ì—´ì— ì¶”ê°€`);
console.log(`2. enabled: trueë¡œ ì„¤ì •`);
console.log(`3. ì¬ì‹œì‘í•˜ë©´ ìë™ ëª¨ë‹ˆí„°ë§ ì‹œì‘! ğŸ‰`);

console.log(`\nğŸ® ê´€ë¦¬ ëª…ë ¹ì–´:`);
console.log(`- "status": ì „ì²´ ìì‚° ìƒíƒœ í™•ì¸`);
console.log(`- "enable ìì‚°ëª…": ê°€ê²© ëª¨ë‹ˆí„°ë§ ì‹œì‘`);
console.log(`- "news-enable ìì‚°ëª…": ë‰´ìŠ¤ ê²€ìƒ‰ ì‹œì‘`);
console.log(`- "disable ìì‚°ëª…": ê°€ê²© ëª¨ë‹ˆí„°ë§ ì¤‘ì§€`);
console.log(`- "news-disable ìì‚°ëª…": ë‰´ìŠ¤ ê²€ìƒ‰ ì¤‘ì§€`);
console.log(`- "help": ì „ì²´ ë„ì›€ë§`);

console.log(`\nğŸ• ê±°ë˜ì†Œ ì „í™˜ ì„¤ì •:`);
console.log(`- ìë™ ëª¨ë“œ: ${TRADING_SCHEDULE.autoMode ? 'âœ… í™œì„±í™”' : 'âŒ ë¹„í™œì„±í™”'}`);
console.log(`- ê°•ì œ ëª¨ë“œ: ${TRADING_SCHEDULE.forceMode}`);
console.log(`- "trading-status" ëª…ë ¹ì–´ë¡œ ìƒì„¸ í™•ì¸ ê°€ëŠ¥`);

console.log(`\nğŸ¨ Flex Message ìƒ‰ìƒ êµ¬ë¶„:`);
console.log(`- ğŸ”´ ê¸‰ë“± ì•Œë¦¼: ë¹¨ê°„ìƒ‰ í—¤ë”`);
console.log(`- ğŸ”µ ê¸‰ë½ ì•Œë¦¼: íŒŒë€ìƒ‰ í—¤ë”`);
console.log(`- ğŸŸ£ ë‰´ìŠ¤ ì•Œë¦¼: ë³´ë¼ìƒ‰ í—¤ë”`);
console.log(`- ğŸ”µ ì •ê¸° ë¦¬í¬íŠ¸: íŒŒë€ìƒ‰ í—¤ë”`);

// ëª…ë ¹ì–´ ì…ë ¥ ì²˜ë¦¬ (ì„ íƒì‚¬í•­ - ê°œë°œ ì‹œì—ë§Œ ì‚¬ìš©)
if (process.argv.includes('--interactive')) {
   const readline = require('readline');
   const rl = readline.createInterface({
       input: process.stdin,
       output: process.stdout,
       prompt: 'ìë™í™”ì‹œìŠ¤í…œ> '
   });
   
   console.log('\nğŸ–¥ï¸ ì¸í„°ë™í‹°ë¸Œ ëª¨ë“œ í™œì„±í™”ë¨. "help"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
   rl.prompt();
   
   rl.on('line', (input) => {
       const command = input.trim();
       if (command === 'exit' || command === 'ì¢…ë£Œ') {
           console.log('ğŸš€ ì™„ì „ ìë™í™” ì‹œìŠ¤í…œì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
           rl.close();
           process.exit(0);
       } else if (command) {
           handleCommand(command);
       }
       rl.prompt();
   });
}

// === ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™” ===
process.on('uncaughtException', (error) => {
    console.error('ğŸš¨ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ ë°œìƒ:', error);
    console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
    
    // ë¡œê±°ë¥¼ í†µí•œ í¬ë˜ì‹œ ë¦¬í¬íŠ¸
    logHelper.crashReport(error, {
        type: 'uncaughtException',
        processId: process.pid,
        argv: process.argv
    });
    
    // ìƒíƒœ ì €ì¥ ì‹œë„
    try {
        if (typeof writeState === 'function' && currentState) {
            writeState(currentState);
            console.log('ğŸ’¾ ìµœì¢… ìƒíƒœ ì €ì¥ ì™„ë£Œ');
            logger.info('ìµœì¢… ìƒíƒœ ì €ì¥ ì™„ë£Œ', { 
                context: 'uncaughtException',
                stateKeys: Object.keys(currentState)
            });
        }
    } catch (saveError) {
        console.error('âŒ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', saveError.message);
        logger.error('ìƒíƒœ ì €ì¥ ì‹¤íŒ¨', { error: saveError.message });
    }
    
    // 5ì´ˆ í›„ ì¬ì‹œì‘ (PM2ê°€ ì²˜ë¦¬í•˜ë„ë¡)
    setTimeout(() => {
        console.log('ğŸ”„ 5ì´ˆ í›„ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ... PM2ê°€ ìë™ ì¬ì‹œì‘í•©ë‹ˆë‹¤.');
        logHelper.systemStop('uncaughtException');
        process.exit(1);
    }, 5000);
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('ğŸš¨ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', reason);
    console.error('Promise:', promise);
    
    // ë¡œê±°ë¥¼ í†µí•œ ì—ëŸ¬ ê¸°ë¡
    logger.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€', {
        reason: reason?.message || reason,
        stack: reason?.stack,
        type: 'unhandledRejection',
        processId: process.pid,
        timestamp: new Date().toISOString()
    });
});

process.on('SIGINT', () => {
    console.log('\nğŸ›‘ SIGINT ì‹ í˜¸ ìˆ˜ì‹ . ì•ˆì „í•˜ê²Œ ì¢…ë£Œ ì¤‘...');
    
    try {
        // í˜„ì¬ ìƒíƒœ ì €ì¥
        if (typeof writeState === 'function' && currentState) {
            writeState(currentState);
            console.log('ğŸ’¾ ìµœì¢… ìƒíƒœ ì €ì¥ ì™„ë£Œ');
        }
    } catch (error) {
        console.error('âŒ ì¢…ë£Œ ì‹œ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error.message);
    }
    
    process.exit(0);
});

process.on('SIGTERM', () => {
    console.log('\nğŸ›‘ SIGTERM ì‹ í˜¸ ìˆ˜ì‹ . ì•ˆì „í•˜ê²Œ ì¢…ë£Œ ì¤‘...');
    
    try {
        if (typeof writeState === 'function' && currentState) {
            writeState(currentState);
            console.log('ğŸ’¾ ìµœì¢… ìƒíƒœ ì €ì¥ ì™„ë£Œ');
        }
    } catch (error) {
        console.error('âŒ ì¢…ë£Œ ì‹œ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', error.message);
    }
    
    process.exit(0);
});

// ğŸ”¥ ë‰´ìŠ¤ ìë™ ê²€ìƒ‰ íƒ€ì´ë¨¸ - ì¤‘ë³µ ë°œì†¡ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬
// (Promise.allì—ì„œ checkNewsWithRotatingAssets í•¨ìˆ˜ê°€ ì´ë¯¸ ì‹¤í–‰ë˜ë¯€ë¡œ ì¤‘ë³µ ì œê±°)
/*
setInterval(async () => {
    try {
        const newsEnabledAssets = getNewsEnabledAssets();
        if (newsEnabledAssets.length === 0) {
            return; // ë‰´ìŠ¤ ê²€ìƒ‰ì´ í™œì„±í™”ëœ ìì‚°ì´ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
        }

        console.log(`\nğŸ“° [ë‰´ìŠ¤] ìë™ ë‰´ìŠ¤ ê²€ìƒ‰ ì‹œì‘... (${newsEnabledAssets.length}ê°œ ìì‚°)`);
        
        const currentState = readState();
        await checkNewsWithRotatingAssets(currentState);
    } catch (error) {
        console.error('âŒ ë‰´ìŠ¤ ìë™ ê²€ìƒ‰ ì˜¤ë¥˜:', error.message);
    }
}, 60 * 1000); // 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
*/

// ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
setInterval(() => {
    const memUsage = process.memoryUsage();
    const memoryMB = Math.round(memUsage.heapUsed / 1024 / 1024);
    
    if (memoryMB > 400) { // 400MB ì´ˆê³¼ ì‹œ ê²½ê³ 
        console.warn(`âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë†’ìŒ: ${memoryMB}MB`);
        logHelper.memoryWarning(memoryMB, 400);
        
        // 500MB ì´ˆê³¼ ì‹œ ê°•ì œ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹œë„
        if (memoryMB > 500 && global.gc) {
            console.log('ğŸ—‘ï¸ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰...');
            logger.warn('ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰', { 
                memoryBeforeGC: memoryMB,
                threshold: 500 
            });
            global.gc();
            
            // GC í›„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
            const memAfterGC = Math.round(process.memoryUsage().heapUsed / 1024 / 1024);
            logger.info('ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì™„ë£Œ', {
                memoryBefore: memoryMB,
                memoryAfter: memAfterGC,
                freed: memoryMB - memAfterGC
            });
        }
    }
}, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬

// í¬ë¡  ìŠ¤ì¼€ì¤„ë§ (1ë¶„ë§ˆë‹¤) - ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
cron.schedule('* * * * *', async () => {
    try {
        await runAllChecks();
    } catch (error) {
        console.error('ğŸš¨ í¬ë¡  ì‘ì—… ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
        console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
        
        // ì—ëŸ¬ ë¡œê·¸ ê¸°ë¡
        try {
            const errorLog = {
                timestamp: new Date().toISOString(),
                error: error.message,
                stack: error.stack,
                type: 'cronError'
            };
            
            const fs = require('fs');
            const errorLogFile = './logs/error_crash.log';
            fs.appendFileSync(errorLogFile, JSON.stringify(errorLog) + '\n');
        } catch (logError) {
            console.error('âŒ í¬ë¡  ì—ëŸ¬ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', logError.message);
        }
    }
});

// ì´ˆê¸° ì‹¤í–‰ - ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
(async () => {
    try {
        console.log('ğŸš€ ì´ˆê¸° ì‹¤í–‰ ì‹œì‘...');
        logHelper.systemStart();
        
        const startTime = Date.now();
        await runAllChecks();
        const duration = Date.now() - startTime;
        
        console.log('âœ… ì´ˆê¸° ì‹¤í–‰ ì™„ë£Œ');
        logHelper.performance('ì´ˆê¸° ì‹¤í–‰', duration);
        
        // ğŸª™ í˜ì´ì½”ì¸ ê¸°ìˆ ë¶„ì„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (15ë¶„ ê°„ê²©)
        console.log('ğŸª™ í˜ì´ì½”ì¸ ê¸°ìˆ ë¶„ì„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...');
        integratePaycoinMonitoring(NAVER_WORKS_HOOK_URL, 15);
        
        // ğŸ¢ ë‹¤ë‚  ì£¼ì‹ ê¸°ìˆ ë¶„ì„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (15ë¶„ ê°„ê²©) - DISABLED
        // console.log('ğŸ¢ ë‹¤ë‚  ì£¼ì‹ ê¸°ìˆ ë¶„ì„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...');
        // startDanalTechnicalMonitoring(NAVER_WORKS_HOOK_URL, 15);
        
    } catch (error) {
        console.error('ğŸš¨ ì´ˆê¸° ì‹¤í–‰ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
        console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
        logHelper.crashReport(error, { context: 'ì´ˆê¸° ì‹¤í–‰' });
    }
})();